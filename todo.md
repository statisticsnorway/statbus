- [x] **Fix worker concurrency issue**: Make the worker cleanup logic more robust to prevent race conditions from lingering connections after a deployment. This was causing `derive_statistical_unit` to fail intermittently. (2025-08-23)
- [ ] **Implement `update` import mode**: Create a new, non-destructive `update` mode for imports. This mode will perform an "upsert" operation, creating new temporal segments for changed records and inserting new ones, without deleting any existing data that is not present in the import file. This will be the new default and safer import mode.
- [ ] **Implement partial `statistical_unit` refresh**: Develop a robust mechanism for partial, targeted refreshes of the `timeline_*` and `statistical_unit` tables. This will require a dynamic, hierarchical lookup of all affected units (e.g., finding an establishment's parent LU and enterprise) to ensure data consistency.
- [ ] **Add triggers for automatic refresh**: Implement database triggers on the core temporal tables (`legal_unit`, `establishment`, `activity`, etc.). These triggers will automatically queue a partial refresh task in the worker system whenever a relevant record is changed, ensuring the `statistical_unit` view is kept up-to-date.
- [ ] **Refactor `process_legal_unit`**: Remove the vestigial `tax_ident` column from the temporary table in `import.process_legal_unit` to improve clarity.
