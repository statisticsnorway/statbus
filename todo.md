- [x] **Fix timeline generation ("fan-out" problem)**: All crashing bugs and performance bottlenecks related to timeline generation have been resolved. The fixes have been integrated into the migration files and obsolete diagnostic scripts have been removed.
- [x] **Final Verification**:
    - [x] Restart the worker and confirm it can complete the `derive_statistical_unit` task without crashing.
- [x] **Improve worker resilience**: The worker is now resilient to timeline generation hangs through stale connection cleanup on startup and an automatic recovery/retry mechanism for failed tasks.
- [x] **Fix import analysis bug**: The `import.analyse_external_idents` procedure fails when run multiple times in a session due to improper temp table cleanup, causing widespread test failures. This has been fixed by adding a cleanup block at the start of the procedure.
- [x] **Fix import linking bug**: The `import.analyse_link_establishment_to_legal_unit` procedure has the same temp table cleanup issue, causing test failures. This is now fixed.
- [x] **Fix FK violation in LU processing**: The `import.process_legal_unit` procedure violated a foreign key constraint when replacing a `legal_unit` because it didn't handle child `activity` records. This was fixed by adding a step to delete dependent activities before the parent record is replaced.
- [x] **Fix data integrity and projection bugs**: All code-level bugs are now resolved. The `statistical_unit_def` view correctly presents the atomic truth from its sources, and import procedures handle dependencies correctly. The remaining task is to update the test expectation files to match the new, correct data representation.
- [x] **Fix test regressions with surgical replace**: The `import.process_legal_unit` procedure now correctly handles child records during a `replace` operation by processing changes sequentially. This preserves historical data and has resolved all major test regressions.
- [ ] **Implement `update` import mode**: Create a new, non-destructive `update` mode for imports. This mode will perform an "upsert" operation, creating new temporal segments for changed records and inserting new ones, without deleting any existing data that is not present in the import file. This will be the new default and safer import mode.
- [ ] **Implement partial `statistical_unit` refresh**: Develop a robust mechanism for partial, targeted refreshes of the `timeline_*` and `statistical_unit` tables. This will require a dynamic, hierarchical lookup of all affected units (e.g., finding an establishment's parent LU and enterprise) to ensure data consistency.
- [ ] **Add triggers for automatic refresh**: Implement database triggers on the core temporal tables (`legal_unit`, `establishment`, `activity`, etc.). These triggers will automatically queue a partial refresh task in the worker system whenever a relevant record is changed, ensuring the `statistical_unit` view is kept up-to-date.
- [ ] **Refactor `process_legal_unit`**: Remove the vestigial `tax_ident` column from the temporary table in `import.process_legal_unit` to improve clarity.
