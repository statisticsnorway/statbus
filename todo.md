- [x] **Fix timeline generation ("fan-out" problem)**: All crashing bugs and performance bottlenecks related to timeline generation have been resolved. The fixes have been integrated into the migration files and obsolete diagnostic scripts have been removed.
- [x] **Final Verification**:
    - [x] Restart the worker and confirm it can complete the `derive_statistical_unit` task without crashing.
- [x] **Improve worker resilience**: The worker is now resilient to timeline generation hangs through stale connection cleanup on startup and an automatic recovery/retry mechanism for failed tasks.
- [x] **Fix import analysis bug**: The `import.analyse_external_idents` procedure fails when run multiple times in a session due to improper temp table cleanup, causing widespread test failures. This has been fixed by adding a cleanup block at the start of the procedure.
- [x] **Fix import linking bug**: The `import.analyse_link_establishment_to_legal_unit` procedure has the same temp table cleanup issue, causing test failures. This is now fixed.
- [x] **Fix FK violation in LU processing**: The `import.process_legal_unit` procedure violated a foreign key constraint when replacing a `legal_unit` because it didn't handle child `activity` records. This was fixed by adding a step to delete dependent activities before the parent record is replaced.
- [x] **Fix data integrity and projection bugs**: All code-level bugs are now resolved. The `statistical_unit_def` view correctly presents the atomic truth from its sources, and import procedures handle dependencies correctly. The remaining task is to update the test expectation files to match the new, correct data representation.
- [ ] **Fix test regressions caused by "scorched earth" replace**: The deletion logic in `import.process_legal_unit` has been refined. It now only deletes child records (`activity`, `location`, etc.) if the current import job's data table actually contains columns/data for those child entities. This prevents accidental data loss during partial updates and resolves the test suite regressions.
