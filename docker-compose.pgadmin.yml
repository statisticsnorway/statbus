# pgAdmin 4 - PostgreSQL administration tool
# This service is optional and controlled by the "pgadmin" profile
#
# In standalone mode, pgAdmin is enabled by default and accessible at /pgadmin
# Authentication is gated by STATBUS JWT - users must be logged into STATBUS first
# Once in pgAdmin, users connect to PostgreSQL with their STATBUS credentials
#
# To enable/disable, edit .env.config: ENABLE_PGADMIN=true/false
# Then run: ./devops/manage-statbus.sh generate-config
#
services:
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${COMPOSE_INSTANCE_NAME:?COMPOSE_INSTANCE_NAME must be set in the generated .env}-pgadmin
    environment:
      # pgAdmin master credentials - used only for pgAdmin's internal authentication
      # Since we gate access via STATBUS JWT, these are just for pgAdmin's internal use
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@statbus.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:?PGADMIN_DEFAULT_PASSWORD must be set in the generated .env}
      # Configure for running behind reverse proxy at /pgadmin path
      SCRIPT_NAME: /pgadmin
      # Listen on internal port (Caddy proxies to this)
      PGADMIN_LISTEN_PORT: 5050
      # Disable pgAdmin's own TLS - Caddy handles HTTPS
      PGADMIN_ENABLE_TLS: "False"
      # Proxy configuration - trust headers from Caddy
      PGADMIN_CONFIG_PROXY_X_FOR_COUNT: "1"
      PGADMIN_CONFIG_PROXY_X_PROTO_COUNT: "1"
      PGADMIN_CONFIG_PROXY_X_HOST_COUNT: "1"
      PGADMIN_CONFIG_PROXY_X_PORT_COUNT: "1"
      PGADMIN_CONFIG_PROXY_X_PREFIX_COUNT: "1"
      # Security settings
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "True"
      PGADMIN_CONFIG_SESSION_COOKIE_SAMESITE: "'Lax'"
      # Disable mail server (not needed)
      PGADMIN_DISABLE_POSTFIX: "True"
      # Pre-configure server connection (users still need to authenticate)
      PGADMIN_SERVER_JSON_FILE: /pgadmin4/servers.json
    volumes:
      # Persistent storage for pgAdmin configuration and user data
      - pgadmin_data:/var/lib/pgadmin
      # Pre-configured server definitions
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy

volumes:
  pgadmin_data:
