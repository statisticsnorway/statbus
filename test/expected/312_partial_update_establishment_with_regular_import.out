BEGIN;
\x auto
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create(p_display_name => 'Test Admin', p_email => 'test.admin@statbus.org', p_statbus_role => 'admin_user'::statbus_role, p_password => 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Regular', p_email => 'test.regular@statbus.org', p_statbus_role => 'regular_user'::statbus_role, p_password => 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Restricted', p_email => 'test.restricted@statbus.org', p_statbus_role => 'restricted_user'::statbus_role, p_password => 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

CREATE OR REPLACE PROCEDURE test.remove_pg_temp_for_tx_user_switch(p_keep_tables text[] DEFAULT '{}')
LANGUAGE plpgsql
AS $remove_pg_temp_for_tx_user_switch$
DECLARE
    rec record;
    v_found_count integer := 0;
BEGIN
    RAISE DEBUG 'Running test.remove_pg_temp_for_tx_user_switch(p_keep_tables => %)...', p_keep_tables;
    -- Remove temporary cache tables used by import, as we switch user inside the *same* transaction,
    -- and the new user can not modify tables owned by the previous import.
    -- This generic loop cleans up all tables and views in the pg_temp schema, except those specified to keep.
    FOR rec IN
        SELECT
            c.relname,
            c.relkind
        FROM pg_catalog.pg_class AS c
        LEFT JOIN pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace
        WHERE c.relkind IN ('r', 'p', 'v', 'm') AND n.oid = pg_my_temp_schema() -- r=table, p=partitioned, v=view, m=materialized
          AND c.relname <> ALL(p_keep_tables)
    LOOP
        v_found_count := v_found_count + 1;
        IF rec.relkind IN ('r', 'p', 'm') THEN
            RAISE DEBUG '  -> Dropping temp TABLE %', rec.relname;
            EXECUTE format('DROP TABLE IF EXISTS pg_temp.%I CASCADE', rec.relname);
        ELSIF rec.relkind = 'v' THEN
            RAISE DEBUG '  -> Dropping temp VIEW %', rec.relname;
            EXECUTE format('DROP VIEW IF EXISTS pg_temp.%I CASCADE', rec.relname);
        END IF;
    END LOOP;

    RAISE DEBUG '...finished test.remove_pg_temp_for_tx_user_switch(). Found and dropped % objects.', v_found_count;

    -- This procedure is part of the sql_saga extension and has its own cleanup logic.
    -- While the loop above handles tables/views, this call ensures any other temporary
    -- objects it creates are also cleaned up.
    CALL sql_saga.temporal_merge_drop_temp_tables();
END;
$remove_pg_temp_for_tx_user_switch$;
-- A Super User configures statbus.
CALL test.set_user_from_email('test.admin@statbus.org');
\i samples/demo/getting-started.sql
-- Set the activity category standard to ISIC v4 for the demo data.
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id,country_id)
SELECT (SELECT id FROM activity_category_standard WHERE code = 'isic_v4')
     , (SELECT id FROM public.country WHERE iso_2 = 'UN')
ON CONFLICT (only_one_setting)
DO UPDATE SET
    activity_category_standard_id = EXCLUDED.activity_category_standard_id,
    country_id = EXCLUDED.country_id;
\echo "User uploads the demo activity categories"
"User uploads the demo activity categories"
\copy public.activity_category_available_custom(path,name) FROM 'app/public/demo/activity_custom_isic_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "User uploads the demo regions"
"User uploads the demo regions"
\copy public.region_upload(path, name) FROM 'app/public/demo/regions_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "User uploads the demo sectors"
"User uploads the demo sectors"
\copy public.sector_custom_only(path,name,description) FROM 'app/public/demo/sectors_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "User uploads the demo legal forms"
"User uploads the demo legal forms"
\copy public.legal_form_custom_only(code,name) FROM 'app/public/demo/legal_forms_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
-- The demo data uses data sources that are part of the core database seed.
-- This file is included for structural consistency with other sample data sets.
-- Create Import Job for Legal Units (prerequisite)
INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
SELECT
    (SELECT id FROM public.import_definition WHERE slug = 'legal_unit_source_dates'),
    'import_312_lu_wsd',
    'Import LU Demo CSV w/ dates (312)',
    'Import job for 312',
    'Test data load (312)';
\copy public.import_312_lu_wsd_upload(tax_ident,stat_ident,name,valid_from,physical_address_part1,valid_to,postal_address_part1,postal_address_part2,physical_address_part2,physical_postcode,postal_postcode,physical_address_part3,physical_postplace,postal_address_part3,postal_postplace,phone_number,landline,mobile_number,fax_number,web_address,email_address,secondary_activity_category_code,physical_latitude,physical_longitude,physical_altitude,birth_date,physical_region_code,postal_country_iso_2,physical_country_iso_2,primary_activity_category_code,legal_form_code,sector_code,employees,turnover,data_source_code,status_code,unit_size_code) FROM 'app/public/demo/legal_units_with_source_dates_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
-- Create Import Job for Establishments (prerequisite)
INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
SELECT
    (SELECT id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates'),
    'import_312_est_wsd',
    'Import Formal EST Demo CSV w/ dates (312)',
    'Import job for 312',
    'Test data load (312)';
\copy public.import_312_est_wsd_upload(tax_ident,stat_ident,name,physical_region_code,valid_from,valid_to,postal_country_iso_2,physical_country_iso_2,primary_activity_category_code,secondary_activity_category_code,employees,turnover,legal_unit_tax_ident,data_source_code,physical_address_part1,physical_address_part2,physical_address_part3,postal_address_part1,postal_address_part2,postal_address_part3,phone_number,mobile_number,landline,fax_number,web_address,email_address,physical_latitude,physical_longitude,physical_altitude,birth_date,unit_size_code,status_code) FROM 'app/public/demo/formal_establishments_units_with_source_dates_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "Run worker processing for import jobs - Initial Load"
"Run worker processing for import jobs - Initial Load"
CALL worker.process_tasks(p_queue => 'import');
CALL worker.process_tasks(p_queue => 'analytics');
NOTICE:  Created btree index su_ei_tax_ident_idx for external_ident_type
NOTICE:  Created btree index su_ei_stat_ident_idx for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
\echo "Taking snapshot of statistics before partial update (for the historical period being changed)"
"Taking snapshot of statistics before partial update (for the historical period being changed)"
CREATE TEMP TABLE stats_before_update AS
SELECT unit_type
     -- ORDER BY ensures deterministic floating-point accumulation order
     , jsonb_stats_summary_merge_agg(stats_summary ORDER BY stats_summary::text) AS stats_summary
 FROM statistical_unit
 WHERE valid_from <= '2023-07-01'::date AND '2023-07-01'::date < valid_until
   AND unit_type = 'establishment'
 GROUP BY unit_type;
CREATE TEMP TABLE temp_source_for_update (tax_ident text, stat_ident text, turnover text, valid_from text, valid_to text);
\copy temp_source_for_update FROM 'app/public/demo/formal_establishments_turnover_update_with_source_dates.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "Checking raw stat_for_unit data BEFORE partial update"
"Checking raw stat_for_unit data BEFORE partial update"
\x off
WITH est_map AS (
    SELECT DISTINCT est.id as establishment_id, src.stat_ident
    FROM temp_source_for_update src
    JOIN public.external_ident ei ON ei.ident = src.stat_ident AND ei.type_id = (SELECT id FROM external_ident_type WHERE code = 'stat_ident')
    JOIN public.establishment est ON ei.establishment_id = est.id
    WHERE daterange(est.valid_from, est.valid_until) @> CURRENT_DATE
)
SELECT
    est_map.stat_ident,
    sfu.valid_from, sfu.valid_to,
    sd.code AS stat_code,
    sfu.value_int, sfu.value_float, sfu.value_string, sfu.value_bool
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN est_map ON sfu.establishment_id = est_map.establishment_id
WHERE daterange(sfu.valid_from, sfu.valid_until) && daterange('2023-01-01', '2024-01-01', '[)')
ORDER BY est_map.stat_ident::int, sd.code, sfu.valid_from;
 stat_ident | valid_from | valid_to | stat_code | value_int | value_float | value_string | value_bool 
------------+------------+----------+-----------+-----------+-------------+--------------+------------
 91000      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91000      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91001      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91001      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91002      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91002      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91003      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91003      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91004      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91004      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91005      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91005      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91006      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91006      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91007      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91007      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91008      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91008      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
 91009      | 2023-01-01 | infinity | employees |        10 |             |              | 
 91009      | 2023-01-01 | infinity | turnover  |           |        1000 |              | 
(20 rows)

\x auto
CALL test.remove_pg_temp_for_tx_user_switch(p_keep_tables => ARRAY['stats_before_update', 'temp_source_for_update', '_batch_accumulator']);
GRANT SELECT ON TABLE stats_before_update TO regular_user;
\echo "Switching to regular user for partial update"
"Switching to regular user for partial update"
CALL test.set_user_from_email('test.regular@statbus.org');
\echo "Create Import Job for Partial Establishment Update using a REGULAR import definition"
"Create Import Job for Partial Establishment Update using a REGULAR import definition"
INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
SELECT
    (SELECT id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates'),
    'import_312_est_partial_update',
    'Import EST Partial Update (312_partial_update_establishment_with_regular_import.sql)',
    'Import job for partial establishment update using a REGULAR definition.',
    'Test data load (312_partial_update_establishment_with_regular_import.sql)';
\echo "User uploads the establishments turnover update file to a regular import job (import_312_est_partial_update)"
"User uploads the establishments turnover update file to a regular import job (import_312_est_partial_update)"
\copy public.import_312_est_partial_update_upload(tax_ident,stat_ident,turnover,valid_from,valid_to) FROM 'app/public/demo/formal_establishments_turnover_update_with_source_dates.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "Run worker processing for import jobs - Partial Update"
"Run worker processing for import jobs - Partial Update"
CALL worker.process_tasks(p_queue => 'import');
\echo "Run worker processing for analytics tasks - Partial Update"
"Run worker processing for analytics tasks - Partial Update"
CALL worker.process_tasks(p_queue => 'analytics');
NOTICE:  Created btree index su_ei_tax_ident_idx for external_ident_type
NOTICE:  Created btree index su_ei_stat_ident_idx for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
\echo "Checking import data for partial update. Expecting all rows to be processed successfully."
"Checking import data for partial update. Expecting all rows to be processed successfully."
\x on
SELECT
    row_id,
    operation,
    state,
    jsonb_pretty(errors) AS errors,
    jsonb_pretty(merge_status) as merge_status
FROM public.import_312_est_partial_update_data
ORDER BY row_id;
-[ RECORD 1 ]+--------------------------------
row_id       | 1
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 2 ]+--------------------------------
row_id       | 2
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 3 ]+--------------------------------
row_id       | 3
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 4 ]+--------------------------------
row_id       | 4
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 5 ]+--------------------------------
row_id       | 5
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 6 ]+--------------------------------
row_id       | 6
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 7 ]+--------------------------------
row_id       | 7
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 8 ]+--------------------------------
row_id       | 8
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 9 ]+--------------------------------
row_id       | 9
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }
-[ RECORD 10 ]--------------------------------
row_id       | 10
operation    | update
state        | processed
errors       | {                              +
             | }
merge_status | {                              +
             |     "establishment": "APPLIED",+
             |     "stat_turnover": "APPLIED" +
             | }

\x auto
\echo "Checking last_edit_by_user_id on statistical_unit to confirm it changed after partial update"
"Checking last_edit_by_user_id on statistical_unit to confirm it changed after partial update"
\x off
WITH updated_unit AS (
    SELECT establishment_id AS unit_id
    FROM public.import_312_est_partial_update_data
    WHERE state = 'processed' AND establishment_id IS NOT NULL
    LIMIT 1
)
SELECT
    su.external_idents ->> 'stat_ident' AS stat_ident,
    su.valid_from,
    su.valid_to,
    u.email AS last_edit_by,
    su.stats
FROM public.statistical_unit su
JOIN public.user u ON su.last_edit_by_user_id = u.id
WHERE su.unit_id = (SELECT unit_id FROM updated_unit)
  AND su.unit_type = 'establishment'
ORDER BY su.valid_from;
 stat_ident | valid_from |  valid_to  |       last_edit_by       |                stats                
------------+------------+------------+--------------------------+-------------------------------------
 91000      | 2023-01-01 | 2023-05-31 | test.admin@statbus.org   | {"turnover": 1000, "employees": 10}
 91000      | 2023-06-01 | 2023-08-31 | test.regular@statbus.org | {"turnover": 3535, "employees": 10}
 91000      | 2023-09-01 | infinity   | test.admin@statbus.org   | {"turnover": 1000, "employees": 10}
(3 rows)

\x auto
\echo "Checking raw stat_for_unit data AFTER partial update to verify the merge and edit user"
"Checking raw stat_for_unit data AFTER partial update to verify the merge and edit user"
\x off
SELECT
    idt.stat_ident,
    sfu.valid_from, sfu.valid_to,
    sd.code AS stat_code,
    sfu.value_int, sfu.value_float, sfu.value_string, sfu.value_bool,
    u.email AS edit_by
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.user u ON sfu.edit_by_user_id = u.id
JOIN (
    SELECT DISTINCT establishment_id, stat_ident_raw AS stat_ident
    FROM public.import_312_est_partial_update_data
    WHERE state = 'processed' AND establishment_id IS NOT NULL
) idt ON sfu.establishment_id = idt.establishment_id
WHERE daterange(sfu.valid_from, sfu.valid_until) && daterange('2023-01-01', '2024-01-01', '[)')
ORDER BY idt.stat_ident::int, sd.code, sfu.valid_from;
 stat_ident | valid_from |  valid_to  | stat_code | value_int | value_float | value_string | value_bool |         edit_by          
------------+------------+------------+-----------+-----------+-------------+--------------+------------+--------------------------
 91000      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91000      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91000      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91000      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91001      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91001      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91001      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91001      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91002      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91002      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91002      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91002      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91003      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91003      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91003      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91003      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91004      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91004      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91004      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91004      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91005      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91005      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91005      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91005      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91006      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91006      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91006      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91006      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91007      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91007      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91007      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91007      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91008      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91008      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91008      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91008      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91009      | 2023-01-01 | infinity   | employees |        10 |             |              |            | test.admin@statbus.org
 91009      | 2023-01-01 | 2023-05-31 | turnover  |           |        1000 |              |            | test.admin@statbus.org
 91009      | 2023-06-01 | 2023-08-31 | turnover  |           |        3535 |              |            | test.regular@statbus.org
 91009      | 2023-09-01 | infinity   | turnover  |           |        1000 |              |            | test.admin@statbus.org
(40 rows)

\x auto
\echo "Checking resulting statistics after Partial Update. Should show turnover updated, and employees unchanged."
"Checking resulting statistics after Partial Update. Should show turnover updated, and employees unchanged."
\x off
WITH stats_after AS (
    -- ORDER BY ensures deterministic floating-point accumulation order
    SELECT unit_type, jsonb_stats_summary_merge_agg(stats_summary ORDER BY stats_summary::text) AS stats_summary
    FROM statistical_unit
    WHERE valid_from <= '2023-07-01'::date AND '2023-07-01'::date < valid_until AND unit_type = 'establishment'
    GROUP BY unit_type
)
SELECT
    'turnover' as statistic,
    sb.stats_summary->'turnover' = sa.stats_summary->'turnover' as are_identical,
    jsonb_pretty(sb.stats_summary->'turnover') AS before,
    jsonb_pretty(sa.stats_summary->'turnover') AS after
FROM stats_after sa JOIN stats_before_update sb ON sa.unit_type = sb.unit_type
UNION ALL
SELECT
    'employees' as statistic,
    sb.stats_summary->'employees' = sa.stats_summary->'employees' as are_identical,
    jsonb_pretty(sb.stats_summary->'employees') AS before,
    jsonb_pretty(sa.stats_summary->'employees') AS after
FROM stats_after sa JOIN stats_before_update sb ON sa.unit_type = sb.unit_type;
 statistic | are_identical |                  before                   |                   after                   
-----------+---------------+-------------------------------------------+-------------------------------------------
 turnover  | f             | {                                        +| {                                        +
           |               |     "max": 1000,                         +|     "max": 3535,                         +
           |               |     "min": 20,                           +|     "min": 20,                           +
           |               |     "sum": 21154,                        +|     "sum": 46504,                        +
           |               |     "mean": 881.42,                      +|     "mean": 1937.67,                     +
           |               |     "type": "number",                    +|     "type": "number",                    +
           |               |     "count": 24,                         +|     "count": 24,                         +
           |               |     "stddev": 320.85,                    +|     "stddev": 1412.16,                   +
           |               |     "variance": 102946.17,               +|     "variance": 1994184.75,              +
           |               |     "sum_sq_diff": 2367761.83,           +|     "sum_sq_diff": 45866249.33,          +
           |               |     "coefficient_of_variation_pct": 36.40+|     "coefficient_of_variation_pct": 72.88+
           |               | }                                         | }
 employees | f             | {                                        +| {                                        +
           |               |     "max": 10,                           +|     "max": 10,                           +
           |               |     "min": 0,                            +|     "min": 0,                            +
           |               |     "sum": 213,                          +|     "sum": 213,                          +
           |               |     "mean": 8.88,                        +|     "mean": 8.88,                        +
           |               |     "type": "number",                    +|     "type": "number",                    +
           |               |     "count": 24,                         +|     "count": 24,                         +
           |               |     "stddev": 3.05,                      +|     "stddev": 3.05,                      +
           |               |     "variance": 9.33,                    +|     "variance": 9.33,                    +
           |               |     "sum_sq_diff": 214.62,               +|     "sum_sq_diff": 214.63,               +
           |               |     "coefficient_of_variation_pct": 34.42+|     "coefficient_of_variation_pct": 34.42+
           |               | }                                         | }
(2 rows)

\x auto
ROLLBACK;
