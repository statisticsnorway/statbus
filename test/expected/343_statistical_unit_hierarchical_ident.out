BEGIN;
\i test/setup.sql
\echo -- test/setup.sql output suppressed for cleaner test output
-- test/setup.sql output suppressed for cleaner test output
\set ECHO none
\echo -- test/setup.sql done, test output follows
-- test/setup.sql done, test output follows
\echo "Test 343: Statistical Unit View with Hierarchical Identifiers"
"Test 343: Statistical Unit View with Hierarchical Identifiers"
-- Setup user
CALL test.set_user_from_email('test.admin@statbus.org');
\i samples/norway/getting-started.sql
\i samples/norway/settings.sql
INSERT INTO settings(activity_category_standard_id,country_id)
SELECT (SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
     , (SELECT id FROM public.country WHERE iso_2 = 'NO')
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id = EXCLUDED.activity_category_standard_id,
   country_id = EXCLUDED.country_id
   WHERE settings.only_one_setting = EXCLUDED.only_one_setting;
;
\i samples/norway/activity_category/activity_category_norway.sql
\copy public.activity_category_available_custom FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/regions/norway-regions-2024.sql
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/sector/sector_norway.sql
\copy public.sector_custom_only FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/legal_form/legal_form_norway.sql
\copy public.legal_form_custom_only FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/data_source/data_source_norway.sql
\copy public.data_source_custom (code, name) FROM 'samples/norway/data_source/data_source_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
-- Create hierarchical identifier type
INSERT INTO public.external_ident_type (code, name, shape, labels, description, priority, archived)
VALUES ('surveyor_ident', 'Surveyor Identifier', 'hierarchical', 'region.district.seq',
        'Region/District/Sequence hierarchical composite key', 50, false);
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created btree index su_ei_tax_ident_idx for external_ident_type
NOTICE:  Created btree index su_ei_stat_ident_idx for external_ident_type
NOTICE:  Created btree index su_ei_surveyor_ident_idx for external_ident_type
NOTICE:  Created GIST ltree index su_ei_surveyor_ident_ltree_gist_idx for hierarchical external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
-- Create Legal Unit with hierarchical identifier
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_type_id FROM public.external_ident_type WHERE code = 'surveyor_ident';
    
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT 343', v_user_id, now()) RETURNING id INTO v_ent_id;
    
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU Hierarchical 343', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_type_id, 'NORTH.KAMPALA.001'::ltree, v_user_id, now());
END $$;
-- Also create a Legal Unit with REGULAR identifier to make sure it still works
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_type_id FROM public.external_ident_type WHERE code = 'tax_ident';
    
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT Regular 343', v_user_id, now()) RETURNING id INTO v_ent_id;
    
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU Regular 343', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    
    INSERT INTO public.external_ident (legal_unit_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_type_id, '987654321', v_user_id, now());
END $$;
-- Refresh timeline tables and statistical_unit
CALL public.timepoints_refresh();
CALL public.timesegments_refresh();
CALL public.timeline_enterprise_refresh();
CALL public.timeline_legal_unit_refresh();
CALL public.timeline_establishment_refresh();
CALL public.statistical_unit_refresh();
\echo "Verifying external_idents in statistical_unit:"
"Verifying external_idents in statistical_unit:"
SELECT
    unit_type,
    name,
    external_idents
FROM public.statistical_unit
WHERE name LIKE '%343%'
ORDER BY name;
 unit_type  |        name         |             external_idents             
------------+---------------------+-----------------------------------------
 enterprise | ENT 343             | {}
 enterprise | ENT Regular 343     | {}
 legal_unit | LU Hierarchical 343 | {"surveyor_ident": "NORTH.KAMPALA.001"}
 legal_unit | LU Regular 343      | {"tax_ident": "987654321"}
(4 rows)

ROLLBACK;
