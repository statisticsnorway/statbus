BEGIN;
\echo "Setting up Statbus to load legal_unit without establishment with statistics"
"Setting up Statbus to load legal_unit without establishment with statistics"
\echo "This is the use case for Morocco, so sample data from them"
"This is the use case for Morocco, so sample data from them"
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id, only_one_setting)
SELECT id, true FROM activity_category_standard WHERE code = 'isic_v4'
ON CONFLICT (only_one_setting)
DO UPDATE SET
    activity_category_standard_id = EXCLUDED.activity_category_standard_id;
SELECT acs.code
  FROM public.settings AS s
  JOIN activity_category_standard AS acs
    ON s.activity_category_standard_id = acs.id;
  code   
---------
 isic_v4
(1 row)

\echo "User uploads the activity categories"
"User uploads the activity categories"
\copy public.activity_category_available_custom(path,name,description) FROM 'test/data/04_morocco-activity_category.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.activity_category_available;
 count 
-------
  1130
(1 row)

\echo "User uploads the regions"
"User uploads the regions"
\copy public.region_upload(path, name) FROM 'test/data/04_morocco-regions.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.region;
 count 
-------
   280
(1 row)

\echo "User uploads the sample legal forms"
"User uploads the sample legal forms"
\copy public.legal_form_custom_only(code,name) FROM 'test/data/04_morocco-legal_form.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.legal_form_available;
 count 
-------
    17
(1 row)

\echo "User uploads the sample sectors"
"User uploads the sample sectors"
\copy public.sector_custom_only(path,name,description) FROM 'test/data/04_morocco-sector.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.sector_available;
 count 
-------
    33
(1 row)

SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |                0 |                0
(1 row)

\echo "User uploads legal_units with statistics"
"User uploads legal_units with statistics"
\copy public.import_legal_unit_current(stat_ident,legal_form_code,name,birth_date,physical_postal_place,physical_address_part1,primary_activity_category_code,physical_country_iso_2,physical_region_code,sector_code,employees,turnover) FROM 'test/data/04_morocco-legal-units-with-stats-small.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |               10 |               10
(1 row)

\echo "Refreshing materialized views"
"Refreshing materialized views"
-- Exclude the refresh_time_ms as it will vary.
SELECT view_name FROM statistical_unit_refresh_now();
         view_name         
---------------------------
 statistical_unit
 activity_category_used
 region_used
 sector_used
 legal_form_used
 country_used
 statistical_unit_facet
 statistical_history
 statistical_history_facet
(9 rows)

\x
SELECT unit_type, name, external_idents, stats, jsonb_pretty(stats_summary) AS stats_summary
FROM statistical_unit
ORDER BY name, unit_type;
-[ RECORD 1 ]---+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | AGENCE POUR L'AMENAGEMENT DE LAVALLEE BOUREGREG
external_idents | {"stat_ident": "3305002"}
stats           | {"turnover": 1714446227, "employees": 115}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 1714446227,                                                 +
                |         "min": 1714446227,                                                 +
                |         "sum": 1714446227,                                                 +
                |         "mean": 1714446227,                                                +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 115,                                                        +
                |         "min": 115,                                                        +
                |         "sum": 115,                                                        +
                |         "mean": 115,                                                       +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 2 ]---+----------------------------------------------------------------------------
unit_type       | enterprise
name            | AGENCE POUR L'AMENAGEMENT DE LAVALLEE BOUREGREG
external_idents | {"stat_ident": "3305002"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 1714446227,                                                 +
                |         "min": 1714446227,                                                 +
                |         "sum": 1714446227,                                                 +
                |         "mean": 1714446227.00,                                             +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 115,                                                        +
                |         "min": 115,                                                        +
                |         "sum": 115,                                                        +
                |         "mean": 115.00,                                                    +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 3 ]---+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | BACHIRI MEDIOUNI SANITAIRE (BAMESA)
external_idents | {"stat_ident": "5340521"}
stats           | {"turnover": 13723099, "employees": 20}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 13723099,                                                   +
                |         "min": 13723099,                                                   +
                |         "sum": 13723099,                                                   +
                |         "mean": 13723099,                                                  +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 20,                                                         +
                |         "min": 20,                                                         +
                |         "sum": 20,                                                         +
                |         "mean": 20,                                                        +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 4 ]---+----------------------------------------------------------------------------
unit_type       | enterprise
name            | BACHIRI MEDIOUNI SANITAIRE (BAMESA)
external_idents | {"stat_ident": "5340521"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 13723099,                                                   +
                |         "min": 13723099,                                                   +
                |         "sum": 13723099,                                                   +
                |         "mean": 13723099.00,                                               +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 20,                                                         +
                |         "min": 20,                                                         +
                |         "sum": 20,                                                         +
                |         "mean": 20.00,                                                     +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 5 ]---+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | BARID AL MARGRIB
external_idents | {"stat_ident": "3302916"}
stats           | {"turnover": 990540655, "employees": 3884}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 990540655,                                                  +
                |         "min": 990540655,                                                  +
                |         "sum": 990540655,                                                  +
                |         "mean": 990540655,                                                 +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 3884,                                                       +
                |         "min": 3884,                                                       +
                |         "sum": 3884,                                                       +
                |         "mean": 3884,                                                      +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 6 ]---+----------------------------------------------------------------------------
unit_type       | enterprise
name            | BARID AL MARGRIB
external_idents | {"stat_ident": "3302916"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 990540655,                                                  +
                |         "min": 990540655,                                                  +
                |         "sum": 990540655,                                                  +
                |         "mean": 990540655.00,                                              +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 3884,                                                       +
                |         "min": 3884,                                                       +
                |         "sum": 3884,                                                       +
                |         "mean": 3884.00,                                                   +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 7 ]---+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | GROUPE AL OMRANE MARRAKECH
external_idents | {"stat_ident": "6521496"}
stats           | {"turnover": 1158577915, "employees": 152}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 1158577915,                                                 +
                |         "min": 1158577915,                                                 +
                |         "sum": 1158577915,                                                 +
                |         "mean": 1158577915,                                                +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 152,                                                        +
                |         "min": 152,                                                        +
                |         "sum": 152,                                                        +
                |         "mean": 152,                                                       +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 8 ]---+----------------------------------------------------------------------------
unit_type       | enterprise
name            | GROUPE AL OMRANE MARRAKECH
external_idents | {"stat_ident": "6521496"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 1158577915,                                                 +
                |         "min": 1158577915,                                                 +
                |         "sum": 1158577915,                                                 +
                |         "mean": 1158577915.00,                                             +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 152,                                                        +
                |         "min": 152,                                                        +
                |         "sum": 152,                                                        +
                |         "mean": 152.00,                                                    +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 9 ]---+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | HRM HOTELS ET RESORTS OF MOROCCO
external_idents | {"stat_ident": "3300598"}
stats           | {"turnover": 27495157, "employees": 199}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 27495157,                                                   +
                |         "min": 27495157,                                                   +
                |         "sum": 27495157,                                                   +
                |         "mean": 27495157,                                                  +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 199,                                                        +
                |         "min": 199,                                                        +
                |         "sum": 199,                                                        +
                |         "mean": 199,                                                       +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 10 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | HRM HOTELS ET RESORTS OF MOROCCO
external_idents | {"stat_ident": "3300598"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 27495157,                                                   +
                |         "min": 27495157,                                                   +
                |         "sum": 27495157,                                                   +
                |         "mean": 27495157.00,                                               +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 199,                                                        +
                |         "min": 199,                                                        +
                |         "sum": 199,                                                        +
                |         "mean": 199.00,                                                    +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 11 ]--+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | LA MAROCAINE DE JEUX ET DES SPORTS (MDJS)
external_idents | {"stat_ident": "1066118"}
stats           | {"turnover": 778756736, "employees": 40}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 778756736,                                                  +
                |         "min": 778756736,                                                  +
                |         "sum": 778756736,                                                  +
                |         "mean": 778756736,                                                 +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 40,                                                         +
                |         "min": 40,                                                         +
                |         "sum": 40,                                                         +
                |         "mean": 40,                                                        +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 12 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | LA MAROCAINE DE JEUX ET DES SPORTS (MDJS)
external_idents | {"stat_ident": "1066118"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 778756736,                                                  +
                |         "min": 778756736,                                                  +
                |         "sum": 778756736,                                                  +
                |         "mean": 778756736.00,                                              +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 40,                                                         +
                |         "min": 40,                                                         +
                |         "sum": 40,                                                         +
                |         "mean": 40.00,                                                     +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 13 ]--+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | OFFICE CHERIFIEN DES PHOSPHATES (OCP)
external_idents | {"stat_ident": "2220794"}
stats           | {"turnover": 33300, "employees": 16814}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 33300,                                                      +
                |         "min": 33300,                                                      +
                |         "sum": 33300,                                                      +
                |         "mean": 33300,                                                     +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 16814,                                                      +
                |         "min": 16814,                                                      +
                |         "sum": 16814,                                                      +
                |         "mean": 16814,                                                     +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 14 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | OFFICE CHERIFIEN DES PHOSPHATES (OCP)
external_idents | {"stat_ident": "2220794"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 33300,                                                      +
                |         "min": 33300,                                                      +
                |         "sum": 33300,                                                      +
                |         "mean": 33300.00,                                                  +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 16814,                                                      +
                |         "min": 16814,                                                      +
                |         "sum": 16814,                                                      +
                |         "mean": 16814.00,                                                  +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 15 ]--+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | OFFICE NATIONAL DE L'ELECTRICITE ET DE L'EEAU POTABLE (BRANCHE EAU POTABLE)
external_idents | {"stat_ident": "40486450"}
stats           | {"turnover": 575961, "employees": 8212}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 575961,                                                     +
                |         "min": 575961,                                                     +
                |         "sum": 575961,                                                     +
                |         "mean": 575961,                                                    +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 8212,                                                       +
                |         "min": 8212,                                                       +
                |         "sum": 8212,                                                       +
                |         "mean": 8212,                                                      +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 16 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | OFFICE NATIONAL DE L'ELECTRICITE ET DE L'EEAU POTABLE (BRANCHE EAU POTABLE)
external_idents | {"stat_ident": "40486450"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 575961,                                                     +
                |         "min": 575961,                                                     +
                |         "sum": 575961,                                                     +
                |         "mean": 575961.00,                                                 +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 8212,                                                       +
                |         "min": 8212,                                                       +
                |         "sum": 8212,                                                       +
                |         "mean": 8212.00,                                                   +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 17 ]--+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | OFFICE NATIONAL DES AEROPORTS (ONDA)
external_idents | {"stat_ident": "2200019"}
stats           | {"turnover": 4241673, "employees": 2382}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 4241673,                                                    +
                |         "min": 4241673,                                                    +
                |         "sum": 4241673,                                                    +
                |         "mean": 4241673,                                                   +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 2382,                                                       +
                |         "min": 2382,                                                       +
                |         "sum": 2382,                                                       +
                |         "mean": 2382,                                                      +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 18 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | OFFICE NATIONAL DES AEROPORTS (ONDA)
external_idents | {"stat_ident": "2200019"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 4241673,                                                    +
                |         "min": 4241673,                                                    +
                |         "sum": 4241673,                                                    +
                |         "mean": 4241673.00,                                                +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 2382,                                                       +
                |         "min": 2382,                                                       +
                |         "sum": 2382,                                                       +
                |         "mean": 2382.00,                                                   +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }
-[ RECORD 19 ]--+----------------------------------------------------------------------------
unit_type       | legal_unit
name            | SOCIETE NATIONAL DE RADIO DIFFUSION ET DE TELEVISION (SNRT)
external_idents | {"stat_ident": "3304097"}
stats           | {"turnover": 569600541, "employees": 2103}
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 569600541,                                                  +
                |         "min": 569600541,                                                  +
                |         "sum": 569600541,                                                  +
                |         "mean": 569600541,                                                 +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 2103,                                                       +
                |         "min": 2103,                                                       +
                |         "sum": 2103,                                                       +
                |         "mean": 2103,                                                      +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0,                                                       +
                |         "variance": 0,                                                     +
                |         "sum_sq_diff": 0,                                                  +
                |         "coefficient_of_variation_pct": 0                                  +
                |     }                                                                      +
                | }
-[ RECORD 20 ]--+----------------------------------------------------------------------------
unit_type       | enterprise
name            | SOCIETE NATIONAL DE RADIO DIFFUSION ET DE TELEVISION (SNRT)
external_idents | {"stat_ident": "3304097"}
stats           | 
stats_summary   | {                                                                          +
                |     "turnover": {                                                          +
                |         "max": 569600541,                                                  +
                |         "min": 569600541,                                                  +
                |         "sum": 569600541,                                                  +
                |         "mean": 569600541.00,                                              +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     },                                                                     +
                |     "employees": {                                                         +
                |         "max": 2103,                                                       +
                |         "min": 2103,                                                       +
                |         "sum": 2103,                                                       +
                |         "mean": 2103.00,                                                   +
                |         "type": "number",                                                  +
                |         "count": 1,                                                        +
                |         "stddev": 0.00,                                                    +
                |         "variance": 0.00,                                                  +
                |         "sum_sq_diff": 0.00,                                               +
                |         "coefficient_of_variation_pct": 0.00                               +
                |     }                                                                      +
                | }

\echo "Checking statistics"
"Checking statistics"
SELECT unit_type
     , COUNT(DISTINCT unit_id) AS distinct_unit_count
     , jsonb_pretty(jsonb_agg(DISTINCT invalid_codes) FILTER (WHERE invalid_codes IS NOT NULL)) AS invalid_codes
     , jsonb_pretty(jsonb_stats_summary_merge_agg(stats_summary)) AS stats_summary
 FROM statistical_unit
 GROUP BY unit_type;
-[ RECORD 1 ]-------+-----------------------------------------------
unit_type           | legal_unit
distinct_unit_count | 10
invalid_codes       | 
stats_summary       | {                                             +
                    |     "turnover": {                             +
                    |         "max": 1714446227,                    +
                    |         "min": 33300,                         +
                    |         "sum": 5257991264,                    +
                    |         "mean": 525799126.40,                 +
                    |         "type": "number",                     +
                    |         "count": 10,                          +
                    |         "stddev": 617343924.34,               +
                    |         "variance": 381113520920596365.16,    +
                    |         "sum_sq_diff": 3430021688285367286.40,+
                    |         "coefficient_of_variation_pct": 117.41+
                    |     },                                        +
                    |     "employees": {                            +
                    |         "max": 16814,                         +
                    |         "min": 20,                            +
                    |         "sum": 33921,                         +
                    |         "mean": 3392.10,                      +
                    |         "type": "number",                     +
                    |         "count": 10,                          +
                    |         "stddev": 5378.39,                    +
                    |         "variance": 28927114.99,              +
                    |         "sum_sq_diff": 260344034.90,          +
                    |         "coefficient_of_variation_pct": 158.56+
                    |     }                                         +
                    | }
-[ RECORD 2 ]-------+-----------------------------------------------
unit_type           | enterprise
distinct_unit_count | 10
invalid_codes       | 
stats_summary       | {                                             +
                    |     "turnover": {                             +
                    |         "max": 1714446227,                    +
                    |         "min": 33300,                         +
                    |         "sum": 5257991264,                    +
                    |         "mean": 525799126.40,                 +
                    |         "type": "number",                     +
                    |         "count": 10,                          +
                    |         "stddev": 617343924.34,               +
                    |         "variance": 381113520920596365.16,    +
                    |         "sum_sq_diff": 3430021688285367286.40,+
                    |         "coefficient_of_variation_pct": 117.41+
                    |     },                                        +
                    |     "employees": {                            +
                    |         "max": 16814,                         +
                    |         "min": 20,                            +
                    |         "sum": 33921,                         +
                    |         "mean": 3392.10,                      +
                    |         "type": "number",                     +
                    |         "count": 10,                          +
                    |         "stddev": 5378.39,                    +
                    |         "variance": 28927114.99,              +
                    |         "sum_sq_diff": 260344034.90,          +
                    |         "coefficient_of_variation_pct": 158.56+
                    |     }                                         +
                    | }

\x
ROLLBACK;
