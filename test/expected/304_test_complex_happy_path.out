BEGIN;
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create('test.admin@statbus.org', 'admin_user'::statbus_role, 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create('test.regular@statbus.org', 'regular_user'::statbus_role, 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create('test.restricted@statbus.org', 'restricted_user'::statbus_role, 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

\echo "Test 69: Happy Path - Complex Temporal Attribute Changes and Slicing"
"Test 69: Happy Path - Complex Temporal Attribute Changes and Slicing"
\echo "Setting up Statbus environment for test 69"
"Setting up Statbus environment for test 69"
-- A Super User configures statbus.
CALL test.set_user_from_email('test.admin@statbus.org');
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id,only_one_setting)
SELECT id, true FROM activity_category_standard WHERE code = 'nace_v2.1'
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id =(SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
   WHERE settings.id = EXCLUDED.id;
SELECT acs.code FROM public.settings AS s JOIN activity_category_standard AS acs ON s.activity_category_standard_id = acs.id;
   code    
-----------
 nace_v2.1
(1 row)

\echo "User uploads the sample activity categories, regions, legal forms, sectors, tags, stats definitions"
"User uploads the sample activity categories, regions, legal forms, sectors, tags, stats definitions"
\copy public.activity_category_available_custom(path,name,description) FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.legal_form_custom_only(code,name) FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.sector_custom_only(path,name,description) FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "Ensure sample tags and stat definitions are loaded"
"Ensure sample tags and stat definitions are loaded"
-- Minimal tags for testing
INSERT INTO public.tag (path, name, type) VALUES
('TestTag', 'Test Tag Parent', 'custom'),
('TestTag.LU', 'Legal Unit Test Tag', 'custom'),
('TestTag.LU.Updated', 'Legal Unit Updated Test Tag', 'custom'),
('TestTag.ES', 'Establishment Test Tag Parent', 'custom'),
('TestTag.ES.Formal', 'Formal Establishment Test Tag', 'custom'),
('TestTag.ES.Formal.Updated', 'Formal Establishment Updated Test Tag', 'custom'),
('TestTag.ES.Informal', 'Informal Establishment Test Tag', 'custom'),
('TestTag.ES.Informal.Updated', 'Informal Establishment Updated Test Tag', 'custom')
ON CONFLICT (path) DO NOTHING;
-- Minimal stat definition for testing
-- 'employees' and 'turnover' are default. This test uses the default 'employees'.
-- Custom stats like 'men_employees', 'women_employees' are tested in 71_test_custom_happy_path.sql
SAVEPOINT main_test_69_start;
\echo "Initial counts before any test block for Test 69"
"Initial counts before any test block for Test 69"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

--------------------------------------------------------------------------------
-- Scenario 69.A: Legal Unit - Full Attribute Lifecycle
--------------------------------------------------------------------------------
SAVEPOINT scenario_69_a_lu_lifecycle;
\echo "Scenario 69.A: Legal Unit - Full Attribute Lifecycle (LU-69A)"
"Scenario 69.A: Legal Unit - Full Attribute Lifecycle (LU-69A)"
-- Sub-Scenario 69.A.1: Initial LU Import (1 Row)
\echo "Sub-Scenario 69.A.1: Initial LU Import for LU-69A"
"Sub-Scenario 69.A.1: Initial LU Import for LU-69A"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition legal_unit_source_dates not found.'; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_a1_lu', 'Test 69.A.1: LU-69A Initial', 'Test 69.A.1');
END $$;
INSERT INTO public.import_69_a1_lu_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, sector_code, legal_form_code, email_address, employees, tag_path
) VALUES (
    '69A000001', 'LU-69A Period 1', '2023-01-01', '2023-03-31', 'Addr 1 LU-69A', 'NO', '1001', '0301',
    '01.110', 'S1', 'AS', 'lu69a_p1@example.com', '10', 'TestTag.LU'
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_a1_lu:"
"Job status for import_69_a1_lu:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_a1_lu';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_a1_lu | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_a1_lu:"
"Data table for import_69_a1_lu:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_a1_lu_data ORDER BY row_id;
 row_id |   state   | errors |       invalid_codes       |                                                                merge_status                                                                 | action | operation | tax_ident_raw |    name_raw     | valid_from_raw | valid_to_raw 
--------+-----------+--------+---------------------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+-----------------+----------------+--------------
      1 | processed | {}     | {"sector_code_raw": "S1"} | {"contact": "APPLIED", "legal_unit": "APPLIED", "stat_employees": "APPLIED", "primary_activity": "APPLIED", "physical_location": "APPLIED"} | use    | insert    | 69A000001     | LU-69A Period 1 | 2023-01-01     | 2023-03-31
(1 row)

\echo "Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.1 (all segments shown):"
"Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.1 (all segments shown):"
\echo "Legal Unit:"
"Legal Unit:"
SELECT lu.name, ei.ident, lu.enterprise_id IS NOT NULL as has_enterprise, lu.primary_for_enterprise, sec.code as sector_code, lf.code as legal_form_code, lu.valid_from, lu.valid_to
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.sector sec ON lu.sector_id = sec.id
LEFT JOIN public.legal_form lf ON lu.legal_form_id = lf.id
WHERE ei.ident = '69A000001' ORDER BY lu.valid_from, lu.valid_to;
      name       |   ident   | has_enterprise | primary_for_enterprise | sector_code | legal_form_code | valid_from |  valid_to  
-----------------+-----------+----------------+------------------------+-------------+-----------------+------------+------------
 LU-69A Period 1 | 69A000001 | t              | t                      |             | AS              | 2023-01-01 | 2023-03-31
(1 row)

\echo "Location:"
"Location:"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = '69A000001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
 address_part1 | postcode | region_code | valid_from |  valid_to  
---------------+----------+-------------+------------+------------
 Addr 1 LU-69A | 1001     | 0301        | 2023-01-01 | 2023-03-31
(1 row)

\echo "Activity:"
"Activity:"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code |  type   | valid_from |  valid_to  
---------------+---------+------------+------------
 01.110        | primary | 2023-01-01 | 2023-03-31
(1 row)

\echo "Contact:"
"Contact:"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 lu69a_p1@example.com | 2023-01-01 | 2023-03-31
(1 row)

\echo "Stat (Employees):"
"Stat (Employees):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |        10 | 2023-01-01 | 2023-03-31
(1 row)

\echo "Tag:"
"Tag:"
SELECT lu.name as lu_name, lu.valid_from AS lu_valid_from, lu.valid_to AS lu_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.legal_unit_id = lu.id) as tag_paths
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001'
ORDER BY lu.valid_from, lu.valid_to;
     lu_name     | lu_valid_from | lu_valid_to |  tag_paths   
-----------------+---------------+-------------+--------------
 LU-69A Period 1 | 2023-01-01    | 2023-03-31  | {TestTag.LU}
(1 row)

-- Sub-Scenario 69.A.2: First Update (Change LU Name, Address, Activity)
\echo "Sub-Scenario 69.A.2: Update LU-69A (Name, Address, Activity)"
"Sub-Scenario 69.A.2: Update LU-69A (Name, Address, Activity)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_a2_lu', 'Test 69.A.2: LU-69A Update 1', 'Test 69.A.2');
END $$;
INSERT INTO public.import_69_a2_lu_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, sector_code, legal_form_code, email_address, employees, tag_path
) VALUES (
    '69A000001', 'LU-69A Period 2 Updated Name', '2023-04-01', '2023-06-30', 'Addr 2 LU-69A Updated', 'NO', '1002', '0301', -- Changed postcode too
    '01.120', 'S1', 'AS', 'lu69a_p1@example.com', '10', 'TestTag.LU' -- Sector, email, employees, tag unchanged
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_a2_lu:"
"Job status for import_69_a2_lu:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_a2_lu';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_a2_lu | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_a2_lu:"
"Data table for import_69_a2_lu:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_a2_lu_data ORDER BY row_id;
 row_id |   state   | errors |       invalid_codes       |                                                                merge_status                                                                 | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+---------------------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {"sector_code_raw": "S1"} | {"contact": "APPLIED", "legal_unit": "APPLIED", "stat_employees": "APPLIED", "primary_activity": "APPLIED", "physical_location": "APPLIED"} | use    | update    | 69A000001     | LU-69A Period 2 Updated Name | 2023-04-01     | 2023-06-30
(1 row)

\echo "Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.2 (all segments shown):"
"Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.2 (all segments shown):"
\echo "Legal Unit:"
"Legal Unit:"
SELECT lu.name, ei.ident, sec.code as sector_code, lf.code as legal_form_code, lu.valid_from, lu.valid_to
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.sector sec ON lu.sector_id = sec.id
LEFT JOIN public.legal_form lf ON lu.legal_form_id = lf.id
WHERE ei.ident = '69A000001' ORDER BY lu.valid_from, lu.valid_to;
             name             |   ident   | sector_code | legal_form_code | valid_from |  valid_to  
------------------------------+-----------+-------------+-----------------+------------+------------
 LU-69A Period 1              | 69A000001 |             | AS              | 2023-01-01 | 2023-03-31
 LU-69A Period 2 Updated Name | 69A000001 |             | AS              | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Location:"
"Location:"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = '69A000001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 LU-69A         | 1001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 LU-69A Updated | 1002     | 0301        | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Activity:"
"Activity:"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code |  type   | valid_from |  valid_to  
---------------+---------+------------+------------
 01.110        | primary | 2023-01-01 | 2023-03-31
 01.120        | primary | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Contact (should be unchanged from A.1, possibly extended):"
"Contact (should be unchanged from A.1, possibly extended):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 lu69a_p1@example.com | 2023-01-01 | 2023-06-30
(1 row)

\echo "Stat (Employees - should be unchanged from A.1, possibly extended):"
"Stat (Employees - should be unchanged from A.1, possibly extended):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |        10 | 2023-01-01 | 2023-06-30
(1 row)

\echo "Tag (should be unchanged from A.1, possibly extended):"
"Tag (should be unchanged from A.1, possibly extended):"
SELECT lu.name as lu_name, lu.valid_from AS lu_valid_from, lu.valid_to AS lu_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.legal_unit_id = lu.id) as tag_paths
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001'
ORDER BY lu.valid_from, lu.valid_to;
           lu_name            | lu_valid_from | lu_valid_to |  tag_paths   
------------------------------+---------------+-------------+--------------
 LU-69A Period 1              | 2023-01-01    | 2023-03-31  | {TestTag.LU}
 LU-69A Period 2 Updated Name | 2023-04-01    | 2023-06-30  | {TestTag.LU}
(2 rows)

-- Sub-Scenario 69.A.3: Second Update (Change Sector, Email, Employees, Tag)
\echo "Sub-Scenario 69.A.3: Update LU-69A (Sector, Email, Employees, Tag)"
"Sub-Scenario 69.A.3: Update LU-69A (Sector, Email, Employees, Tag)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_a3_lu', 'Test 69.A.3: LU-69A Update 2', 'Test 69.A.3');
END $$;
INSERT INTO public.import_69_a3_lu_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, sector_code, legal_form_code, email_address, employees, tag_path
) VALUES (
    '69A000001', 'LU-69A Period 2 Updated Name', '2023-07-01', '2023-09-30', 'Addr 2 LU-69A Updated', 'NO', '1002', '0301',
    '01.120', '2100', 'AS', 'lu69a_p3_updated@example.com', '15', 'TestTag.LU.Updated' -- Name, address, activity unchanged from A.2
);
--SET client_min_messages TO DEBUG1;
CALL worker.process_tasks(p_queue => 'import');
--SET client_min_messages TO NOTICE;
\echo "Job status for import_69_a3_lu:"
"Job status for import_69_a3_lu:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_a3_lu';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_a3_lu | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_a3_lu:"
"Data table for import_69_a3_lu:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_a3_lu_data ORDER BY row_id;
 row_id |   state   | errors | invalid_codes |                                                                merge_status                                                                 | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {}            | {"contact": "APPLIED", "legal_unit": "APPLIED", "stat_employees": "APPLIED", "primary_activity": "APPLIED", "physical_location": "APPLIED"} | use    | update    | 69A000001     | LU-69A Period 2 Updated Name | 2023-07-01     | 2023-09-30
(1 row)

\echo "Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.3 (all segments shown):"
"Verification for LU-69A ('69A000001') after Sub-Scenario 69.A.3 (all segments shown):"
\echo "Legal Unit (expect sector 2100 in latest segment):"
"Legal Unit (expect sector 2100 in latest segment):"
SELECT lu.name, ei.ident, sec.code as sector_code, lf.code as legal_form_code, lu.valid_from, lu.valid_to
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.sector sec ON lu.sector_id = sec.id
LEFT JOIN public.legal_form lf ON lu.legal_form_id = lf.id
WHERE ei.ident = '69A000001' ORDER BY lu.valid_from, lu.valid_to;
             name             |   ident   | sector_code | legal_form_code | valid_from |  valid_to  
------------------------------+-----------+-------------+-----------------+------------+------------
 LU-69A Period 1              | 69A000001 |             | AS              | 2023-01-01 | 2023-03-31
 LU-69A Period 2 Updated Name | 69A000001 |             | AS              | 2023-04-01 | 2023-06-30
 LU-69A Period 2 Updated Name | 69A000001 | 2100        | AS              | 2023-07-01 | 2023-09-30
(3 rows)

\echo "Location (should be unchanged from A.2, possibly extended):"
"Location (should be unchanged from A.2, possibly extended):"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = '69A000001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 LU-69A         | 1001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 LU-69A Updated | 1002     | 0301        | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Activity (should be unchanged from A.2, possibly extended):"
"Activity (should be unchanged from A.2, possibly extended):"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code |  type   | valid_from |  valid_to  
---------------+---------+------------+------------
 01.110        | primary | 2023-01-01 | 2023-03-31
 01.120        | primary | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Contact (expect new email):"
"Contact (expect new email):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' ORDER BY con.valid_from, con.valid_to;
        email_address         | valid_from |  valid_to  
------------------------------+------------+------------
 lu69a_p1@example.com         | 2023-01-01 | 2023-06-30
 lu69a_p3_updated@example.com | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Stat (Employees - expect new value 15 in latest segment):"
"Stat (Employees - expect new value 15 in latest segment):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.legal_unit_id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |        10 | 2023-01-01 | 2023-06-30
 employees |        15 | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Tag (expect new tag TestTag.LU.Updated alongside existing):"
"Tag (expect new tag TestTag.LU.Updated alongside existing):"
SELECT lu.name as lu_name, lu.valid_from AS lu_valid_from, lu.valid_to AS lu_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.legal_unit_id = lu.id) as tag_paths
FROM public.legal_unit lu
JOIN public.external_ident ei ON lu.id = ei.legal_unit_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = '69A000001'
ORDER BY lu.valid_from, lu.valid_to;
           lu_name            | lu_valid_from | lu_valid_to |            tag_paths            
------------------------------+---------------+-------------+---------------------------------
 LU-69A Period 1              | 2023-01-01    | 2023-03-31  | {TestTag.LU,TestTag.LU.Updated}
 LU-69A Period 2 Updated Name | 2023-04-01    | 2023-06-30  | {TestTag.LU,TestTag.LU.Updated}
 LU-69A Period 2 Updated Name | 2023-07-01    | 2023-09-30  | {TestTag.LU,TestTag.LU.Updated}
(3 rows)

\echo "Consolidated Statistical Unit view for LU-69A (69A000001) across all periods:"
"Consolidated Statistical Unit view for LU-69A (69A000001) across all periods:"
CALL worker.process_tasks(p_queue => 'analytics');
SELECT
    su.name, su.valid_from, su.valid_to,
    su.physical_address_part1, su.physical_postcode, su.physical_region_code,
    su.primary_activity_category_code, su.sector_code, su.legal_form_code,
    su.email_address, su.stats->>'employees' as employees, su.tag_paths
FROM public.statistical_unit su
WHERE su.unit_type = 'legal_unit' AND su.external_idents->>'tax_ident' = '69A000001'
ORDER BY su.valid_from, su.valid_to;
             name             | valid_from |  valid_to  | physical_address_part1 | physical_postcode | physical_region_code | primary_activity_category_code | sector_code | legal_form_code |        email_address         | employees |            tag_paths            
------------------------------+------------+------------+------------------------+-------------------+----------------------+--------------------------------+-------------+-----------------+------------------------------+-----------+---------------------------------
 LU-69A Period 1              | 2023-01-01 | 2023-03-31 | Addr 1 LU-69A          | 1001              | 0301                 | 01.110                         |             | AS              | lu69a_p1@example.com         | 10        | {TestTag.LU,TestTag.LU.Updated}
 LU-69A Period 2 Updated Name | 2023-04-01 | 2023-06-30 | Addr 2 LU-69A Updated  | 1002              | 0301                 | 01.120                         |             | AS              | lu69a_p1@example.com         | 10        | {TestTag.LU,TestTag.LU.Updated}
 LU-69A Period 2 Updated Name | 2023-07-01 | 2023-09-30 | Addr 2 LU-69A Updated  | 1002              | 0301                 | 01.120                         | 2100        | AS              | lu69a_p3_updated@example.com | 15        | {TestTag.LU,TestTag.LU.Updated}
(3 rows)

ROLLBACK TO scenario_69_a_lu_lifecycle;
--------------------------------------------------------------------------------
-- Scenario 69.B: Formal Establishment - Full Attribute Lifecycle
--------------------------------------------------------------------------------
SAVEPOINT scenario_69_b_formal_es_lifecycle;
\echo "Scenario 69.B: Formal Establishment - Full Attribute Lifecycle (ES-69B)"
"Scenario 69.B: Formal Establishment - Full Attribute Lifecycle (ES-69B)"
-- First, create a stable Legal Unit for the Formal Establishment to link to.
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_b_lu_for_es', 'Test 69.B: Base LU for Formal ES', 'Test 69.B');
END $$;
INSERT INTO public.import_69_b_lu_for_es_upload(tax_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code) VALUES
('69B000000', 'Base LU for ES-69B', '2023-01-01', '2023-12-31', 'S_Base', 'AS', '00.000');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_b_lu_for_es:"
"Job status for import_69_b_lu_for_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_b_lu_for_es';
         slug          |  state   | total_rows | imported_rows | has_error | error_details 
-----------------------+----------+------------+---------------+-----------+---------------
 import_69_b_lu_for_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_b_lu_for_es:"
"Data table for import_69_b_lu_for_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw FROM public.import_69_b_lu_for_es_data ORDER BY row_id;
 row_id |   state   | errors |                                 invalid_codes                                 |       merge_status        | action | operation | tax_ident_raw |      name_raw      
--------+-----------+--------+-------------------------------------------------------------------------------+---------------------------+--------+-----------+---------------+--------------------
      1 | processed | {}     | {"sector_code_raw": "S_Base", "primary_activity_category_code_raw": "00.000"} | {"legal_unit": "APPLIED"} | use    | insert    | 69B000000     | Base LU for ES-69B
(1 row)

-- Sub-Scenario 69.B.1: Initial Formal ES Import
\echo "Sub-Scenario 69.B.1: Initial Formal ES Import for ES-69B"
"Sub-Scenario 69.B.1: Initial Formal ES Import for ES-69B"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_b1_es', 'Test 69.B.1: ES-69B Initial', 'Test 69.B.1');
END $$;
\echo Created job - now uploading data
Created job - now uploading data
INSERT INTO public.import_69_b1_es_upload(
    tax_ident, legal_unit_tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69B00001', '69B000000', 'ES-69B Period 1', '2023-01-01', '2023-03-31', 'Addr 1 ES-69B', 'NO', '2001', '0301',
    '02.110', 'es69b_p1@example.com', '5', 'TestTag.ES.Formal'
);
\echo Processing upload
Processing upload
--SET client_min_messages TO DEBUG1;
CALL worker.process_tasks(p_queue => 'import');
--SET client_min_messages TO NOTICE;
\echo "Job status for import_69_b1_es:"
"Job status for import_69_b1_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_b1_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_b1_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_b1_es:"
"Data table for import_69_b1_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_b1_es_data ORDER BY row_id;
 row_id |   state   | errors |                  invalid_codes                   |                                                  merge_status                                                   | action | operation | tax_ident_raw |    name_raw     | valid_from_raw | valid_to_raw 
--------+-----------+--------+--------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+-----------------+----------------+--------------
      1 | processed | {}     | {"primary_activity_category_code_raw": "02.110"} | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "physical_location": "APPLIED"} | use    | insert    | E69B00001     | ES-69B Period 1 | 2023-01-01     | 2023-03-31
(1 row)

\echo "Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.1 (all segments shown):"
"Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.1 (all segments shown):"
\echo "Establishment:"
"Establishment:"
SELECT est.name, ei.ident, lu_ei.ident as legal_unit_tax_ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.legal_unit lu ON est.legal_unit_id = lu.id
LEFT JOIN public.external_ident lu_ei ON lu.id = lu_ei.legal_unit_id AND lu_ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY est.valid_from, est.valid_to;
      name       |   ident   | legal_unit_tax_ident | valid_from |  valid_to  
-----------------+-----------+----------------------+------------+------------
 ES-69B Period 1 | E69B00001 | 69B000000            | 2023-01-01 | 2023-03-31
(1 row)

\echo "Location:"
"Location:"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69B00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
 address_part1 | postcode | region_code | valid_from |  valid_to  
---------------+----------+-------------+------------+------------
 Addr 1 ES-69B | 2001     | 0301        | 2023-01-01 | 2023-03-31
(1 row)

\echo "Activity:"
"Activity:"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code | type | valid_from | valid_to 
---------------+------+------------+----------
(0 rows)

\echo "Contact:"
"Contact:"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 es69b_p1@example.com | 2023-01-01 | 2023-03-31
(1 row)

\echo "Stat (Employees):"
"Stat (Employees):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         5 | 2023-01-01 | 2023-03-31
(1 row)

\echo "Tag:"
"Tag:"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001'
ORDER BY est.valid_from, est.valid_to;
    est_name     | est_valid_from | est_valid_to |      tag_paths      
-----------------+----------------+--------------+---------------------
 ES-69B Period 1 | 2023-01-01     | 2023-03-31   | {TestTag.ES.Formal}
(1 row)

-- Sub-Scenario 69.B.2: First Update (Change ES Name, Address, Activity)
\echo "Sub-Scenario 69.B.2: Update ES-69B (Name, Address, Activity)"
"Sub-Scenario 69.B.2: Update ES-69B (Name, Address, Activity)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_b2_es', 'Test 69.B.2: ES-69B Update 1', 'Test 69.B.2');
END $$;
INSERT INTO public.import_69_b2_es_upload(
    tax_ident, legal_unit_tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69B00001', '69B000000', 'ES-69B Period 2 Updated Name', '2023-04-01', '2023-06-30', 'Addr 2 ES-69B Updated', 'NO', '2002', '0301',
    '02.120', 'es69b_p1@example.com', '5', 'TestTag.ES.Formal'
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_b2_es:"
"Job status for import_69_b2_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_b2_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_b2_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_b2_es:"
"Data table for import_69_b2_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_b2_es_data ORDER BY row_id;
 row_id |   state   | errors |                  invalid_codes                   |                                                  merge_status                                                   | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+--------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {"primary_activity_category_code_raw": "02.120"} | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "physical_location": "APPLIED"} | use    | update    | E69B00001     | ES-69B Period 2 Updated Name | 2023-04-01     | 2023-06-30
(1 row)

\echo "Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.2 (all segments shown):"
"Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.2 (all segments shown):"
\echo "Establishment (expect new name in latest segment):"
"Establishment (expect new name in latest segment):"
SELECT est.name, ei.ident, lu_ei.ident as legal_unit_tax_ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.legal_unit lu ON est.legal_unit_id = lu.id
LEFT JOIN public.external_ident lu_ei ON lu.id = lu_ei.legal_unit_id AND lu_ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY est.valid_from, est.valid_to;
             name             |   ident   | legal_unit_tax_ident | valid_from |  valid_to  
------------------------------+-----------+----------------------+------------+------------
 ES-69B Period 1              | E69B00001 | 69B000000            | 2023-01-01 | 2023-03-31
 ES-69B Period 2 Updated Name | E69B00001 | 69B000000            | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Location (expect new address):"
"Location (expect new address):"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69B00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 ES-69B         | 2001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 ES-69B Updated | 2002     | 0301        | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Activity (expect new activity code):"
"Activity (expect new activity code):"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code | type | valid_from | valid_to 
---------------+------+------------+----------
(0 rows)

\echo "Contact (should be unchanged from B.1, possibly extended):"
"Contact (should be unchanged from B.1, possibly extended):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 es69b_p1@example.com | 2023-01-01 | 2023-06-30
(1 row)

\echo "Stat (Employees - should be unchanged from B.1, possibly extended):"
"Stat (Employees - should be unchanged from B.1, possibly extended):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         5 | 2023-01-01 | 2023-06-30
(1 row)

\echo "Tag (should be unchanged from B.1, possibly extended):"
"Tag (should be unchanged from B.1, possibly extended):"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001'
ORDER BY est.valid_from, est.valid_to;
           est_name           | est_valid_from | est_valid_to |      tag_paths      
------------------------------+----------------+--------------+---------------------
 ES-69B Period 1              | 2023-01-01     | 2023-03-31   | {TestTag.ES.Formal}
 ES-69B Period 2 Updated Name | 2023-04-01     | 2023-06-30   | {TestTag.ES.Formal}
(2 rows)

-- Sub-Scenario 69.B.3: Second Update (Change Email, Employees, Tag)
\echo "Sub-Scenario 69.B.3: Update ES-69B (Email, Employees, Tag)"
"Sub-Scenario 69.B.3: Update ES-69B (Email, Employees, Tag)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_b3_es', 'Test 69.B.3: ES-69B Update 2', 'Test 69.B.3');
END $$;
INSERT INTO public.import_69_b3_es_upload(
    tax_ident, legal_unit_tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69B00001', '69B000000', 'ES-69B Period 2 Updated Name', '2023-07-01', '2023-09-30', 'Addr 2 ES-69B Updated', 'NO', '2002', '0301',
    '02.120', 'es69b_p3_updated@example.com', '7', 'TestTag.ES.Formal.Updated'
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_b3_es:"
"Job status for import_69_b3_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_b3_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_b3_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_b3_es:"
"Data table for import_69_b3_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_b3_es_data ORDER BY row_id;
 row_id |   state   | errors |                  invalid_codes                   |                                                  merge_status                                                   | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+--------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {"primary_activity_category_code_raw": "02.120"} | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "physical_location": "APPLIED"} | use    | update    | E69B00001     | ES-69B Period 2 Updated Name | 2023-07-01     | 2023-09-30
(1 row)

\echo "Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.3 (all segments shown):"
"Verification for ES-69B ('E69B00001') after Sub-Scenario 69.B.3 (all segments shown):"
\echo "Establishment (name unchanged from B.2 in latest segment):"
"Establishment (name unchanged from B.2 in latest segment):"
SELECT est.name, ei.ident, lu_ei.ident as legal_unit_tax_ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.legal_unit lu ON est.legal_unit_id = lu.id
LEFT JOIN public.external_ident lu_ei ON lu.id = lu_ei.legal_unit_id AND lu_ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY est.valid_from, est.valid_to;
             name             |   ident   | legal_unit_tax_ident | valid_from |  valid_to  
------------------------------+-----------+----------------------+------------+------------
 ES-69B Period 1              | E69B00001 | 69B000000            | 2023-01-01 | 2023-03-31
 ES-69B Period 2 Updated Name | E69B00001 | 69B000000            | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Location (address unchanged from B.2, possibly extended):"
"Location (address unchanged from B.2, possibly extended):"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69B00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 ES-69B         | 2001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 ES-69B Updated | 2002     | 0301        | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Activity (activity code unchanged from B.2, possibly extended):"
"Activity (activity code unchanged from B.2, possibly extended):"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code | type | valid_from | valid_to 
---------------+------+------------+----------
(0 rows)

\echo "Contact (expect new email):"
"Contact (expect new email):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' ORDER BY con.valid_from, con.valid_to;
        email_address         | valid_from |  valid_to  
------------------------------+------------+------------
 es69b_p1@example.com         | 2023-01-01 | 2023-06-30
 es69b_p3_updated@example.com | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Stat (Employees - expect new value 7 in latest segment):"
"Stat (Employees - expect new value 7 in latest segment):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         5 | 2023-01-01 | 2023-06-30
 employees |         7 | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Tag (expect new tag TestTag.ES.Formal.Updated alongside existing):"
"Tag (expect new tag TestTag.ES.Formal.Updated alongside existing):"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69B00001'
ORDER BY est.valid_from, est.valid_to;
           est_name           | est_valid_from | est_valid_to |                   tag_paths                   
------------------------------+----------------+--------------+-----------------------------------------------
 ES-69B Period 1              | 2023-01-01     | 2023-03-31   | {TestTag.ES.Formal,TestTag.ES.Formal.Updated}
 ES-69B Period 2 Updated Name | 2023-04-01     | 2023-09-30   | {TestTag.ES.Formal,TestTag.ES.Formal.Updated}
(2 rows)

\echo "Consolidated Statistical Unit view for ES-69B (E69B00001) across all periods:"
"Consolidated Statistical Unit view for ES-69B (E69B00001) across all periods:"
CALL worker.process_tasks(p_queue => 'analytics');
SELECT
    su.name, su.valid_from, su.valid_to,
    su.physical_address_part1, su.physical_postcode, su.physical_region_code,
    su.primary_activity_category_code,
    su.email_address, su.stats->>'employees' as employees, su.tag_paths,
    su.external_idents->>'legal_unit_tax_ident' as legal_unit_tax_ident
FROM public.statistical_unit su
WHERE su.unit_type = 'establishment' AND su.external_idents->>'tax_ident' = 'E69B00001'
ORDER BY su.valid_from, su.valid_to;
             name             | valid_from |  valid_to  | physical_address_part1 | physical_postcode | physical_region_code | primary_activity_category_code |        email_address         | employees |                   tag_paths                   | legal_unit_tax_ident 
------------------------------+------------+------------+------------------------+-------------------+----------------------+--------------------------------+------------------------------+-----------+-----------------------------------------------+----------------------
 ES-69B Period 1              | 2023-01-01 | 2023-03-31 | Addr 1 ES-69B          | 2001              | 0301                 |                                | es69b_p1@example.com         | 5         | {TestTag.ES.Formal,TestTag.ES.Formal.Updated} | 
 ES-69B Period 2 Updated Name | 2023-04-01 | 2023-06-30 | Addr 2 ES-69B Updated  | 2002              | 0301                 |                                | es69b_p1@example.com         | 5         | {TestTag.ES.Formal,TestTag.ES.Formal.Updated} | 
 ES-69B Period 2 Updated Name | 2023-07-01 | 2023-09-30 | Addr 2 ES-69B Updated  | 2002              | 0301                 |                                | es69b_p3_updated@example.com | 7         | {TestTag.ES.Formal,TestTag.ES.Formal.Updated} | 
(3 rows)

ROLLBACK TO scenario_69_b_formal_es_lifecycle;
--------------------------------------------------------------------------------
-- Scenario 69.C: Informal Establishment - Full Attribute Lifecycle
--------------------------------------------------------------------------------
SAVEPOINT scenario_69_c_informal_es_lifecycle;
\echo "Scenario 69.C: Informal Establishment - Full Attribute Lifecycle (ES-69C)"
"Scenario 69.C: Informal Establishment - Full Attribute Lifecycle (ES-69C)"
-- Sub-Scenario 69.C.1: Initial Informal ES Import
\echo "Sub-Scenario 69.C.1: Initial Informal ES Import for ES-69C"
"Sub-Scenario 69.C.1: Initial Informal ES Import for ES-69C"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_without_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_c1_es', 'Test 69.C.1: ES-69C Initial', 'Test 69.C.1');
END $$;
INSERT INTO public.import_69_c1_es_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69C00001', 'ES-69C Period 1', '2023-01-01', '2023-03-31', 'Addr 1 ES-69C', 'NO', '3001', '0301',
    '03.110', 'es69c_p1@example.com', '2', 'TestTag.ES.Informal'
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_c1_es:"
"Job status for import_69_c1_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_c1_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_c1_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_c1_es:"
"Data table for import_69_c1_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_c1_es_data ORDER BY row_id;
 row_id |   state   | errors |                  invalid_codes                   |                                                  merge_status                                                   | action | operation | tax_ident_raw |    name_raw     | valid_from_raw | valid_to_raw 
--------+-----------+--------+--------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+-----------------+----------------+--------------
      1 | processed | {}     | {"primary_activity_category_code_raw": "03.110"} | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "physical_location": "APPLIED"} | use    | insert    | E69C00001     | ES-69C Period 1 | 2023-01-01     | 2023-03-31
(1 row)

\echo "Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.1 (all segments shown):"
"Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.1 (all segments shown):"
\echo "Establishment:"
"Establishment:"
SELECT est.name, ei.ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY est.valid_from, est.valid_to;
      name       |   ident   | valid_from |  valid_to  
-----------------+-----------+------------+------------
 ES-69C Period 1 | E69C00001 | 2023-01-01 | 2023-03-31
(1 row)

\echo "Location:"
"Location:"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69C00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
 address_part1 | postcode | region_code | valid_from |  valid_to  
---------------+----------+-------------+------------+------------
 Addr 1 ES-69C | 3001     | 0301        | 2023-01-01 | 2023-03-31
(1 row)

\echo "Activity:"
"Activity:"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code | type | valid_from | valid_to 
---------------+------+------------+----------
(0 rows)

\echo "Contact:"
"Contact:"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 es69c_p1@example.com | 2023-01-01 | 2023-03-31
(1 row)

\echo "Stat (Employees):"
"Stat (Employees):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         2 | 2023-01-01 | 2023-03-31
(1 row)

\echo "Tag:"
"Tag:"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001'
ORDER BY est.valid_from, est.valid_to;
    est_name     | est_valid_from | est_valid_to |       tag_paths       
-----------------+----------------+--------------+-----------------------
 ES-69C Period 1 | 2023-01-01     | 2023-03-31   | {TestTag.ES.Informal}
(1 row)

-- Sub-Scenario 69.C.2: First Update (Change ES Name, Address, Activity)
\echo "Sub-Scenario 69.C.2: Update ES-69C (Name, Address, Activity)"
"Sub-Scenario 69.C.2: Update ES-69C (Name, Address, Activity)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_without_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_c2_es', 'Test 69.C.2: ES-69C Update 1', 'Test 69.C.2');
END $$;
INSERT INTO public.import_69_c2_es_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69C00001', 'ES-69C Period 2 Updated Name', '2023-04-01', '2023-06-30', 'Addr 2 ES-69C Updated', 'NO', '3002', '0301',
    '03.120', 'es69c_p1@example.com', '2', 'TestTag.ES.Informal'
);
\echo "Processing import jobs"
"Processing import jobs"
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_c2_es:"
"Job status for import_69_c2_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_c2_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_c2_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_c2_es:"
"Data table for import_69_c2_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_c2_es_data ORDER BY row_id;
 row_id |   state   | errors | invalid_codes |                                                                  merge_status                                                                  | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+---------------+------------------------------------------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {}            | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "primary_activity": "APPLIED", "physical_location": "APPLIED"} | use    | update    | E69C00001     | ES-69C Period 2 Updated Name | 2023-04-01     | 2023-06-30
(1 row)

\echo "Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.2 (all segments shown):"
"Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.2 (all segments shown):"
\echo "Establishment (expect new name in latest segment):"
"Establishment (expect new name in latest segment):"
SELECT est.name, ei.ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY est.valid_from, est.valid_to;
             name             |   ident   | valid_from |  valid_to  
------------------------------+-----------+------------+------------
 ES-69C Period 1              | E69C00001 | 2023-01-01 | 2023-03-31
 ES-69C Period 2 Updated Name | E69C00001 | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Location (expect new address):"
"Location (expect new address):"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69C00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 ES-69C         | 3001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 ES-69C Updated | 3002     | 0301        | 2023-04-01 | 2023-06-30
(2 rows)

\echo "Activity (expect new activity code):"
"Activity (expect new activity code):"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code |  type   | valid_from |  valid_to  
---------------+---------+------------+------------
 03.120        | primary | 2023-04-01 | 2023-06-30
(1 row)

\echo "Contact (should be unchanged from C.1, possibly extended):"
"Contact (should be unchanged from C.1, possibly extended):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY con.valid_from, con.valid_to;
    email_address     | valid_from |  valid_to  
----------------------+------------+------------
 es69c_p1@example.com | 2023-01-01 | 2023-06-30
(1 row)

\echo "Stat (Employees - should be unchanged from C.1, possibly extended):"
"Stat (Employees - should be unchanged from C.1, possibly extended):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         2 | 2023-01-01 | 2023-06-30
(1 row)

\echo "Tag (should be unchanged from C.1, possibly extended):"
"Tag (should be unchanged from C.1, possibly extended):"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001'
ORDER BY est.valid_from, est.valid_to;
           est_name           | est_valid_from | est_valid_to |       tag_paths       
------------------------------+----------------+--------------+-----------------------
 ES-69C Period 1              | 2023-01-01     | 2023-03-31   | {TestTag.ES.Informal}
 ES-69C Period 2 Updated Name | 2023-04-01     | 2023-06-30   | {TestTag.ES.Informal}
(2 rows)

-- Sub-Scenario 69.C.3: Second Update (Change Email, Employees, Tag)
\echo "Sub-Scenario 69.C.3: Update ES-69C (Email, Employees, Tag)"
"Sub-Scenario 69.C.3: Update ES-69C (Email, Employees, Tag)"
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'establishment_without_lu_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_69_c3_es', 'Test 69.C.3: ES-69C Update 2', 'Test 69.C.3');
END $$;
INSERT INTO public.import_69_c3_es_upload(
    tax_ident, name, valid_from, valid_to, physical_address_part1, physical_country_iso_2, physical_postcode, physical_region_code,
    primary_activity_category_code, email_address, employees, tag_path
) VALUES (
    'E69C00001', 'ES-69C Period 2 Updated Name', '2023-07-01', '2023-09-30', 'Addr 2 ES-69C Updated', 'NO', '3002', '0301',
    '03.120', 'es69c_p3_updated@example.com', '3', 'TestTag.ES.Informal.Updated'
);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_69_c3_es:"
"Job status for import_69_c3_es:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_69_c3_es';
      slug       |  state   | total_rows | imported_rows | has_error | error_details 
-----------------+----------+------------+---------------+-----------+---------------
 import_69_c3_es | finished |          1 |             1 | f         | 
(1 row)

\echo "Data table for import_69_c3_es:"
"Data table for import_69_c3_es:"
SELECT row_id, state, errors, invalid_codes, merge_status, action, operation, tax_ident_raw, name_raw, valid_from_raw, valid_to_raw FROM public.import_69_c3_es_data ORDER BY row_id;
 row_id |   state   | errors | invalid_codes |                                                                  merge_status                                                                  | action | operation | tax_ident_raw |           name_raw           | valid_from_raw | valid_to_raw 
--------+-----------+--------+---------------+------------------------------------------------------------------------------------------------------------------------------------------------+--------+-----------+---------------+------------------------------+----------------+--------------
      1 | processed | {}     | {}            | {"contact": "APPLIED", "establishment": "APPLIED", "stat_employees": "APPLIED", "primary_activity": "APPLIED", "physical_location": "APPLIED"} | use    | update    | E69C00001     | ES-69C Period 2 Updated Name | 2023-07-01     | 2023-09-30
(1 row)

\echo "Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.3 (all segments shown):"
"Verification for ES-69C ('E69C00001') after Sub-Scenario 69.C.3 (all segments shown):"
\echo "Establishment (name unchanged from C.2 in latest segment):"
"Establishment (name unchanged from C.2 in latest segment):"
SELECT est.name, ei.ident, est.valid_from, est.valid_to
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY est.valid_from, est.valid_to;
             name             |   ident   | valid_from |  valid_to  
------------------------------+-----------+------------+------------
 ES-69C Period 1              | E69C00001 | 2023-01-01 | 2023-03-31
 ES-69C Period 2 Updated Name | E69C00001 | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Location (address unchanged from C.2, possibly extended):"
"Location (address unchanged from C.2, possibly extended):"
SELECT loc.address_part1, loc.postcode, r.code as region_code, loc.valid_from, loc.valid_to
FROM public.location loc
JOIN public.external_ident ei ON loc.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
LEFT JOIN public.region r ON loc.region_id = r.id
WHERE ei.ident = 'E69C00001' AND loc.type='physical' ORDER BY loc.valid_from, loc.valid_to;
     address_part1     | postcode | region_code | valid_from |  valid_to  
-----------------------+----------+-------------+------------+------------
 Addr 1 ES-69C         | 3001     | 0301        | 2023-01-01 | 2023-03-31
 Addr 2 ES-69C Updated | 3002     | 0301        | 2023-04-01 | 2023-09-30
(2 rows)

\echo "Activity (activity code unchanged from C.2, possibly extended):"
"Activity (activity code unchanged from C.2, possibly extended):"
SELECT ac.code as activity_code, act.type, act.valid_from, act.valid_to
FROM public.activity act
JOIN public.activity_category ac ON act.category_id = ac.id
JOIN public.external_ident ei ON act.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND act.type='primary' ORDER BY act.valid_from, act.valid_to;
 activity_code |  type   | valid_from |  valid_to  
---------------+---------+------------+------------
 03.120        | primary | 2023-04-01 | 2023-09-30
(1 row)

\echo "Contact (expect new email):"
"Contact (expect new email):"
SELECT con.email_address, con.valid_from, con.valid_to
FROM public.contact con
JOIN public.external_ident ei ON con.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' ORDER BY con.valid_from, con.valid_to;
        email_address         | valid_from |  valid_to  
------------------------------+------------+------------
 es69c_p1@example.com         | 2023-01-01 | 2023-06-30
 es69c_p3_updated@example.com | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Stat (Employees - expect new value 3 in latest segment):"
"Stat (Employees - expect new value 3 in latest segment):"
SELECT sd.code as stat_code, sfu.value_int, sfu.valid_from, sfu.valid_to
FROM public.stat_for_unit sfu
JOIN public.stat_definition sd ON sfu.stat_definition_id = sd.id
JOIN public.external_ident ei ON sfu.establishment_id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001' AND sd.code = 'employees' ORDER BY sfu.valid_from, sfu.valid_to, sd.code;
 stat_code | value_int | valid_from |  valid_to  
-----------+-----------+------------+------------
 employees |         2 | 2023-01-01 | 2023-06-30
 employees |         3 | 2023-07-01 | 2023-09-30
(2 rows)

\echo "Tag (expect new tag TestTag.ES.Informal.Updated alongside existing):"
"Tag (expect new tag TestTag.ES.Informal.Updated alongside existing):"
SELECT est.name as est_name, est.valid_from AS est_valid_from, est.valid_to AS est_valid_to,
       (SELECT COALESCE(array_agg(t_sub.path ORDER BY t_sub.path), '{}')
        FROM public.tag_for_unit tfu_sub
        JOIN public.tag t_sub ON tfu_sub.tag_id = t_sub.id
        WHERE tfu_sub.establishment_id = est.id) as tag_paths
FROM public.establishment est
JOIN public.external_ident ei ON est.id = ei.establishment_id AND ei.type_id = (SELECT id FROM external_ident_type WHERE code='tax_ident')
WHERE ei.ident = 'E69C00001'
ORDER BY est.valid_from, est.valid_to;
           est_name           | est_valid_from | est_valid_to |                     tag_paths                     
------------------------------+----------------+--------------+---------------------------------------------------
 ES-69C Period 1              | 2023-01-01     | 2023-03-31   | {TestTag.ES.Informal,TestTag.ES.Informal.Updated}
 ES-69C Period 2 Updated Name | 2023-04-01     | 2023-09-30   | {TestTag.ES.Informal,TestTag.ES.Informal.Updated}
(2 rows)

\echo "Consolidated Statistical Unit view for ES-69C (E69C00001) across all periods:"
"Consolidated Statistical Unit view for ES-69C (E69C00001) across all periods:"
CALL worker.process_tasks(p_queue => 'analytics');
SELECT
    su.name, su.valid_from, su.valid_to,
    su.physical_address_part1, su.physical_postcode, su.physical_region_code,
    su.primary_activity_category_code,
    su.email_address, su.stats->>'employees' as employees, su.tag_paths
FROM public.statistical_unit su
WHERE su.unit_type = 'establishment' AND su.external_idents->>'tax_ident' = 'E69C00001'
ORDER BY su.valid_from, su.valid_to;
             name             | valid_from |  valid_to  | physical_address_part1 | physical_postcode | physical_region_code | primary_activity_category_code |        email_address         | employees |                     tag_paths                     
------------------------------+------------+------------+------------------------+-------------------+----------------------+--------------------------------+------------------------------+-----------+---------------------------------------------------
 ES-69C Period 1              | 2023-01-01 | 2023-03-31 | Addr 1 ES-69C          | 3001              | 0301                 |                                | es69c_p1@example.com         | 2         | {TestTag.ES.Informal,TestTag.ES.Informal.Updated}
 ES-69C Period 2 Updated Name | 2023-04-01 | 2023-06-30 | Addr 2 ES-69C Updated  | 3002              | 0301                 | 03.120                         | es69c_p1@example.com         | 2         | {TestTag.ES.Informal,TestTag.ES.Informal.Updated}
 ES-69C Period 2 Updated Name | 2023-07-01 | 2023-09-30 | Addr 2 ES-69C Updated  | 3002              | 0301                 | 03.120                         | es69c_p3_updated@example.com | 3         | {TestTag.ES.Informal,TestTag.ES.Informal.Updated}
(3 rows)

ROLLBACK TO scenario_69_c_informal_es_lifecycle;
\echo "Final counts after all test blocks for Test 69 (should be same as initial due to rollbacks)"
"Final counts after all test blocks for Test 69 (should be same as initial due to rollbacks)"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

ROLLBACK TO main_test_69_start;
\echo "Test 69 completed and rolled back to main start."
"Test 69 completed and rolled back to main start."
ROLLBACK; -- Final rollback for the entire transaction
