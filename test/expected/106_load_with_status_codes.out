SET datestyle TO 'ISO, DMY';
BEGIN;
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create('test.admin@statbus.org', 'admin_user'::statbus_role, 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create('test.regular@statbus.org', 'regular_user'::statbus_role, 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create('test.restricted@statbus.org', 'restricted_user'::statbus_role, 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

\echo "Setting up Statbus to test enterprise grouping and primary"
"Setting up Statbus to test enterprise grouping and primary"
-- A Super User configures statbus.
CALL test.set_user_from_email('test.admin@statbus.org');
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id,only_one_setting)
SELECT id, true FROM activity_category_standard WHERE code = 'nace_v2.1'
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id =(SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
   WHERE settings.id = EXCLUDED.id;
;
SELECT acs.code
  FROM public.settings AS s
  JOIN activity_category_standard AS acs
    ON s.activity_category_standard_id = acs.id;
   code    
-----------
 nace_v2.1
(1 row)

\echo "User uploads the sample activity categories"
"User uploads the sample activity categories"
\copy public.activity_category_available_custom(path,name,description) FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.activity_category_available;
 count 
-------
  2215
(1 row)

\echo "User uploads the sample regions"
"User uploads the sample regions"
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.region;
 count 
-------
   417
(1 row)

\echo "User uploads the sample legal forms"
"User uploads the sample legal forms"
\copy public.legal_form_custom_only(code,name) FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.legal_form_available;
 count 
-------
    46
(1 row)

\echo "User uploads the sample sectors"
"User uploads the sample sectors"
\copy public.sector_custom_only(path,name,description) FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.sector_available;
 count 
-------
    33
(1 row)

SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |                0 |                0
(1 row)

-- Create Import Job for Legal Units with Status
INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
SELECT
    (SELECT id FROM public.import_definition WHERE slug = 'legal_unit_source_dates'),
    'import_35_lu_era_status',
    'Import LU Era with Status (35_load_with_status_codes.sql)',
    'Import job for test/data/35_norwegian-legal-units-with-status.csv.',
    'Test data load (35_load_with_status_codes.sql)';
\echo "User uploads the legal units (via import job: import_35_lu_era_status)"
"User uploads the legal units (via import job: import_35_lu_era_status)"
\copy public.import_35_lu_era_status_upload(valid_from,valid_to,tax_ident,name,birth_date,death_date,physical_address_part1,physical_postcode,physical_postplace,physical_region_code,physical_country_iso_2,postal_address_part1,postal_postcode,postal_postplace,postal_region_code,postal_country_iso_2,primary_activity_category_code,secondary_activity_category_code,sector_code,legal_form_code,status_code) FROM 'test/data/35_norwegian-legal-units-with-status.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
-- Create Import Job for Establishments with Status
INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
SELECT
    (SELECT id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates'),
    'import_35_esflu_era_status',
    'Import ES Era with Status (35_load_with_status_codes.sql)',
    'Import job for test/data/35_norwegian-establishments-with-status.csv.',
    'Test data load (35_load_with_status_codes.sql)';
\echo "User uploads the establishments (via import job: import_35_esflu_era_status)"
"User uploads the establishments (via import job: import_35_esflu_era_status)"
\copy public.import_35_esflu_era_status_upload(valid_from, valid_to, tax_ident,legal_unit_tax_ident,name,birth_date,death_date,physical_address_part1,physical_postcode,physical_postplace,physical_region_code,physical_country_iso_2,postal_address_part1,postal_postcode,postal_postplace,postal_region_code,postal_country_iso_2,primary_activity_category_code,secondary_activity_category_code,employees,turnover,status_code) FROM 'test/data/35_norwegian-establishments-with-status.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo Run worker processing for import jobs
Run worker processing for import jobs
CALL worker.process_tasks(p_queue => 'import');
SELECT queue, state, count(*) FROM worker.tasks AS t JOIN worker.command_registry AS c ON t.command = c.command WHERE c.queue != 'maintenance' GROUP BY queue,state ORDER BY queue,state;
   queue   |   state   | count 
-----------+-----------+-------
 analytics | pending   |     7
 import    | completed |    94
(2 rows)

\echo "Checking import job statuses"
"Checking import job statuses"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error
FROM public.import_job
WHERE slug LIKE 'import_35_%' ORDER BY slug;
            slug            |  state   | total_rows | imported_rows | has_error 
----------------------------+----------+------------+---------------+-----------
 import_35_esflu_era_status | finished |          4 |             4 | f
 import_35_lu_era_status    | finished |          2 |             2 | f
(2 rows)

\echo Run worker processing for analytics tasks
Run worker processing for analytics tasks
CALL worker.process_tasks(p_queue => 'analytics');
SELECT queue, state, count(*) FROM worker.tasks AS t JOIN worker.command_registry AS c ON t.command = c.command WHERE c.queue != 'maintenance' GROUP BY queue,state ORDER BY queue,state;
   queue   |   state   | count 
-----------+-----------+-------
 analytics | completed |     9
 import    | completed |    94
(2 rows)

SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   3 |                2 |                2
(1 row)

\echo "Checking current statistical units that are included in reports"
"Checking current statistical units that are included in reports"
SELECT valid_from, valid_to, name, unit_type,  jsonb_pretty(stats_summary) AS stats_summary, status_code, include_unit_in_reports
FROM public.statistical_unit
WHERE include_unit_in_reports
AND valid_to = 'infinity'
ORDER BY unit_type, valid_from;
 valid_from | valid_to |       name       |   unit_type   |                stats_summary                 | status_code | include_unit_in_reports 
------------+----------+------------------+---------------+----------------------------------------------+-------------+-------------------------
 2010-01-01 | infinity | Kranl√∏ft Oslo    | establishment | {                                           +| active      | t
            |          |                  |               |     "turnover": {                           +|             | 
            |          |                  |               |         "max": 25000000,                    +|             | 
            |          |                  |               |         "min": 25000000,                    +|             | 
            |          |                  |               |         "sum": 25000000,                    +|             | 
            |          |                  |               |         "mean": 25000000,                   +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0,                        +|             | 
            |          |                  |               |         "variance": 0,                      +|             | 
            |          |                  |               |         "sum_sq_diff": 0,                   +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0   +|             | 
            |          |                  |               |     },                                      +|             | 
            |          |                  |               |     "employees": {                          +|             | 
            |          |                  |               |         "max": 10,                          +|             | 
            |          |                  |               |         "min": 10,                          +|             | 
            |          |                  |               |         "sum": 10,                          +|             | 
            |          |                  |               |         "mean": 10,                         +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0,                        +|             | 
            |          |                  |               |         "variance": 0,                      +|             | 
            |          |                  |               |         "sum_sq_diff": 0,                   +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0   +|             | 
            |          |                  |               |     }                                       +|             | 
            |          |                  |               | }                                            |             | 
 2011-01-01 | infinity | Kranl√∏ft √òstland | legal_unit    | {                                           +| active      | t
            |          |                  |               |     "turnover": {                           +|             | 
            |          |                  |               |         "max": 25000000,                    +|             | 
            |          |                  |               |         "min": 25000000,                    +|             | 
            |          |                  |               |         "sum": 25000000,                    +|             | 
            |          |                  |               |         "mean": 25000000.00,                +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0.00,                     +|             | 
            |          |                  |               |         "variance": 0.00,                   +|             | 
            |          |                  |               |         "sum_sq_diff": 0.00,                +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0.00+|             | 
            |          |                  |               |     },                                      +|             | 
            |          |                  |               |     "employees": {                          +|             | 
            |          |                  |               |         "max": 10,                          +|             | 
            |          |                  |               |         "min": 10,                          +|             | 
            |          |                  |               |         "sum": 10,                          +|             | 
            |          |                  |               |         "mean": 10.00,                      +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0.00,                     +|             | 
            |          |                  |               |         "variance": 0.00,                   +|             | 
            |          |                  |               |         "sum_sq_diff": 0.00,                +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0.00+|             | 
            |          |                  |               |     }                                       +|             | 
            |          |                  |               | }                                            |             | 
 2011-01-01 | infinity | Kranl√∏ft √òstland | enterprise    | {                                           +| active      | t
            |          |                  |               |     "turnover": {                           +|             | 
            |          |                  |               |         "max": 25000000,                    +|             | 
            |          |                  |               |         "min": 25000000,                    +|             | 
            |          |                  |               |         "sum": 25000000,                    +|             | 
            |          |                  |               |         "mean": 25000000.00,                +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0.00,                     +|             | 
            |          |                  |               |         "variance": 0.00,                   +|             | 
            |          |                  |               |         "sum_sq_diff": 0.00,                +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0.00+|             | 
            |          |                  |               |     },                                      +|             | 
            |          |                  |               |     "employees": {                          +|             | 
            |          |                  |               |         "max": 10,                          +|             | 
            |          |                  |               |         "min": 10,                          +|             | 
            |          |                  |               |         "sum": 10,                          +|             | 
            |          |                  |               |         "mean": 10.00,                      +|             | 
            |          |                  |               |         "type": "number",                   +|             | 
            |          |                  |               |         "count": 1,                         +|             | 
            |          |                  |               |         "stddev": 0.00,                     +|             | 
            |          |                  |               |         "variance": 0.00,                   +|             | 
            |          |                  |               |         "sum_sq_diff": 0.00,                +|             | 
            |          |                  |               |         "coefficient_of_variation_pct": 0.00+|             | 
            |          |                  |               |     }                                       +|             | 
            |          |                  |               | }                                            |             | 
(3 rows)

\echo "Testing statistical unit drilldown - should only include units that have include_unit_in_reports set to true"
"Testing statistical unit drilldown - should only include units that have include_unit_in_reports set to true"
SELECT jsonb_pretty(public.remove_ephemeral_data_from_hierarchy(public.statistical_unit_facet_drilldown(
     valid_on := '2025-01-01'
)))
    AS statistical_unit_facet_drilldown;
               statistical_unit_facet_drilldown               
--------------------------------------------------------------
 {                                                           +
     "stats": {                                              +
         "count": 1,                                         +
         "stats_summary": {                                  +
             "turnover": {                                   +
                 "max": 25000000,                            +
                 "min": 25000000,                            +
                 "sum": 25000000,                            +
                 "mean": 25000000.00,                        +
                 "type": "number",                           +
                 "count": 1,                                 +
                 "stddev": 0.00,                             +
                 "variance": 0.00,                           +
                 "sum_sq_diff": 0.00,                        +
                 "coefficient_of_variation_pct": 0.00        +
             },                                              +
             "employees": {                                  +
                 "max": 10,                                  +
                 "min": 10,                                  +
                 "sum": 10,                                  +
                 "mean": 10.00,                              +
                 "type": "number",                           +
                 "count": 1,                                 +
                 "stddev": 0.00,                             +
                 "variance": 0.00,                           +
                 "sum_sq_diff": 0.00,                        +
                 "coefficient_of_variation_pct": 0.00        +
             }                                               +
         }                                                   +
     },                                                      +
     "filter": {                                             +
         "valid_on": "2025-01-01",                           +
         "unit_type": "enterprise",                          +
         "region_path": null,                                +
         "sector_path": null,                                +
         "activity_category_path": null                      +
     },                                                      +
     "available": {                                          +
         "region": [                                         +
             {                                               +
                 "code": "11",                               +
                 "name": "Rogaland",                         +
                 "path": "11",                               +
                 "count": 1,                                 +
                 "label": "11",                              +
                 "has_children": true,                       +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ],                                                  +
         "sector": [                                         +
             {                                               +
                 "code": null,                               +
                 "name": "Innenlandske sektorer",            +
                 "path": "innl",                             +
                 "count": 1,                                 +
                 "label": "innl",                            +
                 "has_children": true,                       +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ],                                                  +
         "status": [                                         +
             {                                               +
                 "code": "active",                           +
                 "name": "Active",                           +
                 "count": 1,                                 +
                 "has_children": false,                      +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ],                                                  +
         "country": [                                        +
             {                                               +
                 "name": "Norway",                           +
                 "count": 1,                                 +
                 "iso_2": "NO",                              +
                 "has_children": false,                      +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ],                                                  +
         "legal_form": [                                     +
             {                                               +
                 "code": "AS",                               +
                 "name": "Aksjeselskap",                     +
                 "count": 1,                                 +
                 "has_children": false,                      +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ],                                                  +
         "activity_category": [                              +
             {                                               +
                 "code": "",                                 +
                 "name": "Transport og lagring",             +
                 "path": "H",                                +
                 "count": 1,                                 +
                 "label": "H",                               +
                 "has_children": true,                       +
                 "stats_summary": {                          +
                     "turnover": {                           +
                         "max": 25000000,                    +
                         "min": 25000000,                    +
                         "sum": 25000000,                    +
                         "mean": 25000000.00,                +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     },                                      +
                     "employees": {                          +
                         "max": 10,                          +
                         "min": 10,                          +
                         "sum": 10,                          +
                         "mean": 10.00,                      +
                         "type": "number",                   +
                         "count": 1,                         +
                         "stddev": 0.00,                     +
                         "variance": 0.00,                   +
                         "sum_sq_diff": 0.00,                +
                         "coefficient_of_variation_pct": 0.00+
                     }                                       +
                 }                                           +
             }                                               +
         ]                                                   +
     },                                                      +
     "unit_type": "enterprise",                              +
     "breadcrumb": {                                         +
         "region": null,                                     +
         "sector": null,                                     +
         "status": null,                                     +
         "country": null,                                    +
         "legal_form": null,                                 +
         "activity_category": null                           +
     }                                                       +
 }
(1 row)

\echo "Test statistical unit history by year"
"Test statistical unit history by year"
SELECT resolution, year, unit_type, count, births, deaths
FROM public.statistical_history
WHERE resolution = 'year'
AND year < 2013
ORDER BY year,unit_type;
 resolution | year |   unit_type   | count | births | deaths 
------------+------+---------------+-------+--------+--------
 year       | 2010 | establishment |     2 |      2 |      0
 year       | 2010 | legal_unit    |     1 |      1 |      0
 year       | 2010 | enterprise    |     1 |      1 |      0
 year       | 2011 | establishment |     1 |      0 |      0
 year       | 2011 | legal_unit    |     1 |      0 |      0
 year       | 2011 | enterprise    |     1 |      0 |      0
 year       | 2012 | establishment |     1 |      0 |      0
 year       | 2012 | legal_unit    |     1 |      0 |      0
 year       | 2012 | enterprise    |     1 |      0 |      0
(9 rows)

SELECT jsonb_pretty(public.remove_ephemeral_data_from_hierarchy(public.statistical_history_drilldown(
    year_min := 2010,
    year_max := 2011
)))
    AS statistical_history_drilldown;
               statistical_history_drilldown               
-----------------------------------------------------------
 {                                                        +
     "stats": [                                           +
         {                                                +
             "year": 2010,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 1,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 12000000,                     +
                     "sum": 37000000,                     +
                     "mean": 18500000.00,                 +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 9192388.16,                +
                     "variance": 84500000000000.00,       +
                     "sum_sq_diff": 84500000000000.00,    +
                     "coefficient_of_variation_pct": 49.69+
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 7,                            +
                     "sum": 17,                           +
                     "mean": 8.50,                        +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 2.12,                      +
                     "variance": 4.50,                    +
                     "sum_sq_diff": 4.50,                 +
                     "coefficient_of_variation_pct": 24.96+
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2011,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         }                                                +
     ],                                                   +
     "filter": {                                          +
         "type": "year",                                  +
         "year": null,                                    +
         "unit_type": "enterprise",                       +
         "region_path": null,                             +
         "sector_path": null,                             +
         "activity_category_path": null                   +
     },                                                   +
     "available": {                                       +
         "region": [                                      +
             {                                            +
                 "code": "11",                            +
                 "name": "Rogaland",                      +
                 "path": "11",                            +
                 "count": 2,                              +
                 "label": "11",                           +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "sector": [                                      +
             {                                            +
                 "code": null,                            +
                 "name": "Innenlandske sektorer",         +
                 "path": "innl",                          +
                 "count": 2,                              +
                 "label": "innl",                         +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "status": [                                      +
             {                                            +
                 "code": "active",                        +
                 "name": "Active",                        +
                 "count": 2,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "country": [                                     +
             {                                            +
                 "name": "Norway",                        +
                 "count": 2,                              +
                 "iso_2": "NO",                           +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "legal_form": [                                  +
             {                                            +
                 "code": "AS",                            +
                 "name": "Aksjeselskap",                  +
                 "count": 2,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "activity_category": [                           +
             {                                            +
                 "code": "",                              +
                 "name": "Transport og lagring",          +
                 "path": "H",                             +
                 "count": 2,                              +
                 "label": "H",                            +
                 "has_children": true                     +
             }                                            +
         ]                                                +
     },                                                   +
     "unit_type": "enterprise",                           +
     "breadcrumb": {                                      +
         "region": null,                                  +
         "sector": null,                                  +
         "status": null,                                  +
         "country": null,                                 +
         "legal_form": null,                              +
         "activity_category": null                        +
     }                                                    +
 }
(1 row)

    \echo "Test yearly drilldown - enterprise"
"Test yearly drilldown - enterprise"
SELECT jsonb_pretty(
     public.remove_ephemeral_data_from_hierarchy(
     public.statistical_history_drilldown(
          unit_type := 'enterprise'::public.statistical_unit_type,
          resolution := 'year'::public.history_resolution,
          year := NULL::INTEGER,
          region_path := NULL::public.ltree,
          activity_category_path := NULL::public.ltree,
          sector_path := NULL::public.ltree,
          legal_form_id := NULL::INTEGER,
          country_id := NULL::INTEGER,
          year_min := 2010,
          year_max := 2012
     ))) AS statistical_history_drilldown;
               statistical_history_drilldown               
-----------------------------------------------------------
 {                                                        +
     "stats": [                                           +
         {                                                +
             "year": 2010,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 1,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 12000000,                     +
                     "sum": 37000000,                     +
                     "mean": 18500000.00,                 +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 9192388.16,                +
                     "variance": 84500000000000.00,       +
                     "sum_sq_diff": 84500000000000.00,    +
                     "coefficient_of_variation_pct": 49.69+
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 7,                            +
                     "sum": 17,                           +
                     "mean": 8.50,                        +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 2.12,                      +
                     "variance": 4.50,                    +
                     "sum_sq_diff": 4.50,                 +
                     "coefficient_of_variation_pct": 24.96+
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2011,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2012,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         }                                                +
     ],                                                   +
     "filter": {                                          +
         "type": "year",                                  +
         "year": null,                                    +
         "unit_type": "enterprise",                       +
         "region_path": null,                             +
         "sector_path": null,                             +
         "activity_category_path": null                   +
     },                                                   +
     "available": {                                       +
         "region": [                                      +
             {                                            +
                 "code": "11",                            +
                 "name": "Rogaland",                      +
                 "path": "11",                            +
                 "count": 3,                              +
                 "label": "11",                           +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "sector": [                                      +
             {                                            +
                 "code": null,                            +
                 "name": "Innenlandske sektorer",         +
                 "path": "innl",                          +
                 "count": 3,                              +
                 "label": "innl",                         +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "status": [                                      +
             {                                            +
                 "code": "active",                        +
                 "name": "Active",                        +
                 "count": 3,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "country": [                                     +
             {                                            +
                 "name": "Norway",                        +
                 "count": 3,                              +
                 "iso_2": "NO",                           +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "legal_form": [                                  +
             {                                            +
                 "code": "AS",                            +
                 "name": "Aksjeselskap",                  +
                 "count": 3,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "activity_category": [                           +
             {                                            +
                 "code": "",                              +
                 "name": "Transport og lagring",          +
                 "path": "H",                             +
                 "count": 3,                              +
                 "label": "H",                            +
                 "has_children": true                     +
             }                                            +
         ]                                                +
     },                                                   +
     "unit_type": "enterprise",                           +
     "breadcrumb": {                                      +
         "region": null,                                  +
         "sector": null,                                  +
         "status": null,                                  +
         "country": null,                                 +
         "legal_form": null,                              +
         "activity_category": null                        +
     }                                                    +
 }
(1 row)

\echo "Test yearly drilldown - legal_unit"
"Test yearly drilldown - legal_unit"
SELECT jsonb_pretty(
     public.remove_ephemeral_data_from_hierarchy(
     public.statistical_history_drilldown(
          unit_type := 'legal_unit'::public.statistical_unit_type,
          resolution := 'year'::public.history_resolution,
          year := NULL::INTEGER,
          region_path := NULL::public.ltree,
          activity_category_path := NULL::public.ltree,
          sector_path := NULL::public.ltree,
          legal_form_id := NULL::INTEGER,
          country_id := NULL::INTEGER,
          year_min := 2010,
          year_max := 2012
     ))) AS statistical_history_drilldown;
               statistical_history_drilldown               
-----------------------------------------------------------
 {                                                        +
     "stats": [                                           +
         {                                                +
             "year": 2010,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 1,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 12000000,                     +
                     "sum": 37000000,                     +
                     "mean": 18500000.00,                 +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 9192388.16,                +
                     "variance": 84500000000000.00,       +
                     "sum_sq_diff": 84500000000000.00,    +
                     "coefficient_of_variation_pct": 49.69+
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 7,                            +
                     "sum": 17,                           +
                     "mean": 8.50,                        +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 2.12,                      +
                     "variance": 4.50,                    +
                     "sum_sq_diff": 4.50,                 +
                     "coefficient_of_variation_pct": 24.96+
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2011,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2012,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         }                                                +
     ],                                                   +
     "filter": {                                          +
         "type": "year",                                  +
         "year": null,                                    +
         "unit_type": "legal_unit",                       +
         "region_path": null,                             +
         "sector_path": null,                             +
         "activity_category_path": null                   +
     },                                                   +
     "available": {                                       +
         "region": [                                      +
             {                                            +
                 "code": "11",                            +
                 "name": "Rogaland",                      +
                 "path": "11",                            +
                 "count": 3,                              +
                 "label": "11",                           +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "sector": [                                      +
             {                                            +
                 "code": null,                            +
                 "name": "Innenlandske sektorer",         +
                 "path": "innl",                          +
                 "count": 3,                              +
                 "label": "innl",                         +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "status": [                                      +
             {                                            +
                 "code": "active",                        +
                 "name": "Active",                        +
                 "count": 3,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "country": [                                     +
             {                                            +
                 "name": "Norway",                        +
                 "count": 3,                              +
                 "iso_2": "NO",                           +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "legal_form": [                                  +
             {                                            +
                 "code": "AS",                            +
                 "name": "Aksjeselskap",                  +
                 "count": 3,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "activity_category": [                           +
             {                                            +
                 "code": "",                              +
                 "name": "Transport og lagring",          +
                 "path": "H",                             +
                 "count": 3,                              +
                 "label": "H",                            +
                 "has_children": true                     +
             }                                            +
         ]                                                +
     },                                                   +
     "unit_type": "legal_unit",                           +
     "breadcrumb": {                                      +
         "region": null,                                  +
         "sector": null,                                  +
         "status": null,                                  +
         "country": null,                                 +
         "legal_form": null,                              +
         "activity_category": null                        +
     }                                                    +
 }
(1 row)

\echo "Test yearly drilldown - establishment"
"Test yearly drilldown - establishment"
SELECT jsonb_pretty(
     public.remove_ephemeral_data_from_hierarchy(
     public.statistical_history_drilldown(
          unit_type := 'establishment'::public.statistical_unit_type,
          resolution := 'year'::public.history_resolution,
          year := NULL::INTEGER,
          region_path := NULL::public.ltree,
          activity_category_path := NULL::public.ltree,
          sector_path := NULL::public.ltree,
          legal_form_id := NULL::INTEGER,
          country_id := NULL::INTEGER,
          year_min := 2010,
          year_max := 2012
     ))) AS statistical_history_drilldown;
               statistical_history_drilldown               
-----------------------------------------------------------
 {                                                        +
     "stats": [                                           +
         {                                                +
             "year": 2010,                                +
             "count": 2,                                  +
             "month": null,                               +
             "births": 2,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 12000000,                     +
                     "sum": 37000000,                     +
                     "mean": 18500000.00,                 +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 9192388.16,                +
                     "variance": 84500000000000.00,       +
                     "sum_sq_diff": 84500000000000.00,    +
                     "coefficient_of_variation_pct": 49.69+
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 7,                            +
                     "sum": 17,                           +
                     "mean": 8.50,                        +
                     "type": "number",                    +
                     "count": 2,                          +
                     "stddev": 2.12,                      +
                     "variance": 4.50,                    +
                     "sum_sq_diff": 4.50,                 +
                     "coefficient_of_variation_pct": 24.96+
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2011,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         },                                               +
         {                                                +
             "year": 2012,                                +
             "count": 1,                                  +
             "month": null,                               +
             "births": 0,                                 +
             "deaths": 0,                                 +
             "stats_summary": {                           +
                 "turnover": {                            +
                     "max": 25000000,                     +
                     "min": 25000000,                     +
                     "sum": 25000000,                     +
                     "mean": 25000000.00,                 +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 },                                       +
                 "employees": {                           +
                     "max": 10,                           +
                     "min": 10,                           +
                     "sum": 10,                           +
                     "mean": 10.00,                       +
                     "type": "number",                    +
                     "count": 1,                          +
                     "stddev": 0.00,                      +
                     "variance": 0.00,                    +
                     "sum_sq_diff": 0.00,                 +
                     "coefficient_of_variation_pct": 0.00 +
                 }                                        +
             },                                           +
             "sector_change_count": 0,                    +
             "legal_form_change_count": 0,                +
             "physical_region_change_count": 0,           +
             "physical_country_change_count": 0,          +
             "primary_activity_category_change_count": 0  +
         }                                                +
     ],                                                   +
     "filter": {                                          +
         "type": "year",                                  +
         "year": null,                                    +
         "unit_type": "establishment",                    +
         "region_path": null,                             +
         "sector_path": null,                             +
         "activity_category_path": null                   +
     },                                                   +
     "available": {                                       +
         "region": [                                      +
             {                                            +
                 "code": "11",                            +
                 "name": "Rogaland",                      +
                 "path": "11",                            +
                 "count": 4,                              +
                 "label": "11",                           +
                 "has_children": true                     +
             }                                            +
         ],                                               +
         "sector": null,                                  +
         "status": [                                      +
             {                                            +
                 "code": "active",                        +
                 "name": "Active",                        +
                 "count": 4,                              +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "country": [                                     +
             {                                            +
                 "name": "Norway",                        +
                 "count": 4,                              +
                 "iso_2": "NO",                           +
                 "has_children": false                    +
             }                                            +
         ],                                               +
         "legal_form": null,                              +
         "activity_category": [                           +
             {                                            +
                 "code": "",                              +
                 "name": "Transport og lagring",          +
                 "path": "H",                             +
                 "count": 4,                              +
                 "label": "H",                            +
                 "has_children": true                     +
             }                                            +
         ]                                                +
     },                                                   +
     "unit_type": "establishment",                        +
     "breadcrumb": {                                      +
         "region": null,                                  +
         "sector": null,                                  +
         "status": null,                                  +
         "country": null,                                 +
         "legal_form": null,                              +
         "activity_category": null                        +
     }                                                    +
 }
(1 row)

ROLLBACK;
