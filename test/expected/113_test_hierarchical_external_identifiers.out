SET datestyle TO 'ISO, DMY';
BEGIN;
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create(p_display_name => 'Test Admin', p_email => 'test.admin@statbus.org', p_statbus_role => 'admin_user'::statbus_role, p_password => 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Regular', p_email => 'test.regular@statbus.org', p_statbus_role => 'regular_user'::statbus_role, p_password => 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Restricted', p_email => 'test.restricted@statbus.org', p_statbus_role => 'restricted_user'::statbus_role, p_password => 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

CREATE OR REPLACE PROCEDURE test.remove_pg_temp_for_tx_user_switch(p_keep_tables text[] DEFAULT '{}')
LANGUAGE plpgsql
AS $remove_pg_temp_for_tx_user_switch$
DECLARE
    rec record;
    v_found_count integer := 0;
BEGIN
    RAISE DEBUG 'Running test.remove_pg_temp_for_tx_user_switch(p_keep_tables => %)...', p_keep_tables;
    -- Remove temporary cache tables used by import, as we switch user inside the *same* transaction,
    -- and the new user can not modify tables owned by the previous import.
    -- This generic loop cleans up all tables and views in the pg_temp schema, except those specified to keep.
    FOR rec IN
        SELECT
            c.relname,
            c.relkind
        FROM pg_catalog.pg_class AS c
        LEFT JOIN pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace
        WHERE c.relkind IN ('r', 'p', 'v', 'm') AND n.oid = pg_my_temp_schema() -- r=table, p=partitioned, v=view, m=materialized
          AND c.relname <> ALL(p_keep_tables)
    LOOP
        v_found_count := v_found_count + 1;
        IF rec.relkind IN ('r', 'p', 'm') THEN
            RAISE DEBUG '  -> Dropping temp TABLE %', rec.relname;
            EXECUTE format('DROP TABLE IF EXISTS pg_temp.%I CASCADE', rec.relname);
        ELSIF rec.relkind = 'v' THEN
            RAISE DEBUG '  -> Dropping temp VIEW %', rec.relname;
            EXECUTE format('DROP VIEW IF EXISTS pg_temp.%I CASCADE', rec.relname);
        END IF;
    END LOOP;

    RAISE DEBUG '...finished test.remove_pg_temp_for_tx_user_switch(). Found and dropped % objects.', v_found_count;

    -- This procedure is part of the sql_saga extension and has its own cleanup logic.
    -- While the loop above handles tables/views, this call ensures any other temporary
    -- objects it creates are also cleaned up.
    CALL sql_saga.temporal_merge_drop_temp_tables();
END;
$remove_pg_temp_for_tx_user_switch$;
\echo "Test 113: Hierarchical External Identifiers - Basic Functionality"
"Test 113: Hierarchical External Identifiers - Basic Functionality"
\echo "Testing hierarchical external identifier constraints, validation, and queries"
"Testing hierarchical external identifier constraints, validation, and queries"
-- A Super User configures statbus.
CALL test.set_user_from_email('test.admin@statbus.org');
\i samples/norway/getting-started.sql
\i samples/norway/settings.sql
INSERT INTO settings(activity_category_standard_id,country_id)
SELECT (SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
     , (SELECT id FROM public.country WHERE iso_2 = 'NO')
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id = EXCLUDED.activity_category_standard_id,
   country_id = EXCLUDED.country_id
   WHERE settings.only_one_setting = EXCLUDED.only_one_setting;
;
\i samples/norway/activity_category/activity_category_norway.sql
\copy public.activity_category_available_custom FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/regions/norway-regions-2024.sql
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/sector/sector_norway.sql
\copy public.sector_custom_only FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/legal_form/legal_form_norway.sql
\copy public.legal_form_custom_only FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/data_source/data_source_norway.sql
\copy public.data_source_custom (code, name) FROM 'samples/norway/data_source/data_source_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT acs.code FROM public.settings AS s JOIN activity_category_standard AS acs ON s.activity_category_standard_id = acs.id;
   code    
-----------
 nace_v2.1
(1 row)

SAVEPOINT main_test_113_start;
\echo "Initial counts before any test block for Test 113"
"Initial counts before any test block for Test 113"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

-- ============================================================================
-- Test 113.1: Hierarchical External Identifiers - Basic Setup and Constraints
-- ============================================================================
\echo "=============================================================="
"=============================================================="
\echo "Test 113.1: Hierarchical External Identifiers - Basic Setup"
"Test 113.1: Hierarchical External Identifiers - Basic Setup"
\echo "=============================================================="
"=============================================================="
SAVEPOINT scenario_113_1_hierarchical_setup;
-- Setup: Create hierarchical identifier types
\echo "Setting up hierarchical identifier types"
"Setting up hierarchical identifier types"
INSERT INTO public.external_ident_type (code, name, shape, labels, description, priority, archived)
VALUES ('test_surveyor_hierarchical', 'Test Surveyor Hierarchical', 'hierarchical', 'region.city.seq',
        'Region/City/Seq hierarchical composite key', 50, false);
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_test_surveyor_hierarchical for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
INSERT INTO public.external_ident_type (code, name, shape, labels, description, priority, archived)
VALUES ('region_district', 'Regional District Code', 'hierarchical', 'region.district',
        'Simple 2-level regional district identifier', 51, false);
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_ei_test_surveyor_hierarchical_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_test_surveyor_hierarchical for external_ident_type
NOTICE:  Created index su_ei_region_district for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
-- Verify the hierarchical setup
\echo "Verifying hierarchical setup:"
"Verifying hierarchical setup:"
SELECT eit.code, eit.shape, eit.labels, eit.priority
FROM public.external_ident_type eit
WHERE eit.code IN ('test_surveyor_hierarchical', 'region_district')
ORDER BY eit.priority;
            code            |    shape     |     labels      | priority 
----------------------------+--------------+-----------------+----------
 test_surveyor_hierarchical | hierarchical | region.city.seq |       50
 region_district            | hierarchical | region.district |       51
(2 rows)

ROLLBACK TO scenario_113_1_hierarchical_setup;
-- ============================================================================
-- Test 113.2: Hierarchical External Identifiers - Constraint Validation (Error Cases)
-- ============================================================================
\echo "=============================================================="
"=============================================================="
\echo "Test 113.2: Hierarchical Constraint Validation - Error Cases"
"Test 113.2: Hierarchical Constraint Validation - Error Cases"
\echo "=============================================================="
"=============================================================="
SAVEPOINT scenario_113_2_hierarchical_constraints;
-- Setup: Create a hierarchical identifier type (Uganda-style: region.city.seq)
\echo "Setting up hierarchical identifier type for constraint testing"
"Setting up hierarchical identifier type for constraint testing"
INSERT INTO public.external_ident_type (code, name, description, priority, shape, labels)
VALUES ('test_surveyor', 'Test Surveyor Hierarchical', 'Region/City/Seq hierarchical identifier', 50, 'hierarchical', 'region.city.seq');
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_test_surveyor for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
-- Verify the hierarchical setup
\echo "Verifying hierarchical setup:"
"Verifying hierarchical setup:"
SELECT code, shape, labels, priority
FROM public.external_ident_type
WHERE code = 'test_surveyor';
     code      |    shape     |     labels      | priority 
---------------+--------------+-----------------+----------
 test_surveyor | hierarchical | region.city.seq |       50
(1 row)

-- Test 113.2.1: Invalid hierarchical identifier depth mismatch (should fail due to constraint)
\echo "Test 113.2.1: Attempting to insert hierarchical identifier with depth mismatch (should fail):"
"Test 113.2.1: Attempting to insert hierarchical identifier with depth mismatch (should fail):"
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_surveyor_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_surveyor_type_id FROM public.external_ident_type WHERE code = 'test_surveyor';
    
    -- Create a legal unit
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT HierTest', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU Hierarchical', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    
    -- Try to insert hierarchical identifier with wrong depth (2 levels vs required 3) - should fail
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, labels, shape, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_surveyor_type_id, 'north.kampala', 'region.city', 'hierarchical', v_user_id, now());
    
    RAISE EXCEPTION 'ERROR: Depth mismatch should have been prevented!';
EXCEPTION WHEN OTHERS THEN
    IF SQLERRM LIKE '%hierarchical_depth_valid%' THEN
        RAISE NOTICE 'Test 113.2.1: Correctly caught hierarchical depth constraint violation';
    ELSE
        RAISE NOTICE 'Test 113.2.1: Hierarchical identifier validation error: %', SQLERRM;
    END IF;
END $$;
NOTICE:  Test 113.2.1: Correctly caught hierarchical depth constraint violation
-- Test 113.2.2: Valid hierarchical identifier (should succeed)
\echo "Test 113.2.2: Inserting valid hierarchical identifier:"
"Test 113.2.2: Inserting valid hierarchical identifier:"
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_surveyor_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_surveyor_type_id FROM public.external_ident_type WHERE code = 'test_surveyor';
    
    -- Create a legal unit
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT HierValid', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU Valid Hierarchical', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    
    -- Insert complete hierarchical identifier
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, labels, shape, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_surveyor_type_id, 'north.kampala.001', 'region.city.seq', 'hierarchical', v_user_id, now());
    
    RAISE NOTICE 'Test 113.2.2: Valid hierarchical identifier inserted successfully';
EXCEPTION WHEN OTHERS THEN
    RAISE NOTICE 'Test 113.2.2: Unexpected error: %', SQLERRM;
END $$;
NOTICE:  Test 113.2.2: Valid hierarchical identifier inserted successfully
-- Test 113.2.3: Test shape/labels consistency constraint
\echo "Test 113.2.3: Testing shape/labels consistency constraint:"
"Test 113.2.3: Testing shape/labels consistency constraint:"
DO $$
BEGIN
    -- Try to create regular identifier type with labels (should fail)
    INSERT INTO public.external_ident_type (code, name, description, priority, shape, labels)
    VALUES ('test_invalid', 'Test Invalid', 'Should fail', 60, 'regular', 'some.labels');
    
    RAISE EXCEPTION 'ERROR: Regular identifier with labels should have been prevented!';
EXCEPTION WHEN OTHERS THEN
    IF SQLERRM LIKE '%shape_labels_consistency%' OR SQLERRM LIKE '%violates check constraint%' THEN
        RAISE NOTICE 'Test 113.2.3a: Correctly caught regular+labels constraint violation';
    ELSE
        RAISE NOTICE 'Test 113.2.3a: Unexpected error: %', SQLERRM;
    END IF;
END $$;
NOTICE:  Test 113.2.3a: Correctly caught regular+labels constraint violation
DO $$
BEGIN
    -- Try to create hierarchical identifier type without labels (should fail)
    INSERT INTO public.external_ident_type (code, name, description, priority, shape, labels)
    VALUES ('test_invalid2', 'Test Invalid 2', 'Should fail', 61, 'hierarchical', NULL);
    
    RAISE EXCEPTION 'ERROR: Hierarchical identifier without labels should have been prevented!';
EXCEPTION WHEN OTHERS THEN
    IF SQLERRM LIKE '%shape_labels_consistency%' OR SQLERRM LIKE '%violates check constraint%' THEN
        RAISE NOTICE 'Test 113.2.3b: Correctly caught hierarchical+no labels constraint violation';
    ELSE
        RAISE NOTICE 'Test 113.2.3b: Unexpected error: %', SQLERRM;
    END IF;
END $$;
NOTICE:  Test 113.2.3b: Correctly caught hierarchical+no labels constraint violation
ROLLBACK TO scenario_113_2_hierarchical_constraints;
-- ============================================================================
-- Test 113.3: Hierarchical External Identifiers - Happy Path Testing
-- ============================================================================
\echo "=============================================================="
"=============================================================="
\echo "Test 113.3: Hierarchical External Identifiers - Happy Path"
"Test 113.3: Hierarchical External Identifiers - Happy Path"
\echo "=============================================================="
"=============================================================="
SAVEPOINT scenario_113_3_hierarchical_happy_path;
-- Setup: Create hierarchical identifier types
\echo "Setting up hierarchical identifier types"
"Setting up hierarchical identifier types"
INSERT INTO public.external_ident_type (code, name, shape, labels, description, priority, archived)
VALUES ('test_hierarchical_surveyor', 'Test Hierarchical Surveyor', 'hierarchical', 'region.city.seq',
        'Region/City/Seq hierarchical composite key', 50, false);
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_test_hierarchical_surveyor for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
INSERT INTO public.external_ident_type (code, name, shape, labels, description, priority, archived)
VALUES ('region_district', 'Regional District Code', 'hierarchical', 'region.district',
        'Simple 2-level regional district identifier for success test', 51, false);
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_ei_test_hierarchical_surveyor_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_test_hierarchical_surveyor for external_ident_type
NOTICE:  Created index su_ei_region_district for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
-- Verify the hierarchical setup
\echo "Verifying hierarchical setup:"
"Verifying hierarchical setup:"
SELECT eit.code, eit.shape, eit.labels, eit.priority
FROM public.external_ident_type eit
WHERE eit.code IN ('test_hierarchical_surveyor', 'region_district')
ORDER BY eit.priority;
            code            |    shape     |     labels      | priority 
----------------------------+--------------+-----------------+----------
 test_hierarchical_surveyor | hierarchical | region.city.seq |       50
 region_district            | hierarchical | region.district |       51
(2 rows)

-- Test: Create legal units with hierarchical identifiers
\echo "Creating test legal units with hierarchical identifiers"
"Creating test legal units with hierarchical identifiers"
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_hier_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_hier_type_id FROM public.external_ident_type WHERE code = 'test_hierarchical_surveyor';
    
    -- LU1: NORTH.KAMPALA.001
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT NK 001', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU North Kampala 001', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_hier_type_id, 'NORTH.KAMPALA.001'::ltree, v_user_id, now());
    
    -- LU2: NORTH.KAMPALA.002 (same region/city, different seq - VALID)
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT NK 002', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU North Kampala 002', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_hier_type_id, 'NORTH.KAMPALA.002'::ltree, v_user_id, now());
    
    -- LU3: SOUTH.ENTEBBE.001 (different region/city, same seq - VALID)
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT SE 001', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'LU South Entebbe 001', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_hier_type_id, 'SOUTH.ENTEBBE.001'::ltree, v_user_id, now());
    
END $$;
-- Verify hierarchical identifiers were stored correctly
\echo "Verifying hierarchical identifiers stored correctly:"
"Verifying hierarchical identifiers stored correctly:"
SELECT 
    ei.idents,
    ei.labels,
    eit.code as type_code,
    eit.shape,
    nlevel(ei.idents) as actual_depth,
    nlevel(ei.labels) as expected_depth,
    lu.name as legal_unit_name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
ORDER BY lu.name;
      idents       |     labels      |         type_code          |    shape     | actual_depth | expected_depth |   legal_unit_name    
-------------------+-----------------+----------------------------+--------------+--------------+----------------+----------------------
 NORTH.KAMPALA.001 | region.city.seq | test_hierarchical_surveyor | hierarchical |            3 |              3 | LU North Kampala 001
 NORTH.KAMPALA.002 | region.city.seq | test_hierarchical_surveyor | hierarchical |            3 |              3 | LU North Kampala 002
 SOUTH.ENTEBBE.001 | region.city.seq | test_hierarchical_surveyor | hierarchical |            3 |              3 | LU South Entebbe 001
(3 rows)

-- Test hierarchical queries: find all units in NORTH region
\echo "Testing hierarchical queries - all units in NORTH region:"
"Testing hierarchical queries - all units in NORTH region:"
SELECT 
    ei.idents,
    lu.name as legal_unit_name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
  AND ei.idents ~ 'NORTH.*'::lquery
ORDER BY ei.idents;
      idents       |   legal_unit_name    
-------------------+----------------------
 NORTH.KAMPALA.001 | LU North Kampala 001
 NORTH.KAMPALA.002 | LU North Kampala 002
(2 rows)

-- Test hierarchical queries: find all units in NORTH.KAMPALA district
\echo "Testing hierarchical queries - all units in NORTH.KAMPALA district:"
"Testing hierarchical queries - all units in NORTH.KAMPALA district:"
SELECT 
    ei.idents,
    lu.name as legal_unit_name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
  AND ei.idents ~ 'NORTH.KAMPALA.*'::lquery
ORDER BY ei.idents;
      idents       |   legal_unit_name    
-------------------+----------------------
 NORTH.KAMPALA.001 | LU North Kampala 001
 NORTH.KAMPALA.002 | LU North Kampala 002
(2 rows)

-- Verify uniqueness: each complete hierarchical path is unique
\echo "Verifying uniqueness: each hierarchical identifier is unique:"
"Verifying uniqueness: each hierarchical identifier is unique:"
SELECT 
    ei.idents as hierarchical_key,
    COUNT(*) as occurrences,
    array_agg(DISTINCT lu.name) as legal_units
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
GROUP BY ei.idents
ORDER BY ei.idents;
 hierarchical_key  | occurrences |       legal_units        
-------------------+-------------+--------------------------
 NORTH.KAMPALA.001 |           1 | {"LU North Kampala 001"}
 NORTH.KAMPALA.002 |           1 | {"LU North Kampala 002"}
 SOUTH.ENTEBBE.001 |           1 | {"LU South Entebbe 001"}
(3 rows)

-- Test successful insertion of different hierarchical identifier type
\echo "Testing successful insertion of 2-level hierarchical identifier:"
"Testing successful insertion of 2-level hierarchical identifier:"
DO $$
DECLARE
    v_user_id INT;
    v_ent_id INT;
    v_lu_id INT;
    v_region_district_type_id INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';
    SELECT id INTO v_region_district_type_id FROM public.external_ident_type WHERE code = 'region_district';
    
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT Happy Path', v_user_id, now()) RETURNING id INTO v_ent_id;
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at, valid_from)
    VALUES (v_ent_id, 'Test Happy Path Unit', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now(), '2023-01-01') RETURNING id INTO v_lu_id;
    
    -- Test successful hierarchical identifier insertion
    INSERT INTO public.external_ident (legal_unit_id, type_id, idents, edit_by_user_id, edit_at)
    VALUES (v_lu_id, v_region_district_type_id, 'WEST.MBARARA'::ltree, v_user_id, now());
    
    RAISE NOTICE 'Successfully inserted 2-level hierarchical identifier: region_district = WEST.MBARARA';
END $$;
NOTICE:  Successfully inserted 2-level hierarchical identifier: region_district = WEST.MBARARA
-- Verify it was created correctly
\echo "Verify successful 2-level hierarchical identifier creation:"
"Verify successful 2-level hierarchical identifier creation:"
SELECT 
    eit.code,
    eit.shape,
    eit.labels,
    ei.idents,
    nlevel(ei.idents) as actual_depth,
    nlevel(ei.labels) as expected_depth,
    lu.name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id  
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'region_district';
      code       |    shape     |     labels      |    idents    | actual_depth | expected_depth |         name         
-----------------+--------------+-----------------+--------------+--------------+----------------+----------------------
 region_district | hierarchical | region.district | WEST.MBARARA |            2 |              2 | Test Happy Path Unit
(1 row)

-- Test hierarchical ancestor/descendant queries
\echo "Testing hierarchical ancestor queries - find ancestors of NORTH.KAMPALA.001:"
"Testing hierarchical ancestor queries - find ancestors of NORTH.KAMPALA.001:"
SELECT 
    subltree(ei.idents, 0, 1) as region_level,
    subltree(ei.idents, 0, 2) as district_level,
    ei.idents as full_path,
    lu.name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
  AND ei.idents = 'NORTH.KAMPALA.001'::ltree;
 region_level | district_level |     full_path     |         name         
--------------+----------------+-------------------+----------------------
 NORTH        | NORTH.KAMPALA  | NORTH.KAMPALA.001 | LU North Kampala 001
(1 row)

-- Test ltree operations: find all sequences (level 3) in the NORTH region
\echo "Testing ltree level extraction - all sequences in NORTH region:"
"Testing ltree level extraction - all sequences in NORTH region:"
SELECT 
    subpath(ei.idents, 2, 1) as sequence_number,
    ei.idents as full_path,
    lu.name
FROM public.external_ident ei
JOIN public.external_ident_type eit ON eit.id = ei.type_id
JOIN public.legal_unit lu ON lu.id = ei.legal_unit_id
WHERE eit.code = 'test_hierarchical_surveyor'
  AND ei.idents ~ 'NORTH.*'::lquery
ORDER BY ei.idents;
 sequence_number |     full_path     |         name         
-----------------+-------------------+----------------------
 001             | NORTH.KAMPALA.001 | LU North Kampala 001
 002             | NORTH.KAMPALA.002 | LU North Kampala 002
(2 rows)

ROLLBACK TO scenario_113_3_hierarchical_happy_path;
\echo "Final counts after all test blocks for Test 113 (should be same as initial due to rollbacks)"
"Final counts after all test blocks for Test 113 (should be same as initial due to rollbacks)"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

ROLLBACK TO main_test_113_start;
\echo "Test 113 completed and rolled back to main start."
"Test 113 completed and rolled back to main start."
ROLLBACK; -- Final rollback for the entire transaction
