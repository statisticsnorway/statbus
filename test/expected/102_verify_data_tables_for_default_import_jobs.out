BEGIN;
\i test/setup.sql
\echo -- test/setup.sql output suppressed for cleaner test output
-- test/setup.sql output suppressed for cleaner test output
\set ECHO none
\echo -- test/setup.sql done, test output follows
-- test/setup.sql done, test output follows
CALL test.set_user_from_email('test.admin@statbus.org');
\echo "Test: Verify structure of _data tables for default import definitions"
"Test: Verify structure of _data tables for default import definitions"
\echo "--------------------------------------------------------------------"
"--------------------------------------------------------------------"
\echo "This test creates a minimal import job for each default definition"
"This test creates a minimal import job for each default definition"
\echo "and then uses psql's \d command to inspect the structure of the"
"and then uses psql's \d command to inspect the structure of the"
\echo "dynamically created _data table. This helps ensure that all expected"
"dynamically created _data table. This helps ensure that all expected"
\echo "columns (both static and dynamically generated based on steps and types)"
"columns (both static and dynamically generated based on steps and types)"
\echo "are present in the _data tables."
"are present in the _data tables."
-- Create jobs with hardcoded short slugs
DO $$
DECLARE
    v_def_id INT;
    v_job_slug_val TEXT;
    v_def_slug TEXT;
BEGIN
    -- legal_unit_job_provided
    v_def_slug := 'legal_unit_job_provided';
    v_job_slug_val := 't54_lu_tc';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment, time_context_ident)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54', 'r_year_curr');
    END IF;

    -- legal_unit_source_dates
    v_def_slug := 'legal_unit_source_dates';
    v_job_slug_val := 't54_lu_sd';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54');
    END IF;

    -- establishment_for_lu_job_provided
    v_def_slug := 'establishment_for_lu_job_provided';
    v_job_slug_val := 't54_est_lu_tc';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment, time_context_ident)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54', 'r_year_curr');
    END IF;

    -- establishment_for_lu_source_dates
    v_def_slug := 'establishment_for_lu_source_dates';
    v_job_slug_val := 't54_est_lu_sd';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54');
    END IF;

    -- establishment_without_lu_job_provided
    v_def_slug := 'establishment_without_lu_job_provided';
    v_job_slug_val := 't54_est_wolu_tc';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment, time_context_ident)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54', 'r_year_curr');
    END IF;

    -- establishment_without_lu_source_dates
    v_def_slug := 'establishment_without_lu_source_dates';
    v_job_slug_val := 't54_est_wolu_sd';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54');
    END IF;

    -- generic_unit_stats_update_job_provided
    v_def_slug := 'generic_unit_stats_update_job_provided';
    v_job_slug_val := 't54_gus_jp';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment, time_context_ident)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54', 'r_year_curr');
    END IF;

    -- generic_unit_stats_update_source_dates
    v_def_slug := 'generic_unit_stats_update_source_dates';
    v_job_slug_val := 't54_gus_sd';
    SELECT id INTO v_def_id FROM public.import_definition WHERE slug = v_def_slug;
    IF NOT FOUND THEN RAISE WARNING 'Definition slug % not found, cannot create job.', v_def_slug;
    ELSE
        DELETE FROM public.import_job WHERE slug = v_job_slug_val;
        INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
        VALUES (v_def_id, v_job_slug_val, 'Test 54 job for ' || v_def_slug, 'Automated test 54', 'Test 54');
    END IF;
END;
$$;
\echo ""
""
\echo "Verifying created import_job records:"
"Verifying created import_job records:"
\echo "====================================="
"====================================="
SELECT
    ij.slug, 
    ij.data_table_name, 
    id.slug AS definition_slug
FROM public.import_job ij
JOIN public.import_definition id ON ij.definition_id = id.id
WHERE ij.slug IN ('t54_lu_tc', 't54_lu_sd', 't54_est_lu_tc', 't54_est_lu_sd', 't54_est_wolu_tc', 't54_est_wolu_sd', 't54_gus_jp', 't54_gus_sd')
ORDER BY ij.slug;
      slug       |   data_table_name    |            definition_slug             
-----------------+----------------------+----------------------------------------
 t54_est_lu_sd   | t54_est_lu_sd_data   | establishment_for_lu_source_dates
 t54_est_lu_tc   | t54_est_lu_tc_data   | establishment_for_lu_job_provided
 t54_est_wolu_sd | t54_est_wolu_sd_data | establishment_without_lu_source_dates
 t54_est_wolu_tc | t54_est_wolu_tc_data | establishment_without_lu_job_provided
 t54_gus_jp      | t54_gus_jp_data      | generic_unit_stats_update_job_provided
 t54_gus_sd      | t54_gus_sd_data      | generic_unit_stats_update_source_dates
 t54_lu_sd       | t54_lu_sd_data       | legal_unit_source_dates
 t54_lu_tc       | t54_lu_tc_data       | legal_unit_job_provided
(8 rows)

-- Inspect data table structures directly
\echo ""
""
\echo "Inspecting _data table structures:"
"Inspecting _data table structures:"
\echo "=================================="
"=================================="
\pset pager off
\echo '\nDescribing table for definition: legal_unit_job_provided (Job: t54_lu_tc, Data Table: public.t54_lu_tc_data)'

Describing table for definition: legal_unit_job_provided (Job: t54_lu_tc, Data Table: public.t54_lu_tc_data)
\d public.t54_lu_tc_data
                                             Table "public.t54_lu_tc_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 enterprise_id                        | integer                   |           |          | 
 primary_for_enterprise               | boolean                   |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 legal_form_code_raw                  | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 legal_form_id                        | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_lu_tc_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_lu_tc_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_lu_tc_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_lu_tc_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_lu_tc_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_lu_tc_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_lu_tc_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_lu_tc_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_lu_tc_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_lu_tc_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: legal_unit_source_dates (Job: t54_lu_sd, Data Table: public.t54_lu_sd_data)'

Describing table for definition: legal_unit_source_dates (Job: t54_lu_sd, Data Table: public.t54_lu_sd_data)
\d public.t54_lu_sd_data
                                             Table "public.t54_lu_sd_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 enterprise_id                        | integer                   |           |          | 
 primary_for_enterprise               | boolean                   |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 legal_form_code_raw                  | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 legal_form_id                        | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_lu_sd_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_lu_sd_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_lu_sd_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_lu_sd_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_lu_sd_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_lu_sd_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_lu_sd_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_lu_sd_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_lu_sd_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_lu_sd_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: establishment_for_lu_job_provided (Job: t54_est_lu_tc, Data Table: public.t54_est_lu_tc_data)'

Describing table for definition: establishment_for_lu_job_provided (Job: t54_est_lu_tc, Data Table: public.t54_est_lu_tc_data)
\d public.t54_est_lu_tc_data
                                           Table "public.t54_est_lu_tc_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 primary_for_legal_unit               | boolean                   |           |          | 
 legal_unit_tax_ident_raw             | text                      |           |          | 
 legal_unit_stat_ident_raw            | text                      |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_est_lu_tc_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_est_lu_tc_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_est_lu_tc_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_est_lu_tc_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_est_lu_tc_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_est_lu_tc_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_est_lu_tc_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_est_lu_tc_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_est_lu_tc_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_est_lu_tc_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: establishment_for_lu_source_dates (Job: t54_est_lu_sd, Data Table: public.t54_est_lu_sd_data)'

Describing table for definition: establishment_for_lu_source_dates (Job: t54_est_lu_sd, Data Table: public.t54_est_lu_sd_data)
\d public.t54_est_lu_sd_data
                                           Table "public.t54_est_lu_sd_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 primary_for_legal_unit               | boolean                   |           |          | 
 legal_unit_tax_ident_raw             | text                      |           |          | 
 legal_unit_stat_ident_raw            | text                      |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_est_lu_sd_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_est_lu_sd_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_est_lu_sd_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_est_lu_sd_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_est_lu_sd_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_est_lu_sd_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_est_lu_sd_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_est_lu_sd_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_est_lu_sd_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_est_lu_sd_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: establishment_without_lu_job_provided (Job: t54_est_wolu_tc, Data Table: public.t54_est_wolu_tc_data)'

Describing table for definition: establishment_without_lu_job_provided (Job: t54_est_wolu_tc, Data Table: public.t54_est_wolu_tc_data)
\d public.t54_est_wolu_tc_data
                                          Table "public.t54_est_wolu_tc_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 enterprise_id                        | integer                   |           |          | 
 primary_for_enterprise               | boolean                   |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_est_wolu_tc_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_est_wolu_tc_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_est_wolu_tc_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_est_wolu_tc_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_est_wolu_tc_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_est_wolu_tc_data_state_last_completed_priority_batch_se_idx" btree (state, last_completed_priority, batch_seq)
    "t54_est_wolu_tc_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_est_wolu_tc_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_est_wolu_tc_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_est_wolu_tc_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: establishment_without_lu_source_dates (Job: t54_est_wolu_sd, Data Table: public.t54_est_wolu_sd_data)'

Describing table for definition: establishment_without_lu_source_dates (Job: t54_est_wolu_sd, Data Table: public.t54_est_wolu_sd_data)
\d public.t54_est_wolu_sd_data
                                          Table "public.t54_est_wolu_sd_data"
                Column                |           Type            | Collation | Nullable |           Default            
--------------------------------------+---------------------------+-----------+----------+------------------------------
 row_id                               | integer                   |           | not null | generated always as identity
 batch_seq                            | integer                   |           |          | 
 valid_from_raw                       | text                      |           |          | 
 valid_to_raw                         | text                      |           |          | 
 valid_from                           | date                      |           |          | 
 valid_to                             | date                      |           |          | 
 valid_until                          | date                      |           |          | 
 operation                            | import_row_operation_type |           |          | 
 action                               | import_row_action_type    |           |          | 
 legal_unit_id                        | integer                   |           |          | 
 establishment_id                     | integer                   |           |          | 
 tax_ident_raw                        | text                      |           |          | 
 stat_ident_raw                       | text                      |           |          | 
 data_source_code_raw                 | text                      |           |          | 
 data_source_id                       | integer                   |           |          | 
 status_code_raw                      | text                      |           |          | 
 status_id                            | integer                   |           |          | 
 enterprise_id                        | integer                   |           |          | 
 primary_for_enterprise               | boolean                   |           |          | 
 name_raw                             | text                      |           |          | 
 name                                 | text                      |           |          | 
 birth_date_raw                       | text                      |           |          | 
 death_date_raw                       | text                      |           |          | 
 sector_code_raw                      | text                      |           |          | 
 unit_size_code_raw                   | text                      |           |          | 
 sector_id                            | integer                   |           |          | 
 unit_size_id                         | integer                   |           |          | 
 birth_date                           | date                      |           |          | 
 death_date                           | date                      |           |          | 
 physical_address_part1_raw           | text                      |           |          | 
 physical_address_part1               | text                      |           |          | 
 physical_address_part2_raw           | text                      |           |          | 
 physical_address_part2               | text                      |           |          | 
 physical_address_part3_raw           | text                      |           |          | 
 physical_address_part3               | text                      |           |          | 
 physical_postcode_raw                | text                      |           |          | 
 physical_postcode                    | text                      |           |          | 
 physical_postplace_raw               | text                      |           |          | 
 physical_postplace                   | text                      |           |          | 
 physical_latitude_raw                | text                      |           |          | 
 physical_longitude_raw               | text                      |           |          | 
 physical_altitude_raw                | text                      |           |          | 
 physical_region_code_raw             | text                      |           |          | 
 physical_country_iso_2_raw           | text                      |           |          | 
 physical_location_id                 | integer                   |           |          | 
 physical_region_id                   | integer                   |           |          | 
 physical_country_id                  | integer                   |           |          | 
 physical_latitude                    | numeric(9,6)              |           |          | 
 physical_longitude                   | numeric(9,6)              |           |          | 
 physical_altitude                    | numeric(6,1)              |           |          | 
 postal_address_part1_raw             | text                      |           |          | 
 postal_address_part1                 | text                      |           |          | 
 postal_address_part2_raw             | text                      |           |          | 
 postal_address_part2                 | text                      |           |          | 
 postal_address_part3_raw             | text                      |           |          | 
 postal_address_part3                 | text                      |           |          | 
 postal_postcode_raw                  | text                      |           |          | 
 postal_postcode                      | text                      |           |          | 
 postal_postplace_raw                 | text                      |           |          | 
 postal_postplace                     | text                      |           |          | 
 postal_region_code_raw               | text                      |           |          | 
 postal_country_iso_2_raw             | text                      |           |          | 
 postal_latitude_raw                  | text                      |           |          | 
 postal_longitude_raw                 | text                      |           |          | 
 postal_altitude_raw                  | text                      |           |          | 
 postal_location_id                   | integer                   |           |          | 
 postal_region_id                     | integer                   |           |          | 
 postal_country_id                    | integer                   |           |          | 
 postal_latitude                      | numeric(9,6)              |           |          | 
 postal_longitude                     | numeric(9,6)              |           |          | 
 postal_altitude                      | numeric(6,1)              |           |          | 
 primary_activity_category_code_raw   | text                      |           |          | 
 primary_activity_id                  | integer                   |           |          | 
 primary_activity_category_id         | integer                   |           |          | 
 secondary_activity_category_code_raw | text                      |           |          | 
 secondary_activity_id                | integer                   |           |          | 
 secondary_activity_category_id       | integer                   |           |          | 
 web_address_raw                      | text                      |           |          | 
 web_address                          | text                      |           |          | 
 email_address_raw                    | text                      |           |          | 
 email_address                        | text                      |           |          | 
 phone_number_raw                     | text                      |           |          | 
 phone_number                         | text                      |           |          | 
 landline_raw                         | text                      |           |          | 
 landline                             | text                      |           |          | 
 mobile_number_raw                    | text                      |           |          | 
 mobile_number                        | text                      |           |          | 
 fax_number_raw                       | text                      |           |          | 
 fax_number                           | text                      |           |          | 
 contact_id                           | integer                   |           |          | 
 employees_raw                        | text                      |           |          | 
 employees                            | integer                   |           |          | 
 stat_for_unit_employees_id           | integer                   |           |          | 
 turnover_raw                         | text                      |           |          | 
 turnover                             | numeric                   |           |          | 
 stat_for_unit_turnover_id            | integer                   |           |          | 
 tag_path_raw                         | text                      |           |          | 
 tag_path                             | ltree                     |           |          | 
 tag_id                               | integer                   |           |          | 
 tag_for_unit_id                      | integer                   |           |          | 
 edit_comment_raw                     | text                      |           |          | 
 edit_by_user_id                      | integer                   |           |          | 
 edit_at                              | timestamp with time zone  |           |          | 
 edit_comment                         | text                      |           |          | 
 founding_row_id                      | integer                   |           |          | 
 state                                | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority              | integer                   |           | not null | 0
 errors                               | jsonb                     |           | not null | '{}'::jsonb
 merge_status                         | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes                        | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_est_wolu_sd_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_est_wolu_sd_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_est_wolu_sd_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_est_wolu_sd_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_est_wolu_sd_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_est_wolu_sd_data_state_last_completed_priority_batch_se_idx" btree (state, last_completed_priority, batch_seq)
    "t54_est_wolu_sd_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_est_wolu_sd_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_est_wolu_sd_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_est_wolu_sd_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: generic_unit_stats_update_job_provided (Job: t54_gus_jp, Data Table: public.t54_gus_jp_data)'

Describing table for definition: generic_unit_stats_update_job_provided (Job: t54_gus_jp, Data Table: public.t54_gus_jp_data)
\d public.t54_gus_jp_data
                                        Table "public.t54_gus_jp_data"
           Column           |           Type            | Collation | Nullable |           Default            
----------------------------+---------------------------+-----------+----------+------------------------------
 row_id                     | integer                   |           | not null | generated always as identity
 batch_seq                  | integer                   |           |          | 
 valid_from_raw             | text                      |           |          | 
 valid_to_raw               | text                      |           |          | 
 valid_from                 | date                      |           |          | 
 valid_to                   | date                      |           |          | 
 valid_until                | date                      |           |          | 
 operation                  | import_row_operation_type |           |          | 
 action                     | import_row_action_type    |           |          | 
 legal_unit_id              | integer                   |           |          | 
 establishment_id           | integer                   |           |          | 
 tax_ident_raw              | text                      |           |          | 
 stat_ident_raw             | text                      |           |          | 
 data_source_code_raw       | text                      |           |          | 
 data_source_id             | integer                   |           |          | 
 employees_raw              | text                      |           |          | 
 employees                  | integer                   |           |          | 
 stat_for_unit_employees_id | integer                   |           |          | 
 turnover_raw               | text                      |           |          | 
 turnover                   | numeric                   |           |          | 
 stat_for_unit_turnover_id  | integer                   |           |          | 
 edit_comment_raw           | text                      |           |          | 
 edit_by_user_id            | integer                   |           |          | 
 edit_at                    | timestamp with time zone  |           |          | 
 edit_comment               | text                      |           |          | 
 founding_row_id            | integer                   |           |          | 
 state                      | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority    | integer                   |           | not null | 0
 errors                     | jsonb                     |           | not null | '{}'::jsonb
 merge_status               | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes              | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_gus_jp_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_gus_jp_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_gus_jp_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_gus_jp_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_gus_jp_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_gus_jp_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_gus_jp_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_gus_jp_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_gus_jp_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_gus_jp_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
\echo '\nDescribing table for definition: generic_unit_stats_update_source_dates (Job: t54_gus_sd, Data Table: public.t54_gus_sd_data)'

Describing table for definition: generic_unit_stats_update_source_dates (Job: t54_gus_sd, Data Table: public.t54_gus_sd_data)
\d public.t54_gus_sd_data
                                        Table "public.t54_gus_sd_data"
           Column           |           Type            | Collation | Nullable |           Default            
----------------------------+---------------------------+-----------+----------+------------------------------
 row_id                     | integer                   |           | not null | generated always as identity
 batch_seq                  | integer                   |           |          | 
 valid_from_raw             | text                      |           |          | 
 valid_to_raw               | text                      |           |          | 
 valid_from                 | date                      |           |          | 
 valid_to                   | date                      |           |          | 
 valid_until                | date                      |           |          | 
 operation                  | import_row_operation_type |           |          | 
 action                     | import_row_action_type    |           |          | 
 legal_unit_id              | integer                   |           |          | 
 establishment_id           | integer                   |           |          | 
 tax_ident_raw              | text                      |           |          | 
 stat_ident_raw             | text                      |           |          | 
 data_source_code_raw       | text                      |           |          | 
 data_source_id             | integer                   |           |          | 
 employees_raw              | text                      |           |          | 
 employees                  | integer                   |           |          | 
 stat_for_unit_employees_id | integer                   |           |          | 
 turnover_raw               | text                      |           |          | 
 turnover                   | numeric                   |           |          | 
 stat_for_unit_turnover_id  | integer                   |           |          | 
 edit_comment_raw           | text                      |           |          | 
 edit_by_user_id            | integer                   |           |          | 
 edit_at                    | timestamp with time zone  |           |          | 
 edit_comment               | text                      |           |          | 
 founding_row_id            | integer                   |           |          | 
 state                      | import_data_state         |           | not null | 'pending'::import_data_state
 last_completed_priority    | integer                   |           | not null | 0
 errors                     | jsonb                     |           | not null | '{}'::jsonb
 merge_status               | jsonb                     |           | not null | '{}'::jsonb
 invalid_codes              | jsonb                     |           | not null | '{}'::jsonb
Indexes:
    "t54_gus_sd_data_pkey" PRIMARY KEY, btree (row_id)
    "t54_gus_sd_data_batch_seq_idx" btree (batch_seq) WHERE batch_seq IS NOT NULL
    "t54_gus_sd_data_daterange_idx" gist (daterange(valid_from, valid_until, '[)'::text))
    "t54_gus_sd_data_founding_row_id_idx" btree (founding_row_id) WHERE founding_row_id IS NOT NULL
    "t54_gus_sd_data_stat_ident_raw_idx" btree (stat_ident_raw)
    "t54_gus_sd_data_state_last_completed_priority_batch_seq_idx" btree (state, last_completed_priority, batch_seq)
    "t54_gus_sd_data_tax_ident_raw_idx" btree (tax_ident_raw)
Check constraints:
    "chk_batch_seq_state_action" CHECK (
CASE state
    WHEN 'pending'::import_data_state THEN batch_seq IS NULL AND action IS NULL
    WHEN 'analysing'::import_data_state THEN batch_seq IS NOT NULL
    WHEN 'analysed'::import_data_state THEN batch_seq IS NOT NULL AND action IS NOT NULL
    WHEN 'error'::import_data_state THEN true
    WHEN 'processing'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    WHEN 'processed'::import_data_state THEN action = 'use'::import_row_action_type AND batch_seq IS NOT NULL
    ELSE false
END)
Policies:
    POLICY "t54_gus_sd_data_admin_user_manage"
      TO admin_user
      USING (true)
      WITH CHECK (true)
    POLICY "t54_gus_sd_data_authenticated_read" FOR SELECT
      TO authenticated
      USING (true)
    POLICY "t54_gus_sd_data_regular_user_manage"
      TO regular_user
      USING (true)
      WITH CHECK (true)

\echo '--------------------------------------------------'
--------------------------------------------------
ROLLBACK;
