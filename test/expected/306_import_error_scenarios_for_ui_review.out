--
-- Test: Import Error Scenarios for UI Review
--
-- This test creates import jobs with various error types to allow visual
-- inspection of how errors and invalid_codes are displayed in the UI.
--
-- Run with PERSIST=true to keep data for UI review:
--   ./devops/manage-statbus.sh psql --variable=PERSIST=true < test/sql/404_import_error_scenarios_for_ui_review.sql
--
-- Then view in the UI:
--   - Job list: http://localhost:3012/import/jobs
--   - Job data: http://localhost:3012/import/jobs/errors_lu_analysis/data
--
-- Error types demonstrated:
--   1. Hard errors (errors column) - rows that cannot be imported:
--      - Invalid codes (sector, legal_form, activity)
--      - Malformed dates (birth_date, valid_from, valid_to)
--      - Invalid period (valid_from > valid_to)
--      - Invalid region/country codes
--      - Missing required identifiers
--
--   2. Soft errors (invalid_codes column) - rows imported with warnings:
--      - Invalid status code (falls back to default)
--      - Invalid postal region (location still created)
--      - Domestic unit missing region (warning only)
--
-- Structure:
--   0. Cleanup phase: Ensure clean state from prior runs
--   1. Setup phase: Create Norway environment and import definitions
--   2. Create jobs and upload data with errors
--   3. Process imports
--   4. Display results
--   5. Cleanup unless PERSIST=true
--
-- ============================================================================
-- PHASE 0: INITIAL CLEANUP AND PAUSE WORKER
-- ============================================================================
\echo '=== Phase 0: Cleanup and pause worker ==='
=== Phase 0: Cleanup and pause worker ===
-- Use 'data' scope to preserve import_definitions (created by migrations)
-- 'getting-started' would delete them, requiring us to recreate them
SELECT public.reset(true, 'data');
                                                                                                                                                                                                                         reset                                                                                                                                                                                                                          
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"person": {"deleted_count": 0}, "contact": {"deleted_count": 0}, "activity": {"deleted_count": 0}, "location": {"deleted_count": 0}, "enterprise": {"deleted_count": 0}, "import_job": {"deleted_count": 0}, "legal_unit": {"deleted_count": 0}, "tag_for_unit": {"deleted_count": 0}, "establishment": {"deleted_count": 0}, "stat_for_unit": {"deleted_count": 0}, "external_ident": {"deleted_count": 0}, "person_for_unit": {"deleted_count": 0}}
(1 row)

SELECT worker.pause('1 hour'::interval);
 pause 
-------
 
(1 row)

-- ============================================================================
-- PHASE 1: SETUP (in transaction for setup.sql helpers)
-- ============================================================================
BEGIN;
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create(p_display_name => 'Test Admin', p_email => 'test.admin@statbus.org', p_statbus_role => 'admin_user'::statbus_role, p_password => 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Regular', p_email => 'test.regular@statbus.org', p_statbus_role => 'regular_user'::statbus_role, p_password => 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create(p_display_name => 'Test Restricted', p_email => 'test.restricted@statbus.org', p_statbus_role => 'restricted_user'::statbus_role, p_password => 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

CREATE OR REPLACE PROCEDURE test.remove_pg_temp_for_tx_user_switch(p_keep_tables text[] DEFAULT '{}')
LANGUAGE plpgsql
AS $remove_pg_temp_for_tx_user_switch$
DECLARE
    rec record;
    v_found_count integer := 0;
BEGIN
    RAISE DEBUG 'Running test.remove_pg_temp_for_tx_user_switch(p_keep_tables => %)...', p_keep_tables;
    -- Remove temporary cache tables used by import, as we switch user inside the *same* transaction,
    -- and the new user can not modify tables owned by the previous import.
    -- This generic loop cleans up all tables and views in the pg_temp schema, except those specified to keep.
    FOR rec IN
        SELECT
            c.relname,
            c.relkind
        FROM pg_catalog.pg_class AS c
        LEFT JOIN pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace
        WHERE c.relkind IN ('r', 'p', 'v', 'm') AND n.oid = pg_my_temp_schema() -- r=table, p=partitioned, v=view, m=materialized
          AND c.relname <> ALL(p_keep_tables)
    LOOP
        v_found_count := v_found_count + 1;
        IF rec.relkind IN ('r', 'p', 'm') THEN
            RAISE DEBUG '  -> Dropping temp TABLE %', rec.relname;
            EXECUTE format('DROP TABLE IF EXISTS pg_temp.%I CASCADE', rec.relname);
        ELSIF rec.relkind = 'v' THEN
            RAISE DEBUG '  -> Dropping temp VIEW %', rec.relname;
            EXECUTE format('DROP VIEW IF EXISTS pg_temp.%I CASCADE', rec.relname);
        END IF;
    END LOOP;

    RAISE DEBUG '...finished test.remove_pg_temp_for_tx_user_switch(). Found and dropped % objects.', v_found_count;

    -- This procedure is part of the sql_saga extension and has its own cleanup logic.
    -- While the loop above handles tables/views, this call ensures any other temporary
    -- objects it creates are also cleaned up.
    CALL sql_saga.temporal_merge_drop_temp_tables();
END;
$remove_pg_temp_for_tx_user_switch$;
CALL test.set_user_from_email('test.admin@statbus.org');
\echo '=== Phase 1: Setting up Norway environment ==='
=== Phase 1: Setting up Norway environment ===
\i samples/norway/getting-started.sql
\i samples/norway/settings.sql
INSERT INTO settings(activity_category_standard_id,country_id)
SELECT (SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
     , (SELECT id FROM public.country WHERE iso_2 = 'NO')
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id = EXCLUDED.activity_category_standard_id,
   country_id = EXCLUDED.country_id
   WHERE settings.only_one_setting = EXCLUDED.only_one_setting;
;
\i samples/norway/activity_category/activity_category_norway.sql
\copy public.activity_category_available_custom FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/regions/norway-regions-2024.sql
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/sector/sector_norway.sql
\copy public.sector_custom_only FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/legal_form/legal_form_norway.sql
\copy public.legal_form_custom_only FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\i samples/norway/data_source/data_source_norway.sql
\copy public.data_source_custom (code, name) FROM 'samples/norway/data_source/data_source_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
COMMIT;
-- ============================================================================
-- PHASE 2: CREATE JOBS AND UPLOAD DATA
-- ============================================================================
\echo '=== Phase 2: Creating import jobs with error scenarios ==='
=== Phase 2: Creating import jobs with error scenarios ===
-- Job 1: Legal Unit with various analysis errors (comprehensive)
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
    VALUES (v_definition_id, 'errors_lu_analysis', 'LU Import with Analysis Errors',
            'Demonstrates various hard errors (invalid codes, malformed dates) and soft errors (invalid_codes that fall back to defaults)',
            'Test 404: Error scenarios for UI review');
END $$;
WARNING:  [Job 1] Could not find user role for user_id <NULL>, cannot grant permissions on errors_lu_analysis_upload
\echo 'Uploading data with various error types...'
Uploading data with various error types...
INSERT INTO public.errors_lu_analysis_upload(
    tax_ident, name, valid_from, valid_to, 
    sector_code, legal_form_code, primary_activity_category_code, 
    birth_date, death_date,
    secondary_activity_category_code, 
    physical_address_part1, physical_region_code, physical_country_iso_2, physical_latitude,
    postal_address_part1, postal_region_code, postal_country_iso_2,
    status_code, data_source_code, unit_size_code,
    employees, turnover
) VALUES
-- === VALID ROWS (for comparison) ===
('VALID001', 'Valid Company Alpha', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2020-01-15', NULL, NULL, 'Main Street 1', '0301', 'NO', '59.9139', NULL, NULL, NULL, 'active', NULL, NULL, 50, 1000000),
('VALID002', 'Valid Company Beta', '2023-01-01', '2023-12-31', '2100', 'ENK', '47.110', '2019-06-01', NULL, NULL, 'Market Square 5', '1103', 'NO', '58.9700', NULL, NULL, NULL, 'active', NULL, NULL, 10, 250000),
-- === HARD ERRORS: Invalid Codes ===
('ERR_SEC', 'Invalid Sector Code', '2023-01-01', '2023-12-31', 'INVALID_SECTOR', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_LF', 'Invalid Legal Form', '2023-01-01', '2023-12-31', '2100', 'INVALID_LF', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_ACT1', 'Invalid Primary Activity', '2023-01-01', '2023-12-31', '2100', 'AS', '99.999', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_ACT2', 'Invalid Secondary Activity', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, '88.888', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
-- === HARD ERRORS: Malformed Dates ===
('ERR_VF', 'Malformed ValidFrom', 'NOT_A_DATE', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_VT', 'Malformed ValidTo', '2023-01-01', 'ALSO_NOT_DATE', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_BD', 'Malformed BirthDate', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-13-45', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_DD', 'Malformed DeathDate', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', '2023-02-30', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'inactive', NULL, NULL, NULL, NULL),
-- === HARD ERRORS: Invalid Period ===
-- NOTE: Commented out because this causes a batch-level exception during
-- analyse_valid_time which stops all row processing. This demonstrates a
-- job-level failure vs row-level errors. Uncomment to test job failures.
-- ('ERR_PER', 'Invalid Period (from > to)', '2023-12-31', '2023-01-01', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
-- === HARD ERRORS: Missing Required Dates ===
('ERR_NVF', 'Missing ValidFrom', NULL, '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_NVT', 'Missing ValidTo', '2023-01-01', NULL, '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
-- === HARD ERRORS: Location Errors ===
('ERR_REG', 'Invalid Region Code', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Street 1', 'INVALID_REG', 'NO', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_CTY', 'Invalid Country Code', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Street 1', '0301', 'ZZ', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_LAT', 'Invalid Latitude Format', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, 'NO', 'not_a_number', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
('ERR_LATR', 'Latitude Out of Range', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, 'NO', '95.0', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
-- === HARD ERRORS: Other Invalid Codes ===
('ERR_DS', 'Invalid DataSource', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'INVALID_DS', NULL, NULL, NULL),
('ERR_US', 'Invalid UnitSize', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'HUGE', NULL, NULL),
-- === HARD ERRORS: Invalid Statistical Variables ===
('ERR_EMP', 'Invalid Employees (not integer)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'fifty', NULL),
('ERR_TUR', 'Invalid Turnover (not numeric)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'one million'),
-- === SOFT ERRORS: Invalid Codes with Fallback (invalid_codes column) ===
('WARN_STS', 'Invalid Status (uses default)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'sleeping_unknown', NULL, NULL, 25, 500000),
('WARN_PREG', 'Invalid Postal Region', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Office Park 10', '0301', 'NO', NULL, 'PO Box 123', 'INVALID_POSTAL', NULL, 'active', NULL, NULL, 15, 300000),
('WARN_PCTY', 'Invalid Postal Country', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Harbor Street 7', '1103', 'NO', NULL, 'Overseas Box', NULL, 'XX', 'active', NULL, NULL, 8, 150000),
-- === SOFT ERRORS: Missing Region Warnings ===
('WARN_NREG', 'Domestic Missing Region (warning)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Unknown Location', NULL, 'NO', NULL, NULL, NULL, NULL, 'active', NULL, NULL, 5, 100000),
('OK_FREG', 'Foreign Missing Region (ok)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'International HQ', NULL, 'SE', NULL, NULL, NULL, NULL, 'active', NULL, NULL, 100, 5000000),
('WARN_FDREG', 'Foreign with Domestic Region (error)', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110', '2023-01-01', NULL, NULL, 'Mixed Location', '0301', 'SE', NULL, NULL, NULL, NULL, 'active', NULL, NULL, 20, 400000);
\echo 'Upload complete. Row count:'
Upload complete. Row count:
SELECT COUNT(*) as uploaded_rows FROM public.errors_lu_analysis_upload;
 uploaded_rows 
---------------
            26
(1 row)

-- Job 2: Formal Establishment with link errors
DO $$
DECLARE 
    v_lu_def_id INT;
    v_es_def_id INT;
BEGIN
    SELECT id INTO v_lu_def_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    SELECT id INTO v_es_def_id FROM public.import_definition WHERE slug = 'establishment_for_lu_source_dates';
    
    -- First create some valid LUs for the ES to link to
    INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
    VALUES (v_lu_def_id, 'errors_lu_for_es', 'Valid LUs for Establishment Tests',
            'These LUs are created to test establishment linking errors',
            'Test 404');
    
    -- Then create ES job with link errors
    INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
    VALUES (v_es_def_id, 'errors_es_formal', 'Formal ES with Link Errors',
            'Demonstrates establishment-to-LU linking errors',
            'Test 404');
END $$;
WARNING:  [Job 2] Could not find user role for user_id <NULL>, cannot grant permissions on errors_lu_for_es_upload
WARNING:  [Job 3] Could not find user role for user_id <NULL>, cannot grant permissions on errors_es_formal_upload
-- Upload valid LUs first
INSERT INTO public.errors_lu_for_es_upload(tax_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code)
VALUES
('LU_FOR_ES_001', 'Parent Company One', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110'),
('LU_FOR_ES_002', 'Parent Company Two', '2023-01-01', '2023-12-31', '2100', 'ENK', '47.110');
-- Upload ES with various link errors
INSERT INTO public.errors_es_formal_upload(tax_ident, name, valid_from, valid_to, primary_activity_category_code, legal_unit_tax_ident)
VALUES
-- Valid establishment
('ES_VALID', 'Valid Establishment', '2023-01-01', '2023-12-31', '01.110', 'LU_FOR_ES_001'),
-- Missing LU link
('ES_NO_LINK', 'ES Missing LU Link', '2023-01-01', '2023-12-31', '01.110', NULL),
-- Non-existent LU
('ES_BAD_LINK', 'ES Links to Non-Existent LU', '2023-01-01', '2023-12-31', '01.110', 'LU_DOES_NOT_EXIST'),
-- Invalid activity code
('ES_BAD_ACT', 'ES Invalid Activity', '2023-01-01', '2023-12-31', '99.999', 'LU_FOR_ES_002');
-- Job 3: Missing identifier errors
DO $$
DECLARE v_definition_id INT;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = 'legal_unit_source_dates';
    INSERT INTO public.import_job (definition_id, slug, description, note, edit_comment)
    VALUES (v_definition_id, 'errors_lu_missing_ident', 'LU Missing Identifiers',
            'Demonstrates errors when required identifiers are missing',
            'Test 404');
END $$;
WARNING:  [Job 4] Could not find user role for user_id <NULL>, cannot grant permissions on errors_lu_missing_ident_upload
INSERT INTO public.errors_lu_missing_ident_upload(tax_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code)
VALUES
(NULL, 'Missing Tax Ident', '2023-01-01', '2023-12-31', '2100', 'AS', '01.110'),
('HAS_IDENT', NULL, '2023-01-01', '2023-12-31', '2100', 'AS', '01.110');
-- ============================================================================
-- PHASE 3: PROCESS IMPORTS
-- ============================================================================
\echo '=== Phase 3: Processing imports ==='
=== Phase 3: Processing imports ===
-- Process all pending import tasks
CALL worker.process_tasks(p_queue => 'import');
WARNING:  [Job 1] process_enterprise_link_for_legal_unit: Programming error suspected during enterprise creation loop: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint
WARNING:  [Job 1] process_enterprise_link_for_legal_unit: Unhandled error during operation: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint
WARNING:  [Job 1] Error processing batch: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint. Context: SQL statement "WITH new_enterprises AS (
            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)
            SELECT
                NULL, -- short_name is set to NULL, will be derived by trigger later
                t.edit_by_user_id,
                t.edit_at,
                t.edit_comment
            FROM temp_new_lu_for_enterprise_creation t
            RETURNING id
        ),
        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.
        -- We rely on the fact that the order should be preserved and join by row_number.
        -- This is safe as we are in a single transaction and not using parallel workers.
        source_with_rn AS (
            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation
        ),
        created_with_rn AS (
            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises
        )
        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)
        SELECT s.data_row_id, c.id
        FROM source_with_rn s
        JOIN created_with_rn c ON s.rn = c.rn"
PL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement
SQL statement "CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)"
PL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE
SQL statement "CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)"
PL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL
PL/pgSQL function admin.import_job_process(integer) line 158 at assignment
SQL statement "CALL admin.import_job_process(job_id)"
PL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL
SQL statement "CALL admin.import_job_process($1)"
PL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE. Marking batch rows as error and failing job.
WARNING:  [Job 1] Error detected during processing phase: {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "error_in_processing_batch": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"}. Job already transitioned to finished.
WARNING:  [Job 2] process_enterprise_link_for_legal_unit: Programming error suspected during enterprise creation loop: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint
WARNING:  [Job 2] process_enterprise_link_for_legal_unit: Unhandled error during operation: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint
WARNING:  [Job 2] Error processing batch: null value in column "edit_by_user_id" of relation "enterprise" violates not-null constraint. Context: SQL statement "WITH new_enterprises AS (
            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)
            SELECT
                NULL, -- short_name is set to NULL, will be derived by trigger later
                t.edit_by_user_id,
                t.edit_at,
                t.edit_comment
            FROM temp_new_lu_for_enterprise_creation t
            RETURNING id
        ),
        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.
        -- We rely on the fact that the order should be preserved and join by row_number.
        -- This is safe as we are in a single transaction and not using parallel workers.
        source_with_rn AS (
            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation
        ),
        created_with_rn AS (
            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises
        )
        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)
        SELECT s.data_row_id, c.id
        FROM source_with_rn s
        JOIN created_with_rn c ON s.rn = c.rn"
PL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement
SQL statement "CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)"
PL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE
SQL statement "CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)"
PL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL
PL/pgSQL function admin.import_job_process(integer) line 158 at assignment
SQL statement "CALL admin.import_job_process(job_id)"
PL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL
SQL statement "CALL admin.import_job_process($1)"
PL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE. Marking batch rows as error and failing job.
WARNING:  [Job 2] Error detected during processing phase: {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "error_in_processing_batch": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"}. Job already transitioned to finished.
-- Resume worker for normal operation
SELECT worker.resume();
 resume 
--------
 
(1 row)

-- ============================================================================
-- PHASE 4: DISPLAY RESULTS
-- ============================================================================
\echo '=== Phase 4: Results Summary ==='
=== Phase 4: Results Summary ===
\echo ''

\echo '--- Import Job Status ---'
--- Import Job Status ---
SELECT 
    slug,
    state,
    total_rows,
    imported_rows,
    total_rows - COALESCE(imported_rows, 0) as failed_rows,
    error IS NOT NULL AS has_job_error
FROM public.import_job 
WHERE slug LIKE 'errors_%'
ORDER BY slug;
          slug           |  state   | total_rows | imported_rows | failed_rows | has_job_error 
-------------------------+----------+------------+---------------+-------------+---------------
 errors_es_formal        | finished |          4 |             0 |           4 | f
 errors_lu_analysis      | failed   |         26 |             0 |          26 | t
 errors_lu_for_es        | failed   |          2 |             0 |           2 | t
 errors_lu_missing_ident | finished |          2 |             0 |           2 | f
(4 rows)

\echo ''

\echo '--- Job 1: LU Analysis Errors (errors_lu_analysis) ---'
--- Job 1: LU Analysis Errors (errors_lu_analysis) ---
\echo 'Job-level error (if any):'
Job-level error (if any):
SELECT error FROM public.import_job WHERE slug = 'errors_lu_analysis';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      error                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "error_in_processing_batch": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"}
(1 row)

\echo 'All rows (showing state, action, errors, invalid_codes):'
All rows (showing state, action, errors, invalid_codes):
SELECT 
    row_id,
    tax_ident_raw as tax_ident,
    LEFT(name_raw, 30) as name,
    state,
    action,
    CASE WHEN errors IS NOT NULL AND errors != '{}' THEN errors ELSE NULL END as errors,
    CASE WHEN invalid_codes IS NOT NULL AND invalid_codes != '{}' THEN invalid_codes ELSE NULL END as invalid_codes
FROM public.errors_lu_analysis_data
ORDER BY row_id;
 row_id | tax_ident  |              name              | state | action |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   errors                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                          invalid_codes                          
--------+------------+--------------------------------+-------+--------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------
      1 | VALID001   | Valid Company Alpha            | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | 
      2 | VALID002   | Valid Company Beta             | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"primary_activity_category_code_raw": "47.110"}
      3 | ERR_SEC    | Invalid Sector Code            | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"sector_code_raw": "INVALID_SECTOR"}
      4 | ERR_LF     | Invalid Legal Form             | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"legal_form_code_raw": "INVALID_LF"}
      5 | ERR_ACT1   | Invalid Primary Activity       | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"primary_activity_category_code_raw": "99.999"}
      6 | ERR_ACT2   | Invalid Secondary Activity     | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"secondary_activity_category_code_raw": "88.888"}
      7 | ERR_VF     | Malformed ValidFrom            | error | skip   | {"valid_from_raw": "Invalid date format: 'NOT_A_DATE'. SQLSTATE: 22007"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
      8 | ERR_VT     | Malformed ValidTo              | error | skip   | {"valid_to_raw": "Invalid date format: 'ALSO_NOT_DATE'. SQLSTATE: 22007"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
      9 | ERR_BD     | Malformed BirthDate            | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"birth_date_raw": "2023-13-45"}
     10 | ERR_DD     | Malformed DeathDate            | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"death_date_raw": "2023-02-30", "status_code_raw": "inactive"}
     11 | ERR_NVF    | Missing ValidFrom              | error | skip   | {"valid_from_raw": "Missing mandatory value"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 
     12 | ERR_NVT    | Missing ValidTo                | error | skip   | {"valid_to_raw": "Missing mandatory value"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 
     13 | ERR_REG    | Invalid Region Code            | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"physical_region_code_raw": "INVALID_REG"}
     14 | ERR_CTY    | Invalid Country Code           | error | skip   | {"physical_country_iso_2_raw": "Country is required and must be valid when other physical address details are provided."}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
     15 | ERR_LAT    | Invalid Latitude Format        | error | skip   | {"physical_latitude_raw": "Value 'not_a_number' is not a valid numeric representation for type NUMERIC(9,6). SQLSTATE: 22P02"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | {"physical_latitude_raw": "not_a_number"}
     16 | ERR_LATR   | Latitude Out of Range          | error | skip   | {"physical_latitude_raw": "Value 95.000000 out of range. Expected -90 to 90."}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | {"physical_latitude_raw": "95.0"}
     17 | ERR_DS     | Invalid DataSource             | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"data_source_code_raw": "INVALID_DS"}
     18 | ERR_US     | Invalid UnitSize               | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"unit_size_code_raw": "HUGE"}
     19 | ERR_EMP    | Invalid Employees (not integer | error | skip   | {"employees_raw": "Invalid integer format: 'fifty'. SQLSTATE: 22P02"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 
     20 | ERR_TUR    | Invalid Turnover (not numeric) | error | skip   | {"turnover_raw": "Invalid numeric format: 'one million'. SQLSTATE: 22P02"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
     21 | WARN_STS   | Invalid Status (uses default)  | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"status_code_raw": "sleeping_unknown"}
     22 | WARN_PREG  | Invalid Postal Region          | error | skip   | {"postal_country_iso_2_raw": "Country is required and must be valid when other postal address details are provided."}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 
     23 | WARN_PCTY  | Invalid Postal Country         | error | skip   | {"postal_country_iso_2_raw": "Country is required and must be valid when other postal address details are provided."}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 
     24 | WARN_NREG  | Domestic Missing Region (warni | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | {"physical_region_code_raw": null}
     25 | OK_FREG    | Foreign Missing Region (ok)    | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | 
     26 | WARN_FDREG | Foreign with Domestic Region ( | error | use    | {"context": "SQL statement \"WITH new_enterprises AS (\n            INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at, edit_comment)\n            SELECT\n                NULL, -- short_name is set to NULL, will be derived by trigger later\n                t.edit_by_user_id,\n                t.edit_at,\n                t.edit_comment\n            FROM temp_new_lu_for_enterprise_creation t\n            RETURNING id\n        ),\n        -- This mapping is tricky because INSERT...RETURNING doesn't give us back the source rows.\n        -- We rely on the fact that the order should be preserved and join by row_number.\n        -- This is safe as we are in a single transaction and not using parallel workers.\n        source_with_rn AS (\n            SELECT *, ROW_NUMBER() OVER () as rn FROM temp_new_lu_for_enterprise_creation\n        ),\n        created_with_rn AS (\n            SELECT id, ROW_NUMBER() OVER () as rn FROM new_enterprises\n        )\n        INSERT INTO temp_created_enterprises (data_row_id, enterprise_id)\n        SELECT s.data_row_id, c.id\n        FROM source_with_rn s\n        JOIN created_with_rn c ON s.rn = c.rn\"\nPL/pgSQL function import.process_enterprise_link_for_legal_unit(integer,int4multirange,text) line 58 at SQL statement\nSQL statement \"CALL import.process_enterprise_link_for_legal_unit($1, $2, $3)\"\nPL/pgSQL function admin.import_job_process_batch(import_job,int4multirange) line 39 at EXECUTE\nSQL statement \"CALL admin.import_job_process_batch(job, v_batch_row_id_ranges)\"\nPL/pgSQL function admin.import_job_processing_phase(import_job) line 28 at CALL\nPL/pgSQL function admin.import_job_process(integer) line 158 at assignment\nSQL statement \"CALL admin.import_job_process(job_id)\"\nPL/pgSQL function admin.import_job_process(jsonb) line 9 at CALL\nSQL statement \"CALL admin.import_job_process($1)\"\nPL/pgSQL function worker.process_tasks(integer,integer,text,bigint) line 93 at EXECUTE", "process_batch_error": "null value in column \"edit_by_user_id\" of relation \"enterprise\" violates not-null constraint"} | 
(26 rows)

\echo ''

\echo '--- Job 2: Formal ES Link Errors (errors_es_formal) ---'
--- Job 2: Formal ES Link Errors (errors_es_formal) ---
SELECT 
    row_id,
    tax_ident_raw as tax_ident,
    name_raw as name,
    state,
    action,
    errors,
    invalid_codes
FROM public.errors_es_formal_data
ORDER BY row_id;
 row_id |  tax_ident  |            name             | state | action |                                                            errors                                                             | invalid_codes 
--------+-------------+-----------------------------+-------+--------+-------------------------------------------------------------------------------------------------------------------------------+---------------
      1 | ES_VALID    | Valid Establishment         | error | skip   | {"legal_unit_tax_ident_raw": "Legal unit not found with provided identifiers."}                                               | {}
      2 | ES_NO_LINK  | ES Missing LU Link          | error | skip   | {"legal_unit_tax_ident_raw": "Missing legal unit identifier.", "legal_unit_stat_ident_raw": "Missing legal unit identifier."} | {}
      3 | ES_BAD_LINK | ES Links to Non-Existent LU | error | skip   | {"legal_unit_tax_ident_raw": "Legal unit not found with provided identifiers."}                                               | {}
      4 | ES_BAD_ACT  | ES Invalid Activity         | error | skip   | {"legal_unit_tax_ident_raw": "Legal unit not found with provided identifiers."}                                               | {}
(4 rows)

\echo ''

\echo '--- Job 3: Missing Identifier Errors (errors_lu_missing_ident) ---'
--- Job 3: Missing Identifier Errors (errors_lu_missing_ident) ---
SELECT 
    row_id,
    tax_ident_raw as tax_ident,
    name_raw as name,
    state,
    action,
    errors,
    invalid_codes
FROM public.errors_lu_missing_ident_data
ORDER BY row_id;
 row_id | tax_ident |       name        | state | action |                                          errors                                           | invalid_codes 
--------+-----------+-------------------+-------+--------+-------------------------------------------------------------------------------------------+---------------
      1 |           | Missing Tax Ident | error | skip   | {"tax_ident_raw": "No identifier specified", "stat_ident_raw": "No identifier specified"} | {}
      2 | HAS_IDENT |                   | error | skip   | {"name_raw": "Missing required name for legal unit."}                                     | {}
(2 rows)

\echo ''

\echo '=== Summary Statistics ==='
=== Summary Statistics ===
SELECT 
    slug,
    COUNT(*) as total_rows,
    COUNT(*) FILTER (WHERE state = 'processed') as processed,
    COUNT(*) FILTER (WHERE state = 'error') as errors,
    COUNT(*) FILTER (WHERE action = 'skip') as skipped,
    COUNT(*) FILTER (WHERE errors IS NOT NULL AND errors != '{}') as rows_with_errors,
    COUNT(*) FILTER (WHERE invalid_codes IS NOT NULL AND invalid_codes != '{}') as rows_with_warnings
FROM (
    SELECT slug, state, action, errors, invalid_codes FROM public.errors_lu_analysis_data, (SELECT 'errors_lu_analysis' as slug) s
    UNION ALL
    SELECT slug, state, action, errors, invalid_codes FROM public.errors_es_formal_data, (SELECT 'errors_es_formal' as slug) s
    UNION ALL
    SELECT slug, state, action, errors, invalid_codes FROM public.errors_lu_missing_ident_data, (SELECT 'errors_lu_missing_ident' as slug) s
) combined
GROUP BY slug
ORDER BY slug;
          slug           | total_rows | processed | errors | skipped | rows_with_errors | rows_with_warnings 
-------------------------+------------+-----------+--------+---------+------------------+--------------------
 errors_es_formal        |          4 |         0 |      4 |       4 |                4 |                  0
 errors_lu_analysis      |         26 |         0 |     26 |      11 |               26 |                 14
 errors_lu_missing_ident |          2 |         0 |      2 |       2 |                2 |                  0
(3 rows)

\echo ''

\echo '=== View in UI ==='
=== View in UI ===
\echo 'Job list:     http://localhost:3012/import/jobs'
Job list:     http://localhost:3012/import/jobs
\echo 'LU Errors:    http://localhost:3012/import/jobs/errors_lu_analysis/data'
LU Errors:    http://localhost:3012/import/jobs/errors_lu_analysis/data
\echo 'ES Errors:    http://localhost:3012/import/jobs/errors_es_formal/data'
ES Errors:    http://localhost:3012/import/jobs/errors_es_formal/data
\echo 'Missing ID:   http://localhost:3012/import/jobs/errors_lu_missing_ident/data'
Missing ID:   http://localhost:3012/import/jobs/errors_lu_missing_ident/data
-- ============================================================================
-- PHASE 5: CLEANUP UNLESS PERSIST
-- ============================================================================
\i test/cleanup_unless_persist_is_specified.sql
---------------------------------------------------------------------------
-- Support development loading of the data without cleanup using
--   ./devops/manage-statbus.sh psql --variable=PERSIST=true < test/sql/400_import_jobs_for_norway_history.sql
--
-- This script is used for tests that commit during execution (e.g., to allow
-- worker.process_tasks() to commit between tasks for better performance).
-- Unlike rollback_unless_persist_is_specified.sql, this performs explicit
-- cleanup since ROLLBACK cannot undo committed transactions.
--
-- NOTE: For 4xx tests running in isolated databases (via test-isolated command),
-- cleanup is unnecessary since the entire database is dropped after the test.
-- We skip the slow reset() call when running in an isolated test database.
-- Ref. https://stackoverflow.com/a/32597876/1023558
\set PERSIST :PERSIST
-- now PERSIST is set to the string ':PERSIST' if was not already set.
-- Checking it using a CASE statement:
SELECT CASE
  WHEN :'PERSIST'= ':PERSIST'
  THEN 'false'
  ELSE :'PERSIST'
END::BOOL AS "PERSIST" \gset
-- < \gset call at end of the query to set variable.
-- Check if we're in an isolated test database (name starts with 'test_')
SELECT current_database() LIKE 'test_%' AS "IS_ISOLATED_TEST" \gset
\if :PERSIST
\echo 'PERSIST=true: Keeping test data for inspection'
\elif :IS_ISOLATED_TEST
\echo 'Isolated test database - skipping cleanup (database will be dropped)'
Isolated test database - skipping cleanup (database will be dropped)
\else
\echo 'Cleaning up test data (use PERSIST=true to keep)'
-- Clean up worker tasks first (may reference import jobs)
DELETE FROM worker.tasks WHERE state IN ('completed', 'failed');
-- Use the reset function to clean up all test data
-- 'data' scope removes: import_jobs, units, activities, locations, etc.
-- but preserves configuration (regions, settings, activity categories)
SELECT public.reset(true, 'data');
\endif
