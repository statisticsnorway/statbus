SET datestyle TO 'ISO, DMY';
BEGIN;
\i test/setup.sql
-- While the datestyle is set for the database, the pg_regress tool sets the MDY format
-- to ensure consistent date formatting, so we must manually override this
SET datestyle TO 'ISO, DMY';
\if :{?DEBUG}
SET client_min_messages TO debug1;
\else
SET client_min_messages TO NOTICE;
\endif
-- Create temporary function to execute queries as system user
CREATE OR REPLACE FUNCTION test.sudo_exec(
    sql text,
    OUT results jsonb
) RETURNS jsonb
SECURITY DEFINER LANGUAGE plpgsql AS $sudo_exec$
DECLARE
    result_rows jsonb;
BEGIN
    -- Check if the SQL starts with common DDL keywords
    IF sql ~* '^\s*(CREATE|DROP|ALTER|TRUNCATE|GRANT|REVOKE|ANALYZE)' THEN
        -- For DDL statements, execute directly
        EXECUTE sql;
        results := '[]'::jsonb;
    ELSE
        -- For DML/queries, wrap in a SELECT to capture results
        EXECUTE format('
            SELECT COALESCE(
                jsonb_agg(row_to_json(t)),
                ''[]''::jsonb
            )
            FROM (%s) t',
            sql
        ) INTO result_rows;
        results := result_rows;
    END IF;
END;
$sudo_exec$;
-- Grant execute to public since this is for testing
GRANT EXECUTE ON FUNCTION test.sudo_exec(text) TO PUBLIC;
\echo Add users for testing purposes
Add users for testing purposes
SELECT * FROM public.user_create('test.admin@statbus.org', 'admin_user'::statbus_role, 'Admin#123!');
         email          |  password  
------------------------+------------
 test.admin@statbus.org | Admin#123!
(1 row)

SELECT * FROM public.user_create('test.regular@statbus.org', 'regular_user'::statbus_role, 'Regular#123!');
          email           |   password   
--------------------------+--------------
 test.regular@statbus.org | Regular#123!
(1 row)

SELECT * FROM public.user_create('test.restricted@statbus.org', 'restricted_user'::statbus_role, 'Restricted#123!');
            email            |    password     
-----------------------------+-----------------
 test.restricted@statbus.org | Restricted#123!
(1 row)

\echo "Test 70: Sad Path - Error Scenarios"
"Test 70: Sad Path - Error Scenarios"
\echo "Setting up Statbus environment for test 70"
"Setting up Statbus environment for test 70"
-- A Super User configures statbus.
CALL test.set_user_from_email('test.admin@statbus.org');
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id,only_one_setting)
SELECT id, true FROM activity_category_standard WHERE code = 'nace_v2.1'
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id =(SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
   WHERE settings.id = EXCLUDED.id;
SELECT acs.code FROM public.settings AS s JOIN activity_category_standard AS acs ON s.activity_category_standard_id = acs.id;
   code    
-----------
 nace_v2.1
(1 row)

\echo "User uploads the sample activity categories, regions, legal forms, sectors"
"User uploads the sample activity categories, regions, legal forms, sectors"
\copy public.activity_category_available_custom(path,name,description) FROM 'samples/norway/activity_category/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.region_upload(path, name) FROM 'samples/norway/regions/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.legal_form_custom_only(code,name) FROM 'samples/norway/legal_form/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\copy public.sector_custom_only(path,name,description) FROM 'samples/norway/sector/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SAVEPOINT main_test_70_start;
\echo "Initial counts before any test block for Test 70"
"Initial counts before any test block for Test 70"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

-- Scenario 70.1: Invalid Codes in Input Data
SAVEPOINT scenario_70_1_invalid_codes;
\echo "Scenario 70.1: Invalid Codes in Input Data"
"Scenario 70.1: Invalid Codes in Input Data"
-- Sub-Scenario 70.1.1: LU Import with Various Analysis Errors
\echo "Sub-Scenario 70.1.1: LU Import with Various Analysis Errors (analyse_valid_time_from_source, analyse_legal_unit, analyse_activity, analyse_tags, analyse_statistical_variables, analyse_location, analyse_status)"
"Sub-Scenario 70.1.1: LU Import with Various Analysis Errors (analyse_valid_time_from_source, analyse_legal_unit, analyse_activity, analyse_tags, analyse_statistical_variables, analyse_location, analyse_status)"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'legal_unit_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_01_01_lu_analysis_errors', 'Test 70.1.1: LU Analysis Errors', 'Test 70.1.1');
END $$;
NOTICE:  identifier "import_70_01_01_lu_analysis_errors_upload_check_state_before_insert" will be truncated to "import_70_01_01_lu_analysis_errors_upload_check_state_before_in"
NOTICE:  identifier "import_70_01_01_lu_analysis_errors_upload_update_state_after_insert" will be truncated to "import_70_01_01_lu_analysis_errors_upload_update_state_after_in"
INSERT INTO public.import_70_01_01_lu_analysis_errors_upload(
    tax_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code, birth_date, death_date,
    secondary_activity_category_code, tag_path, employees, turnover,
    physical_address_part1, physical_region_code, physical_country_iso_2, physical_latitude,
    status_code, data_source_code, unit_size_code,
    postal_address_part1, postal_region_code, postal_country_iso_2
) VALUES
-- Existing errors from original test (NULLs added for new columns)
('700100001','LU Invalid Sector','2023-01-01','2023-12-31','INVALID_SEC','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100002','LU Invalid LF','2023-01-01','2023-12-31','2100','INV_LF','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100003','LU Invalid Activity','2023-01-01','2023-12-31','2100','AS','99.999','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100004','LU Malformed Birth','2023-01-01','2023-12-31','2100','AS','01.110','2023-13-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100005','LU Malformed ValidFrom','NOT_A_DATE','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100006','LU Invalid Period','2023-01-01','2022-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
-- New errors for analyse_valid_time_from_source (NULLs added for new columns)
('700100007','LU Malformed ValidTo','2023-01-01','NOT_A_DATE_TOO','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100008','LU Missing ValidFrom Source',NULL,'2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
('700100009','LU Missing ValidTo Source','2023-01-01',NULL,'2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
-- New errors for analyse_legal_unit (NULLs added for new columns)
('700100010','LU Invalid DataSource','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown','INVALID_DS',NULL,NULL,NULL,NULL),
('700100011','LU Invalid UnitSize','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,'BIGGER',NULL,NULL,NULL),
('700100012','LU Malformed DeathDate','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01','2023-02-30',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- New error for analyse_activity (secondary) (NULLs added for new columns)
('700100013','LU Invalid SecondaryActivity','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,'88.888',NULL,NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- New errors for analyse_tags (NULLs added for new columns)
('700100014','LU Invalid Tag Format','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,'a b c',NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100015','LU Tag NotFound','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,'non.existent.tag',NULL,NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- New errors for analyse_statistical_variables (NULLs added for new columns)
('700100016','LU Invalid Int Stat','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,'abc',NULL,NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100017','LU Invalid Float Stat','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,'xyz',NULL,NULL,NULL,NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- New errors for analyse_location (physical) (NULLs added for new columns)
('700100018','LU Invalid PhysRegion','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,'XX','NO',NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100019','LU Invalid PhysCountry NF','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,'ZZ',NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100020','LU Invalid PhysCountry F','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,'Street 1','01','ZZ',NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100021','LU Invalid PhysLat Format','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,'NO','abc','inactive_unknown',NULL,NULL,NULL,NULL,NULL),
('700100022','LU PhysLat Range','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,'NO','91.0','inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- Row for postal location tests (NULLs added for new columns)
('700100023','LU For Postal Location','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,'NO',NULL,'inactive_unknown',NULL,NULL,NULL,NULL,NULL),
-- New soft error test cases
('700100026','LU Invalid Status (Default Active)','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'sleeping_unknown',NULL,NULL,NULL,NULL,NULL), -- invalid_codes: {status_code}, uses default
('700100028','LU Invalid PostalRegion','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'active',NULL,NULL,NULL,'POSTAL_XX',NULL), -- invalid_codes: {postal_region_code}
('700100029','LU Invalid PostalCountry NF','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'active',NULL,NULL,NULL,NULL,'P_ZZ'); -- invalid_codes: {postal_country_iso_2}
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_01_01_lu_analysis_errors:"
"Job status for import_70_01_01_lu_analysis_errors:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_70_01_01_lu_analysis_errors' ORDER BY slug;
                slug                |  state   | total_rows | imported_rows | has_error | error_details 
------------------------------------+----------+------------+---------------+-----------+---------------
 import_70_01_01_lu_analysis_errors | finished |         26 |            13 | f         | 
(1 row)

\echo "Data table for import_70_01_01_lu_analysis_errors (expect various errors and invalid_codes):"
"Data table for import_70_01_01_lu_analysis_errors (expect various errors and invalid_codes):"
SELECT
    row_id,
    name,
    state,
    action,
    derived_valid_from,
    derived_valid_to,
    error,
    invalid_codes,
    -- Include potentially affected resolved IDs to verify soft error handling
    status_id,
    (SELECT COUNT(*) FROM public.location l WHERE l.legal_unit_id = (SELECT legal_unit_id FROM public.import_70_01_01_lu_analysis_errors_data d_lu WHERE d_lu.row_id = d.row_id AND d_lu.legal_unit_id IS NOT NULL) AND l.type='postal') as postal_location_count
FROM public.import_70_01_01_lu_analysis_errors_data d ORDER BY row_id;
 row_id |                name                |   state   | action | derived_valid_from | derived_valid_to |                                                                                                                         error                                                                                                                          |                                   invalid_codes                                   | status_id | postal_location_count 
--------+------------------------------------+-----------+--------+--------------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------+-----------+-----------------------
      1 | LU Invalid Sector                  | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"sector_code": "INVALID_SEC"}                                                    |         1 |                     0
      2 | LU Invalid LF                      | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"legal_form_code": "INV_LF"}                                                     |         1 |                     0
      3 | LU Invalid Activity                | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"primary_activity_category_code": "99.999"}                                      |         1 |                     0
      4 | LU Malformed Birth                 | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"birth_date": "2023-13-01"}                                                      |         1 |                     0
      5 | LU Malformed ValidFrom             | error     | skip   |                    | 2023-12-31       | {"valid_from": "Invalid date format: 'NOT_A_DATE'. SQLSTATE: 22007"}                                                                                                                                                                                   |                                                                                   |           |                     0
      6 | LU Invalid Period                  | error     | skip   | 2023-01-01         | 2022-12-31       | {"valid_to": "Resulting period is invalid: derived_valid_after (2022-12-31 00:00:00) is not before valid_to (2022-12-31)", "valid_from": "Resulting period is invalid: derived_valid_after (2022-12-31 00:00:00) is not before valid_to (2022-12-31)"} |                                                                                   |           |                     0
      7 | LU Malformed ValidTo               | error     | skip   | 2023-01-01         |                  | {"valid_to": "Invalid date format: 'NOT_A_DATE_TOO'. SQLSTATE: 22007"}                                                                                                                                                                                 |                                                                                   |           |                     0
      8 | LU Missing ValidFrom Source        | error     | skip   |                    | 2023-12-31       | {"valid_from": "Missing mandatory value"}                                                                                                                                                                                                              |                                                                                   |           |                     0
      9 | LU Missing ValidTo Source          | error     | skip   | 2023-01-01         |                  | {"valid_to": "Missing mandatory value"}                                                                                                                                                                                                                |                                                                                   |           |                     0
     10 | LU Invalid DataSource              | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown", "data_source_code": "INVALID_DS"}             |         1 |                     0
     11 | LU Invalid UnitSize                | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown", "unit_size_code": "BIGGER"}                   |         1 |                     0
     12 | LU Malformed DeathDate             | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"death_date": "2023-02-30", "status_code": "inactive_unknown"}                   |         1 |                     0
     13 | LU Invalid SecondaryActivity       | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown", "secondary_activity_category_code": "88.888"} |         1 |                     0
     14 | LU Invalid Tag Format              | error     | skip   | 2023-01-01         | 2023-12-31       | {"tag_path": "Failed to cast 'a b c' to ltree. SQLSTATE: 42601, SQLERRM: ltree syntax error at character 2"}                                                                                                                                           | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     15 | LU Tag NotFound                    | error     | skip   | 2023-01-01         | 2023-12-31       | {"tag_path": "Tag not found for path: non.existent.tag"}                                                                                                                                                                                               | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     16 | LU Invalid Int Stat                | error     | skip   | 2023-01-01         | 2023-12-31       | {"employees": "Invalid integer format: 'abc'. SQLSTATE: 22P02"}                                                                                                                                                                                        | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     17 | LU Invalid Float Stat              | error     | skip   | 2023-01-01         | 2023-12-31       | {"turnover": "Invalid numeric format: 'xyz'. SQLSTATE: 22P02"}                                                                                                                                                                                         | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     18 | LU Invalid PhysRegion              | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown", "physical_region_code": "XX"}                 |         1 |                     0
     19 | LU Invalid PhysCountry NF          | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown", "physical_country_iso_2": "ZZ"}               |         1 |                     0
     20 | LU Invalid PhysCountry F           | error     | skip   | 2023-01-01         | 2023-12-31       | {"physical_country_iso_2": "Country is required and must be valid when other physical address details are provided."}                                                                                                                                  | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     21 | LU Invalid PhysLat Format          | error     | skip   | 2023-01-01         | 2023-12-31       | {"physical_latitude": "Value 'abc' is not a valid numeric representation for type NUMERIC(9,6). SQLSTATE: 22P02"}                                                                                                                                      | {"status_code": "inactive_unknown", "physical_latitude": "abc"}                   |         1 |                     0
     22 | LU PhysLat Range                   | error     | skip   | 2023-01-01         | 2023-12-31       | {"physical_latitude": "Value '91.000000' out of range. Expected -90 to 90."}                                                                                                                                                                           | {"status_code": "inactive_unknown", "physical_latitude": "91.0"}                  |         1 |                     0
     23 | LU For Postal Location             | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "inactive_unknown"}                                               |         1 |                     0
     24 | LU Invalid Status (Default Active) | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"status_code": "sleeping_unknown"}                                               |         1 |                     0
     25 | LU Invalid PostalRegion            | error     | skip   | 2023-01-01         | 2023-12-31       | {"postal_country_iso_2": "Country is required and must be valid when other postal address details are provided."}                                                                                                                                      | {}                                                                                |         1 |                     0
     26 | LU Invalid PostalCountry NF        | processed | insert | 2023-01-01         | 2023-12-31       |                                                                                                                                                                                                                                                        | {"postal_country_iso_2": "P_ZZ"}                                                  |         1 |                     0
(26 rows)

-- Test for analyse_status errors (requires temporarily disabling default status)
SAVEPOINT before_no_default_status_test_70_1_1;
\echo "Temporarily disabling default status for analyse_status tests..."
"Temporarily disabling default status for analyse_status tests..."
UPDATE public.status SET assigned_by_default = false WHERE code = 'active'; -- Assuming 'active' is the default
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'legal_unit_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_01_01_lu_status_errors', 'Test 70.1.1: LU Status Errors (No Default)', 'Test 70.1.1');
END $$;
NOTICE:  identifier "import_70_01_01_lu_status_errors_upload_check_state_before_insert" will be truncated to "import_70_01_01_lu_status_errors_upload_check_state_before_inse"
NOTICE:  identifier "import_70_01_01_lu_status_errors_upload_update_state_after_insert" will be truncated to "import_70_01_01_lu_status_errors_upload_update_state_after_inse"
INSERT INTO public.import_70_01_01_lu_status_errors_upload(
    tax_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code, birth_date, status_code
) VALUES
('700100024','LU Invalid Status NoDefault','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01','INVALID_STATUS'), -- error: {status_code: "Provided status_code 'INVALID_STATUS' not found/active and no default available"}, action: skip
('700100025','LU No Status NoDefault','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL); -- error: {status_code: "Status code not provided and no active default status found"}, action: skip
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_01_01_lu_status_errors:"
"Job status for import_70_01_01_lu_status_errors:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error, error as error_details FROM public.import_job WHERE slug = 'import_70_01_01_lu_status_errors' ORDER BY slug;
               slug               |  state   | total_rows | imported_rows | has_error | error_details 
----------------------------------+----------+------------+---------------+-----------+---------------
 import_70_01_01_lu_status_errors | finished |          2 |             0 | f         | 
(1 row)

\echo "Data table for import_70_01_01_lu_status_errors (expect status_code errors):"
"Data table for import_70_01_01_lu_status_errors (expect status_code errors):"
SELECT row_id, name, state, action, status_id, error, invalid_codes FROM public.import_70_01_01_lu_status_errors_data ORDER BY row_id;
 row_id |            name             | state | action | status_id |                                               error                                                | invalid_codes 
--------+-----------------------------+-------+--------+-----------+----------------------------------------------------------------------------------------------------+---------------
      1 | LU Invalid Status NoDefault | error | skip   |           | {"status_code": "Provided status_code 'INVALID_STATUS' not found/active and no default available"} | 
      2 | LU No Status NoDefault      | error | skip   |           | {"status_code": "Status code not provided and no active default status found"}                     | 
(2 rows)

\echo "Restoring default status..."
"Restoring default status..."
ROLLBACK TO before_no_default_status_test_70_1_1;
-- Sub-Scenario 70.1.2: Formal ES Import with Invalid Codes
\echo "Sub-Scenario 70.1.2: Formal ES Import with Invalid Codes"
"Sub-Scenario 70.1.2: Formal ES Import with Invalid Codes"
DO $$
DECLARE v_lu_def_id INT; v_es_def_id INT;
BEGIN
    SELECT id INTO v_lu_def_id FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
    IF v_lu_def_id IS NULL THEN RAISE EXCEPTION 'Import definition legal_unit_explicit_dates not found.'; END IF;
    SELECT id INTO v_es_def_id FROM public.import_definition WHERE slug = 'establishment_for_lu_explicit_dates';
    IF v_es_def_id IS NULL THEN RAISE EXCEPTION 'Import definition establishment_for_lu_explicit_dates not found.'; END IF;

    INSERT INTO public.import_job (definition_id, slug, description, edit_comment) VALUES (v_lu_def_id, 'import_70_01_02_lu_for_es', 'Test 70.1.2: Valid LU for ES', 'Test 70.1.2');
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment) VALUES (v_es_def_id, 'import_70_01_02_es_invalid', 'Test 70.1.2: Formal ES Invalid Codes', 'Test 70.1.2');
END $$;
INSERT INTO public.import_70_01_02_lu_for_es_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,sector_code,legal_form_code) VALUES
('700102001','Valid LU for ES Test','2023-01-01','2023-12-31','01.110','2100','AS');
INSERT INTO public.import_70_01_02_es_invalid_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,legal_unit_tax_ident) VALUES
('E70010201','Formal ES Invalid Activity','2023-01-01','2023-12-31','99.998','700102001');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_01_02_es_invalid:"
"Job status for import_70_01_02_es_invalid:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_01_02_es_invalid' ORDER BY slug;
            slug            |  state   | total_rows | imported_rows | has_error 
----------------------------+----------+------------+---------------+-----------
 import_70_01_02_es_invalid | finished |          1 |             1 | f
(1 row)

\echo "Data table for import_70_01_02_es_invalid (expect errors):"
"Data table for import_70_01_02_es_invalid (expect errors):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_01_02_es_invalid_data ORDER BY row_id;
 row_id |   state   | action | derived_valid_from | derived_valid_to | error |                invalid_codes                 
--------+-----------+--------+--------------------+------------------+-------+----------------------------------------------
      1 | processed | insert | 2023-01-01         | 2023-12-31       |       | {"primary_activity_category_code": "99.998"}
(1 row)

-- Sub-Scenario 70.1.3: Informal ES Import with Invalid Codes
\echo "Sub-Scenario 70.1.3: Informal ES Import with Invalid Codes"
"Sub-Scenario 70.1.3: Informal ES Import with Invalid Codes"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'establishment_without_lu_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_01_03_es_inf_invalid', 'Test 70.1.3: Informal ES Invalid Codes', 'Test 70.1.3');
END $$;
INSERT INTO public.import_70_01_03_es_inf_invalid_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code) VALUES
('E70010301','Informal ES Invalid Activity','2023-01-01','2023-12-31','99.997');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_01_03_es_inf_invalid:"
"Job status for import_70_01_03_es_inf_invalid:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_01_03_es_inf_invalid' ORDER BY slug;
              slug              |  state   | total_rows | imported_rows | has_error 
--------------------------------+----------+------------+---------------+-----------
 import_70_01_03_es_inf_invalid | finished |          1 |             1 | f
(1 row)

\echo "Data table for import_70_01_03_es_inf_invalid (expect errors):"
"Data table for import_70_01_03_es_inf_invalid (expect errors):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_01_03_es_inf_invalid_data ORDER BY row_id;
 row_id |   state   | action | derived_valid_from | derived_valid_to | error |                invalid_codes                 
--------+-----------+--------+--------------------+------------------+-------+----------------------------------------------
      1 | processed | insert | 2023-01-01         | 2023-12-31       |       | {"primary_activity_category_code": "99.997"}
(1 row)

ROLLBACK TO scenario_70_1_invalid_codes;
-- Scenario 70.2: Missing Mandatory Data
SAVEPOINT scenario_70_2_missing_data;
\echo "Scenario 70.2: Missing Mandatory Data"
"Scenario 70.2: Missing Mandatory Data"
-- Sub-Scenario 70.2.1: LU Import - Missing Core Fields
\echo "Sub-Scenario 70.2.1: LU Import - Missing Core Fields"
"Sub-Scenario 70.2.1: LU Import - Missing Core Fields"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'legal_unit_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_02_01_lu_missing', 'Test 70.2.1: LU Missing Core', 'Test 70.2.1');
END $$;
INSERT INTO public.import_70_02_01_lu_missing_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,sector_code,legal_form_code) VALUES
(NULL,'LU Missing TaxIdent','2023-01-01','2023-12-31','01.110','2100','AS'),
('700201002',NULL,'2023-01-01','2023-12-31','01.110','2100','AS'),
('700201003','LU Missing ValidFrom',NULL,'2023-12-31','01.110','2100','AS');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_02_01_lu_missing:"
"Job status for import_70_02_01_lu_missing:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_02_01_lu_missing' ORDER BY slug;
            slug            |  state   | total_rows | imported_rows | has_error 
----------------------------+----------+------------+---------------+-----------
 import_70_02_01_lu_missing | finished |          3 |             0 | f
(1 row)

\echo "Data table for import_70_02_01_lu_missing (expect errors, e.g., in analyse_external_idents):"
"Data table for import_70_02_01_lu_missing (expect errors, e.g., in analyse_external_idents):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_02_01_lu_missing_data ORDER BY row_id;
 row_id | state | action | derived_valid_from | derived_valid_to |                                       error                                       | invalid_codes 
--------+-------+--------+--------------------+------------------+-----------------------------------------------------------------------------------+---------------
      1 | error | skip   |                    |                  | {"tax_ident": "No identifier specified", "stat_ident": "No identifier specified"} | 
      2 | error | skip   | 2023-01-01         | 2023-12-31       | {"name": "Missing required name"}                                                 | 
      3 | error | skip   |                    | 2023-12-31       | {"valid_from": "Missing mandatory value"}                                         | 
(3 rows)

-- Sub-Scenario 70.2.2: Formal ES Import - Missing Link
\echo "Sub-Scenario 70.2.2: Formal ES Import - Missing Link to LU"
"Sub-Scenario 70.2.2: Formal ES Import - Missing Link to LU"
DO $$
DECLARE v_lu_def_id INT; v_es_def_id INT;
BEGIN
    SELECT id INTO v_lu_def_id FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
    IF v_lu_def_id IS NULL THEN RAISE EXCEPTION 'Import definition legal_unit_explicit_dates not found.'; END IF;
    SELECT id INTO v_es_def_id FROM public.import_definition WHERE slug = 'establishment_for_lu_explicit_dates';
    IF v_es_def_id IS NULL THEN RAISE EXCEPTION 'Import definition establishment_for_lu_explicit_dates not found.'; END IF;

    INSERT INTO public.import_job (definition_id, slug, description, edit_comment) VALUES (v_lu_def_id, 'import_70_02_02_lu_for_es_link', 'Test 70.2.2: Valid LU for ES', 'Test 70.2.2');
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment) VALUES (v_es_def_id, 'import_70_02_02_es_missing_link', 'Test 70.2.2: Formal ES Missing LU Link', 'Test 70.2.2');
END $$;
NOTICE:  identifier "import_70_02_02_es_missing_link_upload_check_state_before_insert" will be truncated to "import_70_02_02_es_missing_link_upload_check_state_before_inser"
NOTICE:  identifier "import_70_02_02_es_missing_link_upload_update_state_after_insert" will be truncated to "import_70_02_02_es_missing_link_upload_update_state_after_inser"
INSERT INTO public.import_70_02_02_lu_for_es_link_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,sector_code,legal_form_code) VALUES
('700202001','Valid LU for ES Link Test','2023-01-01','2023-12-31','01.110','2100','AS');
INSERT INTO public.import_70_02_02_es_missing_link_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,legal_unit_tax_ident) VALUES
('E70020201','Formal ES Missing LU Link','2023-01-01','2023-12-31','01.110',NULL);
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_02_02_es_missing_link:"
"Job status for import_70_02_02_es_missing_link:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_02_02_es_missing_link' ORDER BY slug;
              slug               |  state   | total_rows | imported_rows | has_error 
---------------------------------+----------+------------+---------------+-----------
 import_70_02_02_es_missing_link | finished |          1 |             0 | f
(1 row)

\echo "Data table for import_70_02_02_es_missing_link (expect errors in analyse_establishment_legal_unit_link):"
"Data table for import_70_02_02_es_missing_link (expect errors in analyse_establishment_legal_unit_link):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_02_02_es_missing_link_data ORDER BY row_id;
 row_id | state | action | derived_valid_from | derived_valid_to |                                                         error                                                         | invalid_codes 
--------+-------+--------+--------------------+------------------+-----------------------------------------------------------------------------------------------------------------------+---------------
      1 | error | skip   | 2023-01-01         | 2023-12-31       | {"legal_unit_tax_ident": "Missing legal unit identifier.", "legal_unit_stat_ident": "Missing legal unit identifier."} | 
(1 row)

ROLLBACK TO scenario_70_2_missing_data;
-- Scenario 70.3: Referential Integrity Errors during Processing
SAVEPOINT scenario_70_3_referential_integrity;
\echo "Scenario 70.3: Referential Integrity Errors during Processing"
"Scenario 70.3: Referential Integrity Errors during Processing"
-- Sub-Scenario 70.3.1: Formal ES links to Non-Existent LU
\echo "Sub-Scenario 70.3.1: Formal ES links to Non-Existent LU"
"Sub-Scenario 70.3.1: Formal ES links to Non-Existent LU"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'establishment_for_lu_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_03_01_es_bad_lu_link', 'Test 70.3.1: ES Bad LU Link', 'Test 70.3.1');
END $$;
INSERT INTO public.import_70_03_01_es_bad_lu_link_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,legal_unit_tax_ident) VALUES
('E70030101','Formal ES Bad LU Link','2023-01-01','2023-12-31','01.110','NON_EXISTENT_LU_TAX_ID');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_03_01_es_bad_lu_link:"
"Job status for import_70_03_01_es_bad_lu_link:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_03_01_es_bad_lu_link' ORDER BY slug;
              slug              |  state   | total_rows | imported_rows | has_error 
--------------------------------+----------+------------+---------------+-----------
 import_70_03_01_es_bad_lu_link | finished |          1 |             0 | f
(1 row)

\echo "Data table for import_70_03_01_es_bad_lu_link (expect errors in process_establishment or analyse_establishment_legal_unit_link):"
"Data table for import_70_03_01_es_bad_lu_link (expect errors in process_establishment or analyse_establishment_legal_unit_link):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_03_01_es_bad_lu_link_data ORDER BY row_id;
 row_id | state | action | derived_valid_from | derived_valid_to |                                    error                                    | invalid_codes 
--------+-------+--------+--------------------+------------------+-----------------------------------------------------------------------------+---------------
      1 | error | skip   | 2023-01-01         | 2023-12-31       | {"legal_unit_tax_ident": "Legal unit not found with provided identifiers."} | 
(1 row)

ROLLBACK TO scenario_70_3_referential_integrity;
-- Scenario 70.4: Constraint Violations Not Caught by Analysis (Placeholder)
SAVEPOINT scenario_70_4_constraint_violations;
\echo "Scenario 70.4: Constraint Violations Not Caught by Analysis (Placeholder - difficult to reliably simulate if analysis is robust)"
"Scenario 70.4: Constraint Violations Not Caught by Analysis (Placeholder - difficult to reliably simulate if analysis is robust)"
-- No specific tests here yet, as these often depend on specific DB constraints not covered by analysis.
ROLLBACK TO scenario_70_4_constraint_violations;
-- Scenario 70.5: File-Level Errors (Placeholder)
SAVEPOINT scenario_70_5_file_errors;
\echo "Scenario 70.5: File-Level Errors (Placeholder - \copy errors are typically fatal to the psql script itself or hard to verify at job level)"
"Scenario 70.5: File-Level Errors (Placeholder - \copy errors are typically fatal to the psql script itself or hard to verify at job level)"
-- These errors (e.g. wrong delimiter, column count mismatch) usually cause \copy to fail.
-- The import job might not even reach a state where its status can be easily checked for these specific \copy failures.
-- If \copy succeeds but data is malformed leading to prepare step failure, that's a different case.
ROLLBACK TO scenario_70_5_file_errors;
-- Scenario 70.6: Errors in batch_insert_or_replace_generic_valid_time_table
SAVEPOINT scenario_70_6_batch_replace_errors;
\echo "Scenario 70.6: Errors in batch_insert_or_replace_generic_valid_time_table"
"Scenario 70.6: Errors in batch_insert_or_replace_generic_valid_time_table"
-- Sub-Scenario 70.6.1: Unexpected NULL for NOT NULL column (e.g. empty name for LU)
\echo "Sub-Scenario 70.6.1: LU with empty name (assuming name is NOT NULL in public.legal_unit)"
"Sub-Scenario 70.6.1: LU with empty name (assuming name is NOT NULL in public.legal_unit)"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'legal_unit_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    IF v_definition_id IS NULL THEN RAISE EXCEPTION 'Import definition % not found.', v_definition_slug; END IF;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_06_01_lu_empty_name', 'Test 70.6.1: LU Empty Name', 'Test 70.6.1');
END $$;
INSERT INTO public.import_70_06_01_lu_empty_name_upload(tax_ident,name,valid_from,valid_to,primary_activity_category_code,sector_code,legal_form_code) VALUES
('700601001',NULL,'2023-01-01','2023-12-31','01.110','2100','AS');
CALL worker.process_tasks(p_queue => 'import');
\echo "Job status for import_70_06_01_lu_empty_name:"
"Job status for import_70_06_01_lu_empty_name:"
SELECT slug, state, total_rows, imported_rows, error IS NOT NULL AS has_error FROM public.import_job WHERE slug = 'import_70_06_01_lu_empty_name' ORDER BY slug;
             slug              |  state   | total_rows | imported_rows | has_error 
-------------------------------+----------+------------+---------------+-----------
 import_70_06_01_lu_empty_name | finished |          1 |             0 | f
(1 row)

\echo "Data table for import_70_06_01_lu_empty_name (expect errors in process_legal_unit from batch_replace):"
"Data table for import_70_06_01_lu_empty_name (expect errors in process_legal_unit from batch_replace):"
SELECT row_id, state, action, derived_valid_from, derived_valid_to, error, invalid_codes FROM public.import_70_06_01_lu_empty_name_data ORDER BY row_id;
 row_id | state | action | derived_valid_from | derived_valid_to |               error               | invalid_codes 
--------+-------+--------+--------------------+------------------+-----------------------------------+---------------
      1 | error | skip   | 2023-01-01         | 2023-12-31       | {"name": "Missing required name"} | 
(1 row)

ROLLBACK TO scenario_70_6_batch_replace_errors;
-- Scenario 70.7: analyse_external_idents Errors
SAVEPOINT scenario_70_7_external_idents_errors;
\echo "Scenario 70.7: analyse_external_idents Errors"
"Scenario 70.7: analyse_external_idents Errors"
-- Setup common to 70.7.x: Create some LUs, ESTs for conflict checks
DO $$
DECLARE
    v_user_id INT;
    v_lu1_id INT; v_lu2_id INT;
    v_est1_id INT; v_est2_id INT; v_est_formal_id INT;
    v_ent1_id INT;
    v_ent_for_lu1_id INT; v_ent_for_lu2_id INT; -- Added variables for LU enterprises

    -- Variables for patching definitions
    v_lu_def_id_patch INT;
    v_esf_def_id_patch INT;
    v_esi_def_id_patch INT;
    v_def_ids_to_patch INT[];
    v_current_def_id_patch INT;
    v_ext_idents_step_id_patch INT;
    v_custom_ident_data_col_id_patch INT;
    v_new_source_col_id_patch INT;
    v_max_priority_patch INT;
BEGIN
    SELECT id INTO v_user_id FROM public.user WHERE email = 'test.admin@statbus.org';

    -- Ensure custom_est_ident type exists for this test block
    INSERT INTO public.external_ident_type (code, name, description, priority)
    VALUES ('custom_est_ident', 'Custom Establishment Identifier', 'A custom identifier type for testing establishment scenarios.', 10)
    ON CONFLICT (code) DO NOTHING;

    -- Force lifecycle callback to run to ensure import_data_column for 'custom_est_ident' exists.
    CALL import.generate_external_ident_data_columns();

    -- Patch affected import definitions to include mappings for 'custom_est_ident'
    SELECT id INTO v_lu_def_id_patch FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
    SELECT id INTO v_esf_def_id_patch FROM public.import_definition WHERE slug = 'establishment_for_lu_explicit_dates';
    SELECT id INTO v_esi_def_id_patch FROM public.import_definition WHERE slug = 'establishment_without_lu_explicit_dates';
    v_def_ids_to_patch := ARRAY[v_lu_def_id_patch, v_esf_def_id_patch, v_esi_def_id_patch];

    SELECT id INTO v_ext_idents_step_id_patch FROM public.import_step WHERE code = 'external_idents';
    IF NOT FOUND THEN RAISE EXCEPTION 'Step "external_idents" not found for patching.'; END IF;

    SELECT id INTO v_custom_ident_data_col_id_patch FROM public.import_data_column
    WHERE step_id = v_ext_idents_step_id_patch AND column_name = 'custom_est_ident' AND purpose = 'source_input';
    IF NOT FOUND THEN RAISE EXCEPTION 'Data column "custom_est_ident" for "external_idents" step not found for patching.'; END IF;

    FOREACH v_current_def_id_patch IN ARRAY v_def_ids_to_patch
    LOOP
        IF v_current_def_id_patch IS NULL THEN
            RAISE WARNING 'A definition ID for patching was NULL, skipping.';
            CONTINUE;
        END IF;

        -- Create source column if it doesn't exist
        IF NOT EXISTS (SELECT 1 FROM public.import_source_column WHERE definition_id = v_current_def_id_patch AND column_name = 'custom_est_ident') THEN
            SELECT COALESCE(MAX(priority), 0) + 1 INTO v_max_priority_patch FROM public.import_source_column WHERE definition_id = v_current_def_id_patch;
            INSERT INTO public.import_source_column (definition_id, column_name, priority)
            VALUES (v_current_def_id_patch, 'custom_est_ident', v_max_priority_patch)
            RETURNING id INTO v_new_source_col_id_patch;
            RAISE NOTICE 'Test 70.7 Patcher: Added import_source_column for "custom_est_ident" to definition slug %.', (SELECT slug FROM public.import_definition WHERE id = v_current_def_id_patch);
        ELSE
            SELECT id INTO v_new_source_col_id_patch FROM public.import_source_column WHERE definition_id = v_current_def_id_patch AND column_name = 'custom_est_ident';
            RAISE NOTICE 'Test 70.7 Patcher: Found existing import_source_column for "custom_est_ident" for definition slug %.', (SELECT slug FROM public.import_definition WHERE id = v_current_def_id_patch);
        END IF;

        -- Create or update mapping to be not ignored
        INSERT INTO public.import_mapping (definition_id, source_column_id, target_data_column_id, target_data_column_purpose, is_ignored)
        VALUES (v_current_def_id_patch, v_new_source_col_id_patch, v_custom_ident_data_col_id_patch, 'source_input'::public.import_data_column_purpose, FALSE)
        ON CONFLICT (definition_id, source_column_id, target_data_column_id)
        DO UPDATE SET is_ignored = FALSE, target_data_column_purpose = EXCLUDED.target_data_column_purpose;
        RAISE NOTICE 'Test 70.7 Patcher: Ensured mapping for "custom_est_ident" to data column "custom_est_ident" (purpose: source_input) is NOT IGNORED for definition slug %.', (SELECT slug FROM public.import_definition WHERE id = v_current_def_id_patch);
        
        -- Re-validate the definition
        PERFORM admin.validate_import_definition(v_current_def_id_patch);
        RAISE NOTICE 'Test 70.7 Patcher: Re-validated definition slug %.', (SELECT slug FROM public.import_definition WHERE id = v_current_def_id_patch);

    END LOOP;

    -- Enterprise for LU1
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT for LU1 70.7', v_user_id, now()) RETURNING id INTO v_ent_for_lu1_id;

    -- LU1
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at)
    VALUES (v_ent_for_lu1_id, 'LU1 for 70.7', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now()) RETURNING id INTO v_lu1_id;
    INSERT INTO public.external_ident (legal_unit_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_lu1_id, (SELECT id FROM public.external_ident_type WHERE code = 'tax_ident'), 'LU7071_TAX', v_user_id, now()),
           (v_lu1_id, (SELECT id FROM public.external_ident_type WHERE code = 'stat_ident'), 'LU7071_STAT', v_user_id, now());

    -- Enterprise for LU2
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at)
    VALUES ('ENT for LU2 70.7', v_user_id, now()) RETURNING id INTO v_ent_for_lu2_id;

    -- LU2
    INSERT INTO public.legal_unit (enterprise_id, name, status_id, primary_for_enterprise, edit_by_user_id, edit_at)
    VALUES (v_ent_for_lu2_id, 'LU2 for 70.7', (SELECT id FROM public.status WHERE code = 'active'), true, v_user_id, now()) RETURNING id INTO v_lu2_id;
    INSERT INTO public.external_ident (legal_unit_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_lu2_id, (SELECT id FROM public.external_ident_type WHERE code = 'stat_ident'), 'LU7072_STAT', v_user_id, now());

    -- EST1 (Informal)
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at) VALUES ('ENT1 70.7 EST1', v_user_id, now()) RETURNING id INTO v_ent1_id;
    INSERT INTO public.establishment (name, status_id, enterprise_id, primary_for_enterprise, edit_by_user_id, edit_at)
    VALUES ('EST1 for 70.7 (Informal)', (SELECT id FROM public.status WHERE code = 'active'), v_ent1_id, true, v_user_id, now()) RETURNING id INTO v_est1_id;
    INSERT INTO public.external_ident (establishment_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_est1_id, (SELECT id FROM public.external_ident_type WHERE code = 'tax_ident'), 'EST7071_TAX', v_user_id, now());

    -- EST2 (Informal, different enterprise)
    INSERT INTO public.enterprise (short_name, edit_by_user_id, edit_at) VALUES ('ENT2 70.7 EST2', v_user_id, now()) RETURNING id INTO v_ent1_id; -- Re-use v_ent1_id for new enterprise
    INSERT INTO public.establishment (name, status_id, enterprise_id, primary_for_enterprise, edit_by_user_id, edit_at)
    VALUES ('EST2 for 70.7 (Informal)', (SELECT id FROM public.status WHERE code = 'active'), v_ent1_id, true, v_user_id, now()) RETURNING id INTO v_est2_id;
    INSERT INTO public.external_ident (establishment_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_est2_id, (SELECT id FROM public.external_ident_type WHERE code = 'custom_est_ident'), 'EST7072_CUSTOM', v_user_id, now());

    -- EST_FORMAL (Formal, linked to LU1)
    INSERT INTO public.establishment (name, status_id, legal_unit_id, primary_for_legal_unit, edit_by_user_id, edit_at)
    VALUES ('EST_FORMAL for 70.7', (SELECT id FROM public.status WHERE code = 'active'), v_lu1_id, true, v_user_id, now()) RETURNING id INTO v_est_formal_id;
    INSERT INTO public.external_ident (establishment_id, type_id, ident, edit_by_user_id, edit_at)
    VALUES (v_est_formal_id, (SELECT id FROM public.external_ident_type WHERE code = 'tax_ident'), 'EST707F_TAX', v_user_id, now());

END $$;
NOTICE:  Cleaning up dynamic external_ident data columns...
NOTICE:  Finished cleaning up dynamic external_ident data columns.
NOTICE:  Dropped index su_ei_stat_ident_idx
NOTICE:  Dropped index su_ei_tax_ident_idx
NOTICE:  Dropped index su_s_employees_idx
NOTICE:  Dropped index su_s_turnover_idx
NOTICE:  Dropped index su_ss_employees_count_idx
NOTICE:  Dropped index su_ss_employees_sum_idx
NOTICE:  Dropped index su_ss_turnover_count_idx
NOTICE:  Dropped index su_ss_turnover_sum_idx
NOTICE:  Created index su_ei_tax_ident for external_ident_type
NOTICE:  Created index su_ei_stat_ident for external_ident_type
NOTICE:  Created index su_ei_custom_est_ident for external_ident_type
NOTICE:  Created indices for stat_definition employees
NOTICE:  Created indices for stat_definition turnover
NOTICE:  Test 70.7 Patcher: Found existing import_source_column for "custom_est_ident" for definition slug legal_unit_explicit_dates.
NOTICE:  Test 70.7 Patcher: Ensured mapping for "custom_est_ident" to data column "custom_est_ident" (purpose: source_input) is NOT IGNORED for definition slug legal_unit_explicit_dates.
NOTICE:  Test 70.7 Patcher: Re-validated definition slug legal_unit_explicit_dates.
NOTICE:  Test 70.7 Patcher: Found existing import_source_column for "custom_est_ident" for definition slug establishment_for_lu_explicit_dates.
NOTICE:  Test 70.7 Patcher: Ensured mapping for "custom_est_ident" to data column "custom_est_ident" (purpose: source_input) is NOT IGNORED for definition slug establishment_for_lu_explicit_dates.
NOTICE:  Test 70.7 Patcher: Re-validated definition slug establishment_for_lu_explicit_dates.
NOTICE:  Test 70.7 Patcher: Found existing import_source_column for "custom_est_ident" for definition slug establishment_without_lu_explicit_dates.
NOTICE:  Test 70.7 Patcher: Ensured mapping for "custom_est_ident" to data column "custom_est_ident" (purpose: source_input) is NOT IGNORED for definition slug establishment_without_lu_explicit_dates.
NOTICE:  Test 70.7 Patcher: Re-validated definition slug establishment_without_lu_explicit_dates.
-- Sub-Scenario 70.7.1: Mode 'legal_unit' (using 'legal_unit_explicit_dates')
\echo "Sub-Scenario 70.7.1: analyse_external_idents - Mode 'legal_unit'"
"Sub-Scenario 70.7.1: analyse_external_idents - Mode 'legal_unit'"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'legal_unit_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_07_01_lu_idents', 'Test 70.7.1: LU Ident Errors', 'Test 70.7.1');
END $$;
INSERT INTO public.import_70_07_01_lu_idents_upload(tax_ident, stat_ident, name, valid_from, valid_to, sector_code, legal_form_code, primary_activity_category_code, birth_date, custom_est_ident) VALUES
(NULL,NULL,'LU NoIdents','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL), -- Error: missing_identifier_value
('LU7071_TAX','LU7072_STAT','LU Inconsistent','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL), -- Error: inconsistent_legal_unit
('EST7071_TAX',NULL,'LU CrossType EST','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL), -- Error: cross-type conflict (tax_ident used by EST1)
('LU7071_TAX','LU7071_STAT_CHANGED','LU Unstable Ident','2023-01-01','2023-12-31','2100','AS','01.110','2023-01-01',NULL) -- Error: unstable_identifier (attempts to change existing LU1.stat_ident)
;
-- The previous attempt to test an 'unknown_identifier_type' error by inserting into a
-- non-existent column in the _upload table was removed, as this causes a direct SQL error
-- rather than testing the import logic for unknown identifier type codes.
CALL worker.process_tasks(p_queue => 'import');
\echo "Data table for import_70_07_01_lu_idents (expect external_idents errors):"
"Data table for import_70_07_01_lu_idents (expect external_idents errors):"
SELECT row_id, name, state, action, operation, error, legal_unit_id FROM public.import_70_07_01_lu_idents_data ORDER BY row_id;
 row_id |       name        | state | action | operation |                                                                     error                                                                     | legal_unit_id 
--------+-------------------+-------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------+---------------
      1 | LU NoIdents       | error | skip   | insert    | {"tax_ident": "No identifier specified", "stat_ident": "No identifier specified", "custom_est_ident": "No identifier specified"}              |              
      2 | LU Inconsistent   | error | skip   | replace   | {"tax_ident": "Provided identifiers resolve to different Legal Units", "stat_ident": "Provided identifiers resolve to different Legal Units"} |              
      3 | LU CrossType EST  | error | skip   | replace   | {"tax_ident": "Identifier already used by a Establishment: {\"tax_ident\": \"EST7071_TAX\"}"}                                                 |              
      4 | LU Unstable Ident | error | skip   | replace   | {"stat_ident": "Identifier stat_ident value 'LU7071_STAT_CHANGED' from input attempts to change existing value 'LU7071_STAT'"}                |              
(4 rows)

-- Sub-Scenario 70.7.2: Mode 'establishment_formal' (using 'establishment_for_lu_explicit_dates')
\echo "Sub-Scenario 70.7.2: analyse_external_idents - Mode 'establishment_formal'"
"Sub-Scenario 70.7.2: analyse_external_idents - Mode 'establishment_formal'"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'establishment_for_lu_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_07_02_est_f_idents', 'Test 70.7.2: Formal EST Ident Errors', 'Test 70.7.2');
END $$;
INSERT INTO public.import_70_07_02_est_f_idents_upload(tax_ident, name, valid_from, valid_to, primary_activity_category_code, legal_unit_tax_ident) VALUES
('EST7071_TAX','ESTF Inconsistent','2023-01-01','2023-12-31','01.110','LU7071_TAX'), -- Error: inconsistent_establishment (EST1 vs EST2) - Note: custom_est_ident 'EST7072_CUSTOM' removed due to upload table structure
('LU7071_TAX','ESTF CrossType LU','2023-01-01','2023-12-31','01.110','LU7071_TAX'); -- Error: cross-type conflict (tax_ident used by LU1)
CALL worker.process_tasks(p_queue => 'import');
\echo "Data table for import_70_07_02_est_f_idents (expect external_idents errors):"
"Data table for import_70_07_02_est_f_idents (expect external_idents errors):"
SELECT row_id, name, state, action, operation, error, establishment_id FROM public.import_70_07_02_est_f_idents_data ORDER BY row_id;
 row_id |       name        | state | action | operation |                                                 error                                                  | establishment_id 
--------+-------------------+-------+--------+-----------+--------------------------------------------------------------------------------------------------------+------------------
      1 | ESTF Inconsistent | error | skip   | replace   | {"tax_ident": "Identifier already used by a Informal Establishment: {\"tax_ident\": \"EST7071_TAX\"}"} |                 
      2 | ESTF CrossType LU | error | skip   | replace   | {"tax_ident": "Identifier already used by a Legal Unit: {\"tax_ident\": \"LU7071_TAX\"}"}              |                 
(2 rows)

-- Sub-Scenario 70.7.3: Mode 'establishment_informal' (using 'establishment_without_lu_explicit_dates')
\echo "Sub-Scenario 70.7.3: analyse_external_idents - Mode 'establishment_informal'"
"Sub-Scenario 70.7.3: analyse_external_idents - Mode 'establishment_informal'"
DO $$
DECLARE v_definition_id INT; v_definition_slug TEXT := 'establishment_without_lu_explicit_dates';
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;
    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_07_03_est_inf_idents', 'Test 70.7.3: Informal EST Ident Errors', 'Test 70.7.3');
END $$;
INSERT INTO public.import_70_07_03_est_inf_idents_upload(tax_ident, name, valid_from, valid_to, primary_activity_category_code) VALUES
('LU7071_TAX','ESTINF CrossType LU','2023-01-01','2023-12-31','01.110'), -- Error: cross-type conflict (tax_ident used by LU1)
('EST707F_TAX','ESTINF CrossType FormalEST','2023-01-01','2023-12-31','01.110'); -- Error: cross-type conflict (tax_ident used by EST_FORMAL)
CALL worker.process_tasks(p_queue => 'import');
\echo "Data table for import_70_07_03_est_inf_idents (expect external_idents errors):"
"Data table for import_70_07_03_est_inf_idents (expect external_idents errors):"
SELECT row_id, name, state, action, operation, error, establishment_id FROM public.import_70_07_03_est_inf_idents_data ORDER BY row_id;
 row_id |            name            | state | action | operation |                                                error                                                 | establishment_id 
--------+----------------------------+-------+--------+-----------+------------------------------------------------------------------------------------------------------+------------------
      1 | ESTINF CrossType LU        | error | skip   | replace   | {"tax_ident": "Identifier already used by a Legal Unit: {\"tax_ident\": \"LU7071_TAX\"}"}            |                 
      2 | ESTINF CrossType FormalEST | error | skip   | replace   | {"tax_ident": "Identifier already used by a Formal Establishment: {\"tax_ident\": \"EST707F_TAX\"}"} |                 
(2 rows)

ROLLBACK TO scenario_70_7_external_idents_errors;
-- Scenario 70.8: analyse_link_establishment_to_legal_unit Errors
SAVEPOINT scenario_70_8_link_est_lu_errors;
\echo "Scenario 70.8: analyse_link_establishment_to_legal_unit Errors (Mode 'establishment_formal')"
"Scenario 70.8: analyse_link_establishment_to_legal_unit Errors (Mode 'establishment_formal')"
DO $$
DECLARE
    v_definition_id INT; v_definition_slug TEXT := 'establishment_for_lu_explicit_dates';
    rec RECORD;
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;

    RAISE NOTICE 'Diagnostic for Scenario 70.8: Expected source input columns for definition "%" (ID: %) like "legal_unit_%%":', v_definition_slug, v_definition_id;
    FOR rec IN
        SELECT dc.column_name, s.code AS step_code
        FROM public.import_data_column dc
        JOIN public.import_step s ON dc.step_id = s.id
        JOIN public.import_definition_step ds ON ds.step_id = s.id
        WHERE ds.definition_id = v_definition_id
          AND dc.purpose = 'source_input'
          AND dc.column_name ILIKE 'legal_unit_%'
        ORDER BY s.priority, dc.column_name
    LOOP
        RAISE NOTICE '  -> Found source input data column: % (for step: %)', rec.column_name, rec.step_code;
    END LOOP;
    IF NOT FOUND THEN
        RAISE NOTICE '  -> No source input data columns found matching "legal_unit_%%" for definition "%".', v_definition_slug;
    END IF;

    INSERT INTO public.import_job (definition_id, slug, description, edit_comment)
    VALUES (v_definition_id, 'import_70_08_link_est_lu', 'Test 70.8: Link EST to LU Errors', 'Test 70.8');
END $$;
NOTICE:  Diagnostic for Scenario 70.8: Expected source input columns for definition "establishment_for_lu_explicit_dates" (ID: 4) like "legal_unit_%":
NOTICE:    -> Found source input data column: legal_unit_stat_ident (for step: link_establishment_to_legal_unit)
NOTICE:    -> Found source input data column: legal_unit_tax_ident (for step: link_establishment_to_legal_unit)
-- Setup: LU1 (tax_ident='LU7071_TAX', stat_ident='LU7071_STAT'), LU2 (stat_ident='LU7072_STAT') from 70.7 setup are available.
-- The diagnostic RAISE NOTICE above should confirm that legal_unit_tax_ident and legal_unit_stat_ident are expected source columns.
INSERT INTO public.import_70_08_link_est_lu_upload(tax_ident, name, valid_from, valid_to, primary_activity_category_code, legal_unit_tax_ident, legal_unit_stat_ident) VALUES
('E7081', 'EST No LUIdent', '2023-01-01', '2023-12-31', '01.110', NULL, NULL), -- Error: missing_identifier
('E7082', 'EST LU NotFound', '2023-01-01', '2023-12-31', '01.110', 'LU_NONEXISTENT_TAX', NULL), -- Error: not_found
('E7083', 'EST LU Inconsistent', '2023-01-01', '2023-12-31', '01.110', 'LU7071_TAX', 'LU7072_STAT'); -- Error: inconsistent_legal_unit
CALL worker.process_tasks(p_queue => 'import');
\echo "Data table for import_70_08_link_est_lu (expect link_establishment_to_legal_unit errors):"
"Data table for import_70_08_link_est_lu (expect link_establishment_to_legal_unit errors):"
SELECT row_id, name, state, action, error, legal_unit_id FROM public.import_70_08_link_est_lu_data ORDER BY row_id;
 row_id |        name         | state | action |                                                                          error                                                                          | legal_unit_id 
--------+---------------------+-------+--------+---------------------------------------------------------------------------------------------------------------------------------------------------------+---------------
      1 | EST No LUIdent      | error | skip   | {"legal_unit_tax_ident": "Missing legal unit identifier.", "legal_unit_stat_ident": "Missing legal unit identifier."}                                   |              
      2 | EST LU NotFound     | error | skip   | {"legal_unit_tax_ident": "Legal unit not found with provided identifiers."}                                                                             |              
      3 | EST LU Inconsistent | error | skip   | {"legal_unit_tax_ident": "Legal unit not found with provided identifiers.", "legal_unit_stat_ident": "Legal unit not found with provided identifiers."} |              
(3 rows)

ROLLBACK TO scenario_70_8_link_est_lu_errors;
-- Scenario 70.9: analyse_valid_time_from_context Errors
SAVEPOINT scenario_70_9_valid_time_context_errors;
\echo "Scenario 70.9: analyse_valid_time_from_context Errors"
"Scenario 70.9: analyse_valid_time_from_context Errors"
DO $$
DECLARE
    v_definition_id INT; v_definition_slug TEXT := 'legal_unit_current_year'; -- Uses time_context_ident = 'r_year_curr'
BEGIN
    SELECT id INTO v_definition_id FROM public.import_definition WHERE slug = v_definition_slug;

    -- Test 1: Attempt to set default_valid_to when definition uses time_context_ident (should fail)
    BEGIN
        INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_to)
        VALUES (v_definition_id, 'import_70_09_01_ctx_err_dvf', 'Test 70.9.1: Job with default_valid_to + time_context', 'Test 70.9.1', '2023-12-31');
        RAISE EXCEPTION 'Test 70.9.1 FAILED: Expected INSERT to fail due to time_context conflict with default_valid_to.';
    EXCEPTION
        WHEN others THEN
            RAISE NOTICE 'Test 70.9.1 PASSED: Correctly failed to create job with default_valid_to and time_context. SQLERRM: %', SQLERRM;
            -- No upload table or data table will be created, so no further processing or checks for this job.
    END;

    -- Test 2: Attempt to set default_valid_from when definition uses time_context_ident (should fail)
    BEGIN
        INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_from)
        VALUES (v_definition_id, 'import_70_09_02_ctx_err_dvt', 'Test 70.9.2: Job with default_valid_from + time_context', 'Test 70.9.2', '2023-01-01');
        RAISE EXCEPTION 'Test 70.9.2 FAILED: Expected INSERT to fail due to time_context conflict with default_valid_from.';
    EXCEPTION
        WHEN others THEN
            RAISE NOTICE 'Test 70.9.2 PASSED: Correctly failed to create job with default_valid_from and time_context. SQLERRM: %', SQLERRM;
    END;

    -- Test 3: Attempt to set default_valid_from > default_valid_to when definition uses time_context_ident (should fail due to time_context conflict first)
    BEGIN
        INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_from, default_valid_to)
        VALUES (v_definition_id, 'import_70_09_03_ctx_err_inv_period', 'Test 70.9.3: Job with invalid default period + time_context', 'Test 70.9.3', '2023-12-31', '2023-01-01');
        RAISE EXCEPTION 'Test 70.9.3 FAILED: Expected INSERT to fail due to time_context conflict with default_valid_from/to.';
    EXCEPTION
        WHEN others THEN
            RAISE NOTICE 'Test 70.9.3 PASSED: Correctly failed to create job with default_valid_from/to and time_context. SQLERRM: %', SQLERRM;
    END;

    -- Test 4: Definition does NOT use time_context_ident, but job provides invalid default_valid_from > default_valid_to (should fail)
    -- For this, we need a definition without time_context_ident, e.g., 'legal_unit_explicit_dates'
    DECLARE
        v_def_explicit_id INT;
    BEGIN
        SELECT id INTO v_def_explicit_id FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
        IF v_def_explicit_id IS NULL THEN RAISE EXCEPTION 'Setup for Test 70.9.4 FAILED: Definition "legal_unit_explicit_dates" not found.'; END IF;

        BEGIN
            INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_from, default_valid_to)
            VALUES (v_def_explicit_id, 'import_70_09_04_job_inv_period', 'Test 70.9.4: Job with invalid default_valid_from > default_valid_to', 'Test 70.9.4', '2024-01-01', '2023-12-31');
            RAISE EXCEPTION 'Test 70.9.4 FAILED: Expected INSERT to fail due to DB check constraint for invalid default_valid_from > default_valid_to.';
        EXCEPTION
            WHEN check_violation THEN -- Specifically catch check_violation (SQLSTATE 23514)
                RAISE NOTICE 'Test 70.9.4 PASSED: Correctly failed to create job with invalid default_valid_from > default_valid_to due to DB check constraint. SQLERRM: %', SQLERRM;
            WHEN others THEN
                 RAISE NOTICE 'Test 70.9.4 FAILED: Expected check_violation but got different error. SQLERRM: %', SQLERRM;
                 RAISE; -- Re-raise other unexpected errors
        END;
    END;

    -- Test 5: Definition does NOT use time_context_ident, but job provides default_valid_from and NULL default_valid_to (should fail due to trigger)
    DECLARE
        v_def_explicit_id_5 INT;
    BEGIN
        SELECT id INTO v_def_explicit_id_5 FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
        IF v_def_explicit_id_5 IS NULL THEN RAISE EXCEPTION 'Setup for Test 70.9.5 FAILED: Definition "legal_unit_explicit_dates" not found.'; END IF;

        BEGIN
            INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_from, default_valid_to)
            VALUES (v_def_explicit_id_5, 'import_70_09_05_job_from_null_to', 'Test 70.9.5: Job with default_valid_from and NULL default_valid_to', 'Test 70.9.5', '2023-01-01', NULL);
            RAISE EXCEPTION 'Test 70.9.5 FAILED: Expected INSERT to fail due to default_valid_to being NULL when default_valid_from is provided.';
        EXCEPTION
            WHEN raise_exception THEN -- Catching the user-defined exception from the trigger
                RAISE NOTICE 'Test 70.9.5 PASSED: Correctly failed to create job with default_valid_from and NULL default_valid_to. SQLERRM: %', SQLERRM;
            WHEN others THEN
                RAISE NOTICE 'Test 70.9.5 FAILED: Expected raise_exception but got different error. SQLERRM: %', SQLERRM;
                RAISE;
        END;
    END;

    -- Test 6: Definition does NOT use time_context_ident, but job provides NULL default_valid_from and non-NULL default_valid_to (should fail due to trigger)
    DECLARE
        v_def_explicit_id_6 INT;
    BEGIN
        SELECT id INTO v_def_explicit_id_6 FROM public.import_definition WHERE slug = 'legal_unit_explicit_dates';
        IF v_def_explicit_id_6 IS NULL THEN RAISE EXCEPTION 'Setup for Test 70.9.6 FAILED: Definition "legal_unit_explicit_dates" not found.'; END IF;

        BEGIN
            INSERT INTO public.import_job (definition_id, slug, description, edit_comment, default_valid_from, default_valid_to)
            VALUES (v_def_explicit_id_6, 'import_70_09_06_job_null_from_to', 'Test 70.9.6: Job with NULL default_valid_from and non-NULL default_valid_to', 'Test 70.9.6', NULL, '2023-12-31');
            RAISE EXCEPTION 'Test 70.9.6 FAILED: Expected INSERT to fail due to default_valid_from being NULL when default_valid_to is provided.';
        EXCEPTION
            WHEN raise_exception THEN -- Catching the user-defined exception from the trigger
                RAISE NOTICE 'Test 70.9.6 PASSED: Correctly failed to create job with NULL default_valid_from and non-NULL default_valid_to. SQLERRM: %', SQLERRM;
            WHEN others THEN
                RAISE NOTICE 'Test 70.9.6 FAILED: Expected raise_exception but got different error. SQLERRM: %', SQLERRM;
                RAISE;
        END;
    END;

END $$;
NOTICE:  Test 70.9.1 PASSED: Correctly failed to create job with default_valid_to and time_context. SQLERRM: Cannot specify default_valid_from/to for import job when its definition (Legal Unit - Current Year) uses time_context_ident (r_year_curr); validity dates are derived from the time context.
NOTICE:  Test 70.9.2 PASSED: Correctly failed to create job with default_valid_from and time_context. SQLERRM: Cannot specify default_valid_from/to for import job when its definition (Legal Unit - Current Year) uses time_context_ident (r_year_curr); validity dates are derived from the time context.
NOTICE:  Test 70.9.3 PASSED: Correctly failed to create job with default_valid_from/to and time_context. SQLERRM: Cannot specify default_valid_from/to for import job when its definition (Legal Unit - Current Year) uses time_context_ident (r_year_curr); validity dates are derived from the time context.
NOTICE:  Test 70.9.4 PASSED: Correctly failed to create job with invalid default_valid_from > default_valid_to due to DB check constraint. SQLERRM: new row for relation "import_job" violates check constraint "import_job_default_valid_from_to_consistency_check"
NOTICE:  Test 70.9.5 PASSED: Correctly failed to create job with default_valid_from and NULL default_valid_to. SQLERRM: If providing default_valid_from for an import job (definition Legal Unit - Explicit Dates without time_context_ident), default_valid_to must also be provided.
NOTICE:  Test 70.9.6 PASSED: Correctly failed to create job with NULL default_valid_from and non-NULL default_valid_to. SQLERRM: If providing default_valid_to for an import job (definition Legal Unit - Explicit Dates without time_context_ident), default_valid_from must also be provided.
-- Since the jobs in 70.9 are expected to fail at creation, there will be no _data tables to query.
-- The RAISE NOTICE statements within the EXCEPTION blocks will serve as verification.
-- We can remove the SELECT statements that query non-existent _data tables.
\echo "Scenario 70.9: Verification is done via RAISE NOTICE in EXCEPTION blocks above."
"Scenario 70.9: Verification is done via RAISE NOTICE in EXCEPTION blocks above."
ROLLBACK TO scenario_70_9_valid_time_context_errors;
\echo "Final counts after all test blocks for Test 70 (should be same as initial due to rollbacks)"
"Final counts after all test blocks for Test 70 (should be same as initial due to rollbacks)"
SELECT
    (SELECT COUNT(*) FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(*) FROM public.establishment) AS establishment_count,
    (SELECT COUNT(*) FROM public.enterprise) AS enterprise_count;
 legal_unit_count | establishment_count | enterprise_count 
------------------+---------------------+------------------
                0 |                   0 |                0
(1 row)

ROLLBACK TO main_test_70_start;
\echo "Test 70 completed and rolled back to main start."
"Test 70 completed and rolled back to main start."
ROLLBACK; -- Final rollback for the entire transaction
