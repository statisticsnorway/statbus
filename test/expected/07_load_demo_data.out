\echo Run worker processing to run import jobs and generate computed data
Run worker processing to run import jobs and generate computed data
CALL worker.process_tasks();
SELECT queue, state, count(*) FROM worker.tasks AS t JOIN worker.command_registry AS c ON t.command = c.command GROUP BY queue,state ORDER BY queue,state;
    queue    |   state   | count 
-------------+-----------+-------
 analytics   | completed |    12
 maintenance | pending   |     1
(2 rows)

\echo "Checking statistics"
"Checking statistics"
\x
SELECT unit_type
     , COUNT(DISTINCT unit_id)
     , jsonb_agg(DISTINCT invalid_codes) FILTER (WHERE invalid_codes IS NOT NULL) AS invalid_codes
     , jsonb_pretty(jsonb_stats_summary_merge_agg(stats_summary)) AS stats_summary
 FROM statistical_unit
 WHERE valid_after < CURRENT_DATE AND CURRENT_DATE <= valid_to
 GROUP BY unit_type;
-[ RECORD 1 ]-+-----------------------------------------------
unit_type     | establishment
count         | 25
invalid_codes | 
stats_summary | {                                             +
              |     "turnover": {                             +
              |         "max": 0,                             +
              |         "min": 0,                             +
              |         "sum": 0,                             +
              |         "mean": 0.00,                         +
              |         "type": "number",                     +
              |         "count": 25,                          +
              |         "stddev": 0.00,                       +
              |         "variance": 0.00,                     +
              |         "sum_sq_diff": 0.00,                  +
              |         "coefficient_of_variation_pct": null  +
              |     },                                        +
              |     "employees": {                            +
              |         "max": 0,                             +
              |         "min": 0,                             +
              |         "sum": 0,                             +
              |         "mean": 0.00,                         +
              |         "type": "number",                     +
              |         "count": 25,                          +
              |         "stddev": 0.00,                       +
              |         "variance": 0.00,                     +
              |         "sum_sq_diff": 0.00,                  +
              |         "coefficient_of_variation_pct": null  +
              |     }                                         +
              | }
-[ RECORD 2 ]-+-----------------------------------------------
unit_type     | legal_unit
count         | 23
invalid_codes | 
stats_summary | {                                             +
              |     "turnover": {                             +
              |         "max": 90000000,                      +
              |         "min": 0,                             +
              |         "sum": 262610000,                     +
              |         "mean": 5471041.67,                   +
              |         "type": "number",                     +
              |         "count": 48,                          +
              |         "stddev": 15741429.18,                +
              |         "variance": 247792592508865.25,       +
              |         "sum_sq_diff": 11646251847916666.67,  +
              |         "coefficient_of_variation_pct": 287.72+
              |     },                                        +
              |     "employees": {                            +
              |         "max": 65,                            +
              |         "min": 0,                             +
              |         "sum": 172,                           +
              |         "mean": 3.58,                         +
              |         "type": "number",                     +
              |         "count": 48,                          +
              |         "stddev": 10.55,                      +
              |         "variance": 111.31,                   +
              |         "sum_sq_diff": 5231.67,               +
              |         "coefficient_of_variation_pct": 294.43+
              |     }                                         +
              | }
-[ RECORD 3 ]-+-----------------------------------------------
unit_type     | enterprise
count         | 23
invalid_codes | 
stats_summary | {                                             +
              |     "turnover": {                             +
              |         "max": 90000000,                      +
              |         "min": 0,                             +
              |         "sum": 262610000,                     +
              |         "mean": 5471041.67,                   +
              |         "type": "number",                     +
              |         "count": 48,                          +
              |         "stddev": 15741429.18,                +
              |         "variance": 247792592508865.25,       +
              |         "sum_sq_diff": 11646251847916666.67,  +
              |         "coefficient_of_variation_pct": 287.72+
              |     },                                        +
              |     "employees": {                            +
              |         "max": 65,                            +
              |         "min": 0,                             +
              |         "sum": 172,                           +
              |         "mean": 3.58,                         +
              |         "type": "number",                     +
              |         "count": 48,                          +
              |         "stddev": 10.55,                      +
              |         "variance": 111.31,                   +
              |         "sum_sq_diff": 5231.67,               +
              |         "coefficient_of_variation_pct": 294.43+
              |     }                                         +
              | }

\x
ROLLBACK TO before_loading_units;
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |                0 |                0
(1 row)

\echo "User uploads the sample legal units"
"User uploads the sample legal units"
\copy public.import_legal_unit_current(tax_ident,stat_ident,name,birth_date,physical_region_code,physical_country_iso_2,primary_activity_category_code,legal_form_code,sector_code,employees,turnover,data_source_code) FROM 'app/public/demo/legal_units_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |               23 |               23
(1 row)

\echo Run worker processing to run import jobs and generate computed data
Run worker processing to run import jobs and generate computed data
CALL worker.process_tasks();
SELECT queue, state, count(*) FROM worker.tasks AS t JOIN worker.command_registry AS c ON t.command = c.command GROUP BY queue,state ORDER BY queue,state;
    queue    |   state   | count 
-------------+-----------+-------
 analytics   | completed |    11
 maintenance | pending   |     1
(2 rows)

\echo "Checking statistics"
"Checking statistics"
\x
SELECT unit_type
     , COUNT(DISTINCT unit_id)
     , jsonb_agg(DISTINCT invalid_codes) FILTER (WHERE invalid_codes IS NOT NULL) AS invalid_codes
     , jsonb_pretty(jsonb_stats_summary_merge_agg(stats_summary)) AS stats_summary
 FROM statistical_unit
 WHERE valid_after < CURRENT_DATE AND CURRENT_DATE <= valid_to
 GROUP BY unit_type;
-[ RECORD 1 ]-+-----------------------------------------------
unit_type     | legal_unit
count         | 23
invalid_codes | 
stats_summary | {                                             +
              |     "turnover": {                             +
              |         "max": 90000000,                      +
              |         "min": 300000,                        +
              |         "sum": 262610000,                     +
              |         "mean": 11417826.09,                  +
              |         "type": "number",                     +
              |         "count": 23,                          +
              |         "stddev": 21410030.35,                +
              |         "variance": 458389399604743.08,       +
              |         "sum_sq_diff": 10084566791304347.83,  +
              |         "coefficient_of_variation_pct": 187.51+
              |     },                                        +
              |     "employees": {                            +
              |         "max": 65,                            +
              |         "min": 0,                             +
              |         "sum": 172,                           +
              |         "mean": 7.48,                         +
              |         "type": "number",                     +
              |         "count": 23,                          +
              |         "stddev": 14.40,                      +
              |         "variance": 207.35,                   +
              |         "sum_sq_diff": 4561.74,               +
              |         "coefficient_of_variation_pct": 192.55+
              |     }                                         +
              | }
-[ RECORD 2 ]-+-----------------------------------------------
unit_type     | enterprise
count         | 23
invalid_codes | 
stats_summary | {                                             +
              |     "turnover": {                             +
              |         "max": 90000000,                      +
              |         "min": 300000,                        +
              |         "sum": 262610000,                     +
              |         "mean": 11417826.09,                  +
              |         "type": "number",                     +
              |         "count": 23,                          +
              |         "stddev": 21410030.35,                +
              |         "variance": 458389399604743.08,       +
              |         "sum_sq_diff": 10084566791304347.83,  +
              |         "coefficient_of_variation_pct": 187.51+
              |     },                                        +
              |     "employees": {                            +
              |         "max": 65,                            +
              |         "min": 0,                             +
              |         "sum": 172,                           +
              |         "mean": 7.48,                         +
              |         "type": "number",                     +
              |         "count": 23,                          +
              |         "stddev": 14.40,                      +
              |         "variance": 207.35,                   +
              |         "sum_sq_diff": 4561.74,               +
              |         "coefficient_of_variation_pct": 192.55+
              |     }                                         +
              | }

\x
ROLLBACK TO before_loading_units;
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |                0 |                0
(1 row)

\echo "User uploads the sample informal establishments"
"User uploads the sample informal establishments"
\copy public.import_establishment_current_without_legal_unit(tax_ident,stat_ident,name,physical_region_code,physical_country_iso_2,primary_activity_category_code,employees,turnover,data_source_code) FROM 'app/public/demo/informal_establishments_units_demo.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                  25 |                0 |               25
(1 row)

\echo Run worker processing to run import jobs and generate computed data
Run worker processing to run import jobs and generate computed data
CALL worker.process_tasks();
SELECT queue, state, count(*) FROM worker.tasks AS t JOIN worker.command_registry AS c ON t.command = c.command GROUP BY queue,state ORDER BY queue,state;
    queue    |   state   | count 
-------------+-----------+-------
 analytics   | completed |    11
 maintenance | pending   |     1
(2 rows)

\echo "Checking statistics"
"Checking statistics"
\x
SELECT unit_type
     , COUNT(DISTINCT unit_id)
     , jsonb_agg(DISTINCT invalid_codes) FILTER (WHERE invalid_codes IS NOT NULL) AS invalid_codes
     , jsonb_pretty(jsonb_stats_summary_merge_agg(stats_summary)) AS stats_summary
 FROM statistical_unit
 WHERE valid_after < CURRENT_DATE AND CURRENT_DATE <= valid_to
 GROUP BY unit_type;
-[ RECORD 1 ]-+----------------------------------------------
unit_type     | establishment
count         | 25
invalid_codes | 
stats_summary | {                                            +
              |     "turnover": {                            +
              |         "max": 4400,                         +
              |         "min": 100,                          +
              |         "sum": 51036,                        +
              |         "mean": 2041.44,                     +
              |         "type": "number",                    +
              |         "count": 25,                         +
              |         "stddev": 1591.83,                   +
              |         "variance": 2533920.51,              +
              |         "sum_sq_diff": 60814092.16,          +
              |         "coefficient_of_variation_pct": 77.98+
              |     },                                       +
              |     "employees": {                           +
              |         "max": 5,                            +
              |         "min": 1,                            +
              |         "sum": 75,                           +
              |         "mean": 3.00,                        +
              |         "type": "number",                    +
              |         "count": 25,                         +
              |         "stddev": 1.44,                      +
              |         "variance": 2.08,                    +
              |         "sum_sq_diff": 50.00,                +
              |         "coefficient_of_variation_pct": 48.11+
              |     }                                        +
              | }
-[ RECORD 2 ]-+----------------------------------------------
unit_type     | enterprise
count         | 25
invalid_codes | 
stats_summary | {                                            +
              |     "turnover": {                            +
              |         "max": 4400,                         +
              |         "min": 100,                          +
              |         "sum": 51036,                        +
              |         "mean": 2041.44,                     +
              |         "type": "number",                    +
              |         "count": 25,                         +
              |         "stddev": 1591.83,                   +
              |         "variance": 2533920.51,              +
              |         "sum_sq_diff": 60814092.16,          +
              |         "coefficient_of_variation_pct": 77.98+
              |     },                                       +
              |     "employees": {                           +
              |         "max": 5,                            +
              |         "min": 1,                            +
              |         "sum": 75,                           +
              |         "mean": 3.00,                        +
              |         "type": "number",                    +
              |         "count": 25,                         +
              |         "stddev": 1.44,                      +
              |         "variance": 2.08,                    +
              |         "sum_sq_diff": 50.00,                +
              |         "coefficient_of_variation_pct": 48.11+
              |     }                                        +
              | }

\x
ROLLBACK;
