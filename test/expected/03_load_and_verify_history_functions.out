SET datestyle TO 'ISO, DMY';
BEGIN;
\echo "Setting up Statbus to load establishments without legal units"
"Setting up Statbus to load establishments without legal units"
\echo "User selected the Activity Category Standard"
"User selected the Activity Category Standard"
INSERT INTO settings(activity_category_standard_id,only_one_setting)
SELECT id, true FROM activity_category_standard WHERE code = 'nace_v2.1'
ON CONFLICT (only_one_setting)
DO UPDATE SET
   activity_category_standard_id =(SELECT id FROM activity_category_standard WHERE code = 'nace_v2.1')
   WHERE settings.id = EXCLUDED.id;
;
SELECT activity_category_standard_id FROM public.settings;
 activity_category_standard_id 
-------------------------------
                             2
(1 row)

\echo "User uploads the sample activity categories"
"User uploads the sample activity categories"
\copy public.activity_category_available_custom(path,name,description) FROM 'app/public/activity_category_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.activity_category_available;
 count 
-------
  2215
(1 row)

\echo "User uploads the sample regions"
"User uploads the sample regions"
\copy public.region_upload(path, name) FROM 'app/public/norway-regions-2024.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.region;
 count 
-------
   417
(1 row)

\echo "User uploads the sample legal forms"
"User uploads the sample legal forms"
\copy public.legal_form_custom_only(code,name) FROM 'app/public/legal_form_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.legal_form_available;
 count 
-------
    46
(1 row)

\echo "User uploads the sample sectors"
"User uploads the sample sectors"
\copy public.sector_custom_only(path,name,description) FROM 'app/public/sector_norway.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT count(*) FROM public.sector_available;
 count 
-------
    33
(1 row)

SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   0 |                0 |                0
(1 row)

\echo "User uploads the legal units over time"
"User uploads the legal units over time"
\copy public.import_legal_unit_era(valid_from,valid_to,tax_ident,name,birth_date,death_date,physical_address_part1,physical_postal_code,physical_postal_place,physical_region_code,physical_country_iso_2,postal_address_part1,postal_postal_code,postal_postal_place,postal_region_code,postal_country_iso_2,primary_activity_category_code,secondary_activity_category_code,sector_code,legal_form_code) FROM 'test/data/03_norwegian-legal-units-over-time.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
\echo "User uploads the establishments over time"
"User uploads the establishments over time"
\copy public.import_establishment_era_for_legal_unit(valid_from, valid_to, tax_ident,legal_unit_tax_ident,name,birth_date,death_date,physical_address_part1,physical_postal_code,physical_postal_place,physical_region_code,physical_country_iso_2,postal_address_part1,postal_postal_code,postal_postal_place,postal_region_code,postal_country_iso_2,primary_activity_category_code,secondary_activity_category_code,employees,turnover) FROM 'test/data/03_norwegian-establishments-over-time.csv' WITH (FORMAT csv, DELIMITER ',', QUOTE '"', HEADER true);
SELECT
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.establishment) AS establishment_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.legal_unit) AS legal_unit_count,
    (SELECT COUNT(DISTINCT id) AS distinct_unit_count FROM public.enterprise) AS enterprise_count;
 establishment_count | legal_unit_count | enterprise_count 
---------------------+------------------+------------------
                   1 |                2 |                2
(1 row)

\echo "Refreshing materialized views"
"Refreshing materialized views"
-- Exclude the refresh_time_ms as it will vary.
SELECT view_name FROM statistical_unit_refresh_now();
         view_name         
---------------------------
 statistical_unit
 activity_category_used
 region_used
 sector_used
 legal_form_used
 country_used
 statistical_unit_facet
 statistical_history
 statistical_history_facet
(9 rows)

\echo "Checking timepoints."
"Checking timepoints."
SELECT tp.unit_type
     , public.get_external_idents(tp.unit_type, tp.unit_id)->>'tax_ident' AS tax_ident
     , tp.timepoint
FROM public.timepoints AS tp
ORDER BY unit_type;
   unit_type   | tax_ident | timepoint  
---------------+-----------+------------
 establishment | 895406732 | 2009-12-31
 establishment | 895406732 | 2012-12-31
 establishment | 895406732 | 2015-12-31
 establishment | 895406732 | 2018-12-31
 establishment | 895406732 | 2019-02-28
 establishment | 895406732 | 2019-04-30
 establishment | 895406732 | 2019-06-30
 establishment | 895406732 | 2019-08-31
 establishment | 895406732 | 2019-10-31
 establishment | 895406732 | 2019-12-31
 establishment | 895406732 | infinity
 legal_unit    | 823573673 | 2009-12-31
 legal_unit    | 823573673 | 2012-12-31
 legal_unit    | 921835809 | 2012-12-31
 legal_unit    | 921835809 | 2015-12-31
 legal_unit    | 921835809 | 2018-12-31
 legal_unit    | 921835809 | 2019-02-28
 legal_unit    | 921835809 | 2019-04-30
 legal_unit    | 921835809 | 2019-06-30
 legal_unit    | 921835809 | 2019-08-31
 legal_unit    | 921835809 | 2019-10-31
 legal_unit    | 921835809 | 2019-12-31
 legal_unit    | 921835809 | infinity
 enterprise    |           | 2009-12-31
 enterprise    |           | 2012-12-31
 enterprise    |           | 2012-12-31
 enterprise    |           | 2015-12-31
 enterprise    |           | 2018-12-31
 enterprise    |           | 2019-02-28
 enterprise    |           | 2019-04-30
 enterprise    |           | 2019-06-30
 enterprise    |           | 2019-08-31
 enterprise    |           | 2019-10-31
 enterprise    |           | 2019-12-31
 enterprise    |           | infinity
(35 rows)

\echo "Checking timesegments"
"Checking timesegments"
SELECT ts.unit_type
     , public.get_external_idents(ts.unit_type, ts.unit_id)->>'tax_ident' AS tax_ident
     , ts.valid_after
     , ts.valid_to
FROM public.timesegments AS ts
ORDER BY unit_type;
   unit_type   | tax_ident | valid_after |  valid_to  
---------------+-----------+-------------+------------
 establishment | 895406732 | 2009-12-31  | 2012-12-31
 establishment | 895406732 | 2012-12-31  | 2015-12-31
 establishment | 895406732 | 2015-12-31  | 2018-12-31
 establishment | 895406732 | 2018-12-31  | 2019-02-28
 establishment | 895406732 | 2019-02-28  | 2019-04-30
 establishment | 895406732 | 2019-04-30  | 2019-06-30
 establishment | 895406732 | 2019-06-30  | 2019-08-31
 establishment | 895406732 | 2019-08-31  | 2019-10-31
 establishment | 895406732 | 2019-10-31  | 2019-12-31
 establishment | 895406732 | 2019-12-31  | infinity
 legal_unit    | 823573673 | 2009-12-31  | 2012-12-31
 legal_unit    | 921835809 | 2012-12-31  | 2015-12-31
 legal_unit    | 921835809 | 2015-12-31  | 2018-12-31
 legal_unit    | 921835809 | 2018-12-31  | 2019-02-28
 legal_unit    | 921835809 | 2019-02-28  | 2019-04-30
 legal_unit    | 921835809 | 2019-04-30  | 2019-06-30
 legal_unit    | 921835809 | 2019-06-30  | 2019-08-31
 legal_unit    | 921835809 | 2019-08-31  | 2019-10-31
 legal_unit    | 921835809 | 2019-10-31  | 2019-12-31
 legal_unit    | 921835809 | 2019-12-31  | infinity
 enterprise    |           | 2009-12-31  | 2012-12-31
 enterprise    |           | 2012-12-31  | 2015-12-31
 enterprise    |           | 2015-12-31  | 2018-12-31
 enterprise    |           | 2018-12-31  | 2019-02-28
 enterprise    |           | 2019-02-28  | 2019-04-30
 enterprise    |           | 2019-04-30  | 2019-06-30
 enterprise    |           | 2019-06-30  | 2019-08-31
 enterprise    |           | 2019-08-31  | 2019-10-31
 enterprise    |           | 2019-10-31  | 2019-12-31
 enterprise    |           | 2019-12-31  | infinity
(30 rows)

\echo "Checking timeline_establishment data"
"Checking timeline_establishment data"
SELECT unit_type
     , public.get_external_idents(unit_type, unit_id)->>'tax_ident' AS tax_ident
     , valid_after
     , valid_from
     , valid_to
     , name
     , birth_date
     , death_date
     , search
     , primary_activity_category_path
     , secondary_activity_category_path
     , activity_category_paths
     , sector_path
     , sector_code
     , sector_name
     , legal_form_code
     , legal_form_name
     , physical_address_part1
     , physical_address_part2
     , physical_address_part3
     , physical_postal_code
     , physical_postal_place
     , physical_region_path
     , physical_country_iso_2
     , postal_address_part1
     , postal_address_part2
     , postal_address_part3
     , postal_postal_code
     , postal_postal_place
     , postal_region_path
     , postal_country_iso_2
     , invalid_codes
FROM public.timeline_establishment
ORDER BY unit_type, unit_id, valid_after, valid_to;
   unit_type   | tax_ident | valid_after | valid_from |  valid_to  |         name          | birth_date | death_date |             search              | primary_activity_category_path | secondary_activity_category_path | activity_category_paths | sector_path | sector_code | sector_name | legal_form_code | legal_form_name | physical_address_part1 | physical_address_part2 | physical_address_part3 | physical_postal_code | physical_postal_place | physical_region_path | physical_country_iso_2 | postal_address_part1 | postal_address_part2 | postal_address_part3 | postal_postal_code | postal_postal_place | postal_region_path | postal_country_iso_2 | invalid_codes 
---------------+-----------+-------------+------------+------------+-----------------------+------------+------------+---------------------------------+--------------------------------+----------------------------------+-------------------------+-------------+-------------+-------------+-----------------+-----------------+------------------------+------------------------+------------------------+----------------------+-----------------------+----------------------+------------------------+----------------------+----------------------+----------------------+--------------------+---------------------+--------------------+----------------------+---------------
 establishment | 895406732 | 2009-12-31  | 2010-01-01 | 2012-12-31 | KRANLØFT ENK          | 2010-01-01 |            | 'enk':2 'kranløft':1            | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2012-12-31  | 2013-01-01 | 2015-12-31 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2015-12-31  | 2016-01-01 | 2018-12-31 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2018-12-31  | 2019-01-01 | 2019-02-28 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-02-28  | 2019-03-01 | 2019-04-30 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-04-30  | 2019-05-01 | 2019-06-30 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-06-30  | 2019-07-01 | 2019-08-31 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-08-31  | 2019-09-01 | 2019-10-31 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-10-31  | 2019-11-01 | 2019-12-31 | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 establishment | 895406732 | 2019-12-31  | 2020-01-01 | infinity   | KRAN & SPESIALLØFT AS | 2010-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            |             |             |             |                 |                 | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
(10 rows)

\echo "Checking timeline_establishment stats"
"Checking timeline_establishment stats"
SELECT unit_type
     , public.get_external_idents(unit_type, unit_id)->>'tax_ident' AS tax_ident
     , valid_after
     , valid_from
     , valid_to
     , stats
FROM public.timeline_establishment
ORDER BY unit_type, unit_id, valid_after, valid_to;
   unit_type   | tax_ident | valid_after | valid_from |  valid_to  |                  stats                  
---------------+-----------+-------------+------------+------------+-----------------------------------------
 establishment | 895406732 | 2009-12-31  | 2010-01-01 | 2012-12-31 | {"turnover": 1500000, "employees": 1}
 establishment | 895406732 | 2012-12-31  | 2013-01-01 | 2015-12-31 | {"turnover": 3000000, "employees": 3}
 establishment | 895406732 | 2015-12-31  | 2016-01-01 | 2018-12-31 | {"turnover": 12000000, "employees": 9}
 establishment | 895406732 | 2018-12-31  | 2019-01-01 | 2019-02-28 | {"turnover": 60000000, "employees": 25}
 establishment | 895406732 | 2019-02-28  | 2019-03-01 | 2019-04-30 | {"turnover": 60000000, "employees": 30}
 establishment | 895406732 | 2019-04-30  | 2019-05-01 | 2019-06-30 | {"turnover": 60000000, "employees": 35}
 establishment | 895406732 | 2019-06-30  | 2019-07-01 | 2019-08-31 | {"turnover": 60000000, "employees": 40}
 establishment | 895406732 | 2019-08-31  | 2019-09-01 | 2019-10-31 | {"turnover": 60000000, "employees": 50}
 establishment | 895406732 | 2019-10-31  | 2019-11-01 | 2019-12-31 | {"turnover": 60000000, "employees": 40}
 establishment | 895406732 | 2019-12-31  | 2020-01-01 | infinity   | {"turnover": 70000000, "employees": 45}
(10 rows)

\echo "Checking timeline_legal_unit data"
"Checking timeline_legal_unit data"
SELECT unit_type
     , public.get_external_idents(unit_type, unit_id)->>'tax_ident' AS tax_ident
     , valid_after
     , valid_from
     , valid_to
     , name
     , birth_date
     , death_date
     , search
     , primary_activity_category_path
     , secondary_activity_category_path
     , activity_category_paths
     , sector_path
     , sector_code
     , sector_name
     , legal_form_code
     , legal_form_name
     , physical_address_part1
     , physical_address_part2
     , physical_address_part3
     , physical_postal_code
     , physical_postal_place
     , physical_region_path
     , physical_country_iso_2
     , postal_address_part1
     , postal_address_part2
     , postal_address_part3
     , postal_postal_code
     , postal_postal_place
     , postal_region_path
     , postal_country_iso_2
     , invalid_codes
FROM public.timeline_legal_unit
ORDER BY unit_type, unit_id, valid_after, valid_to;
 unit_type  | tax_ident | valid_after | valid_from |  valid_to  |         name          | birth_date | death_date |             search              | primary_activity_category_path | secondary_activity_category_path | activity_category_paths |     sector_path      | sector_code |        sector_name         | legal_form_code |   legal_form_name   | physical_address_part1 | physical_address_part2 | physical_address_part3 | physical_postal_code | physical_postal_place | physical_region_path | physical_country_iso_2 | postal_address_part1 | postal_address_part2 | postal_address_part3 | postal_postal_code | postal_postal_place | postal_region_path | postal_country_iso_2 | invalid_codes 
------------+-----------+-------------+------------+------------+-----------------------+------------+------------+---------------------------------+--------------------------------+----------------------------------+-------------------------+----------------------+-------------+----------------------------+-----------------+---------------------+------------------------+------------------------+------------------------+----------------------+-----------------------+----------------------+------------------------+----------------------+----------------------+----------------------+--------------------+---------------------+--------------------+----------------------+---------------
 legal_unit | 823573673 | 2009-12-31  | 2010-01-01 | 2012-12-31 | KRANLØFT ENK          | 2010-01-01 | 2012-12-31 | 'enk':2 'kranløft':1            | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | ENK             | Enkeltpersonforetak | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2012-12-31  | 2013-01-01 | 2015-12-31 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2015-12-31  | 2016-01-01 | 2018-12-31 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2018-12-31  | 2019-01-01 | 2019-02-28 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-02-28  | 2019-03-01 | 2019-04-30 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-04-30  | 2019-05-01 | 2019-06-30 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-06-30  | 2019-07-01 | 2019-08-31 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-08-31  | 2019-09-01 | 2019-10-31 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-10-31  | 2019-11-01 | 2019-12-31 | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
 legal_unit | 921835809 | 2019-12-31  | 2020-01-01 | infinity   | KRAN & SPESIALLØFT AS | 2013-01-01 |            | 'as':3 'kran':1 'spesialløft':2 | H.49.4.1.0                     |                                  | {H.49.4.1.0}            | innl.a_ikke_fin.2100 | 2100        | Private aksjeselskaper mv. | AS              | Aksjeselskap        | Vestlyvegen 219        |                        |                        | 4347                 | LYE                   | 11.21                | NO                     |                      |                      |                      |                    |                     |                    |                      | 
(10 rows)

\x
\echo "Checking timeline_legal_unit stats"
"Checking timeline_legal_unit stats"
SELECT unit_type
     , public.get_external_idents(unit_type, unit_id)->>'tax_ident' AS tax_ident
     , valid_after
     , valid_from
     , valid_to
     , name
     , stats
     , jsonb_pretty(stats_summary) AS stats_summary
FROM public.timeline_legal_unit
ORDER BY unit_type, unit_id, valid_after, valid_to;
-[ RECORD 1 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 823573673
valid_after   | 2009-12-31
valid_from    | 2010-01-01
valid_to      | 2012-12-31
name          | KRANLØFT ENK
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 1500000,     +
              |         "min": 1500000,     +
              |         "sum": 1500000,     +
              |         "mean": 1500000.00, +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 1,           +
              |         "min": 1,           +
              |         "sum": 1,           +
              |         "mean": 1.00,       +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 2 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2012-12-31
valid_from    | 2013-01-01
valid_to      | 2015-12-31
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 3000000,     +
              |         "min": 3000000,     +
              |         "sum": 3000000,     +
              |         "mean": 3000000.00, +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 3,           +
              |         "min": 3,           +
              |         "sum": 3,           +
              |         "mean": 3.00,       +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 3 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2015-12-31
valid_from    | 2016-01-01
valid_to      | 2018-12-31
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 12000000,    +
              |         "min": 12000000,    +
              |         "sum": 12000000,    +
              |         "mean": 12000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 9,           +
              |         "min": 9,           +
              |         "sum": 9,           +
              |         "mean": 9.00,       +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 4 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2018-12-31
valid_from    | 2019-01-01
valid_to      | 2019-02-28
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 25,          +
              |         "min": 25,          +
              |         "sum": 25,          +
              |         "mean": 25.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 5 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-02-28
valid_from    | 2019-03-01
valid_to      | 2019-04-30
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 30,          +
              |         "min": 30,          +
              |         "sum": 30,          +
              |         "mean": 30.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 6 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-04-30
valid_from    | 2019-05-01
valid_to      | 2019-06-30
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 35,          +
              |         "min": 35,          +
              |         "sum": 35,          +
              |         "mean": 35.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 7 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-06-30
valid_from    | 2019-07-01
valid_to      | 2019-08-31
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 40,          +
              |         "min": 40,          +
              |         "sum": 40,          +
              |         "mean": 40.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 8 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-08-31
valid_from    | 2019-09-01
valid_to      | 2019-10-31
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 50,          +
              |         "min": 50,          +
              |         "sum": 50,          +
              |         "mean": 50.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 9 ]-+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-10-31
valid_from    | 2019-11-01
valid_to      | 2019-12-31
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 60000000,    +
              |         "min": 60000000,    +
              |         "sum": 60000000,    +
              |         "mean": 60000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 40,          +
              |         "min": 40,          +
              |         "sum": 40,          +
              |         "mean": 40.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }
-[ RECORD 10 ]+-----------------------------
unit_type     | legal_unit
tax_ident     | 921835809
valid_after   | 2019-12-31
valid_from    | 2020-01-01
valid_to      | infinity
name          | KRAN & SPESIALLØFT AS
stats         | {}
stats_summary | {                           +
              |     "turnover": {           +
              |         "max": 70000000,    +
              |         "min": 70000000,    +
              |         "sum": 70000000,    +
              |         "mean": 70000000.00,+
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     },                      +
              |     "employees": {          +
              |         "max": 45,          +
              |         "min": 45,          +
              |         "sum": 45,          +
              |         "mean": 45.00,      +
              |         "type": "number",   +
              |         "count": 1,         +
              |         "stddev": 0.00,     +
              |         "variance": 0.00,   +
              |         "sum_sq_diff": 0.00 +
              |     }                       +
              | }

\x
\x
\echo "Checking statistical_unit"
"Checking statistical_unit"
SELECT unit_type
     , external_idents
     , invalid_codes
     , jsonb_pretty(stats) AS stats
     , jsonb_pretty(stats_summary) AS stats_summary
 FROM statistical_unit
 WHERE valid_after < '2020-12-31'::DATE AND '2020-12-31'::DATE <= valid_to
 ORDER BY unit_type;
-[ RECORD 1 ]---+-----------------------------
unit_type       | establishment
external_idents | {"tax_ident": "895406732"}
invalid_codes   | 
stats           | {                           +
                |     "turnover": 70000000,   +
                |     "employees": 45         +
                | }
stats_summary   | {                           +
                | }
-[ RECORD 2 ]---+-----------------------------
unit_type       | legal_unit
external_idents | {"tax_ident": "921835809"}
invalid_codes   | 
stats           | {                           +
                | }
stats_summary   | {                           +
                |     "turnover": {           +
                |         "max": 70000000,    +
                |         "min": 70000000,    +
                |         "sum": 70000000,    +
                |         "mean": 70000000.00,+
                |         "type": "number",   +
                |         "count": 1,         +
                |         "stddev": 0.00,     +
                |         "variance": 0.00,   +
                |         "sum_sq_diff": 0.00 +
                |     },                      +
                |     "employees": {          +
                |         "max": 45,          +
                |         "min": 45,          +
                |         "sum": 45,          +
                |         "mean": 45.00,      +
                |         "type": "number",   +
                |         "count": 1,         +
                |         "stddev": 0.00,     +
                |         "variance": 0.00,   +
                |         "sum_sq_diff": 0.00 +
                |     }                       +
                | }
-[ RECORD 3 ]---+-----------------------------
unit_type       | enterprise
external_idents | {}
invalid_codes   | 
stats           | 
stats_summary   | {                           +
                | }

-- TODO: Fix enterprise.stats_summary
\echo "Checking statistical_unit totals"
"Checking statistical_unit totals"
SELECT unit_type
     , COUNT(DISTINCT unit_id) AS distinct_unit_count
     , jsonb_agg(DISTINCT invalid_codes) FILTER (WHERE invalid_codes IS NOT NULL) AS invalid_codes
     , jsonb_pretty(jsonb_stats_summary_merge_agg(stats_summary)) AS stats_summary
 FROM statistical_unit
 WHERE valid_after < '2020-12-31'::DATE AND '2020-12-31'::DATE <= valid_to
 GROUP BY unit_type;
-[ RECORD 1 ]-------+-----------------------------
unit_type           | establishment
distinct_unit_count | 1
invalid_codes       | 
stats_summary       | {                           +
                    | }
-[ RECORD 2 ]-------+-----------------------------
unit_type           | legal_unit
distinct_unit_count | 1
invalid_codes       | 
stats_summary       | {                           +
                    |     "turnover": {           +
                    |         "max": 70000000,    +
                    |         "min": 70000000,    +
                    |         "sum": 70000000,    +
                    |         "mean": 70000000.00,+
                    |         "type": "number",   +
                    |         "count": 1,         +
                    |         "stddev": 0.00,     +
                    |         "variance": 0.00,   +
                    |         "sum_sq_diff": 0.00 +
                    |     },                      +
                    |     "employees": {          +
                    |         "max": 45,          +
                    |         "min": 45,          +
                    |         "sum": 45,          +
                    |         "mean": 45.00,      +
                    |         "type": "number",   +
                    |         "count": 1,         +
                    |         "stddev": 0.00,     +
                    |         "variance": 0.00,   +
                    |         "sum_sq_diff": 0.00 +
                    |     }                       +
                    | }
-[ RECORD 3 ]-------+-----------------------------
unit_type           | enterprise
distinct_unit_count | 1
invalid_codes       | 
stats_summary       | {                           +
                    | }

SELECT year
     , unit_type
     , count
     , births
     , deaths
     , primary_activity_category_change_count
     , secondary_activity_category_change_count
     , sector_change_count
     , legal_form_change_count
     , physical_region_change_count
     , physical_country_change_count
     , jsonb_pretty(stats_summary) AS stats_summary
FROM public.statistical_history
WHERE type = 'year'
ORDER BY year,unit_type;
-[ RECORD 1 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | establishment
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 2 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | legal_unit
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 3 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | enterprise
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 4 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 5 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | legal_unit
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 6 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | enterprise
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 7 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 8 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | legal_unit
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 9 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | enterprise
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 10 ]---------------------------+----------------------------
year                                     | 2013
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 11 ]---------------------------+----------------------------
year                                     | 2014
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 12 ]---------------------------+----------------------------
year                                     | 2015
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 13 ]---------------------------+----------------------------
year                                     | 2016
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 14 ]---------------------------+----------------------------
year                                     | 2017
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 15 ]---------------------------+----------------------------
year                                     | 2018
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 16 ]---------------------------+----------------------------
year                                     | 2019
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 17 ]---------------------------+----------------------------
year                                     | 2020
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 18 ]---------------------------+----------------------------
year                                     | 2021
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 19 ]---------------------------+----------------------------
year                                     | 2022
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 20 ]---------------------------+----------------------------
year                                     | 2023
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 21 ]---------------------------+----------------------------
year                                     | 2024
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }

SELECT year, month
     , unit_type
     , count
     , births
     , deaths
     , primary_activity_category_change_count
     , secondary_activity_category_change_count
     , sector_change_count
     , legal_form_change_count
     , physical_region_change_count
     , physical_country_change_count
     , jsonb_pretty(stats_summary) AS stats_summary
FROM public.statistical_history
WHERE type = 'year-month' AND year = 2019
ORDER BY year,month,unit_type;
-[ RECORD 1 ]----------------------------+----------------------------
year                                     | 2019
month                                    | 1
unit_type                                | establishment
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }

SELECT year
     , unit_type
     , primary_activity_category_path
     , secondary_activity_category_path
     , sector_path
     , physical_region_path
     , count
     , births
     , deaths
     , primary_activity_category_change_count
     , secondary_activity_category_change_count
     , sector_change_count
     , legal_form_change_count
     , physical_region_change_count
     , physical_country_change_count
     , jsonb_pretty(stats_summary) AS stats_summary
FROM public.statistical_history_facet
WHERE type = 'year'
ORDER BY year,unit_type;
-[ RECORD 1 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 2 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | legal_unit
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 3 ]----------------------------+----------------------------
year                                     | 2010
unit_type                                | enterprise
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 1
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 4 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 5 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | legal_unit
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 6 ]----------------------------+----------------------------
year                                     | 2011
unit_type                                | enterprise
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 7 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 8 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | legal_unit
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 9 ]----------------------------+----------------------------
year                                     | 2012
unit_type                                | enterprise
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | innl.a_ikke_fin.2100
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         | }
-[ RECORD 10 ]---------------------------+----------------------------
year                                     | 2013
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 11 ]---------------------------+----------------------------
year                                     | 2014
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 12 ]---------------------------+----------------------------
year                                     | 2015
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 13 ]---------------------------+----------------------------
year                                     | 2016
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 14 ]---------------------------+----------------------------
year                                     | 2017
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 15 ]---------------------------+----------------------------
year                                     | 2018
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 16 ]---------------------------+----------------------------
year                                     | 2019
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 17 ]---------------------------+----------------------------
year                                     | 2020
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 18 ]---------------------------+----------------------------
year                                     | 2021
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 19 ]---------------------------+----------------------------
year                                     | 2022
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 20 ]---------------------------+----------------------------
year                                     | 2023
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }
-[ RECORD 21 ]---------------------------+----------------------------
year                                     | 2024
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }

SELECT year, month
     , unit_type
     , primary_activity_category_path
     , secondary_activity_category_path
     , sector_path
     , physical_region_path
     , count
     , births
     , deaths
     , primary_activity_category_change_count
     , secondary_activity_category_change_count
     , sector_change_count
     , legal_form_change_count
     , physical_region_change_count
     , physical_country_change_count
     , jsonb_pretty(stats_summary) AS stats_summary
FROM public.statistical_history_facet
WHERE type = 'year-month' AND year = 2019
ORDER BY year,month,unit_type;
-[ RECORD 1 ]----------------------------+----------------------------
year                                     | 2019
month                                    | 1
unit_type                                | establishment
primary_activity_category_path           | H.49.4.1.0
secondary_activity_category_path         | 
sector_path                              | 
physical_region_path                     | 11.21
count                                    | 1
births                                   | 0
deaths                                   | 0
primary_activity_category_change_count   | 0
secondary_activity_category_change_count | 0
sector_change_count                      | 0
legal_form_change_count                  | 0
physical_region_change_count             | 0
physical_country_change_count            | 0
stats_summary                            | {                          +
                                         |     "turnover": {          +
                                         |         "max": 1500000,    +
                                         |         "min": 1500000,    +
                                         |         "sum": 1500000,    +
                                         |         "mean": 1500000.00,+
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     },                     +
                                         |     "employees": {         +
                                         |         "max": 1,          +
                                         |         "min": 1,          +
                                         |         "sum": 1,          +
                                         |         "mean": 1.00,      +
                                         |         "type": "number",  +
                                         |         "count": 1,        +
                                         |         "stddev": 0.00,    +
                                         |         "variance": 0.00,  +
                                         |         "sum_sq_diff": 0.00+
                                         |     }                      +
                                         | }

\x
\a
SELECT jsonb_pretty(
     public.remove_ephemeral_data_from_hierarchy(
     public.statistical_history_drilldown(
          'enterprise'::public.statistical_unit_type,
          'year'::public.statistical_history_type,
          NULL::INTEGER,
          NULL::public.ltree,
          NULL::public.ltree,
          NULL::public.ltree,
          NULL::INTEGER,
          NULL::INTEGER
     ))) AS statistical_history_drilldown;
statistical_history_drilldown
{
    "stats": [
        {
            "year": 2010,
            "count": 1,
            "month": null,
            "births": 1,
            "deaths": 0,
            "stats_summary": {
            },
            "sector_change_count": 0,
            "legal_form_change_count": 0,
            "physical_region_change_count": 0,
            "physical_country_change_count": 0,
            "primary_activity_category_change_count": 0
        },
        {
            "year": 2011,
            "count": 1,
            "month": null,
            "births": 0,
            "deaths": 0,
            "stats_summary": {
            },
            "sector_change_count": 0,
            "legal_form_change_count": 0,
            "physical_region_change_count": 0,
            "physical_country_change_count": 0,
            "primary_activity_category_change_count": 0
        },
        {
            "year": 2012,
            "count": 1,
            "month": null,
            "births": 0,
            "deaths": 0,
            "stats_summary": {
            },
            "sector_change_count": 0,
            "legal_form_change_count": 0,
            "physical_region_change_count": 0,
            "physical_country_change_count": 0,
            "primary_activity_category_change_count": 0
        }
    ],
    "filter": {
        "type": "year",
        "year": null,
        "unit_type": "enterprise",
        "region_path": null,
        "sector_path": null,
        "activity_category_path": null
    },
    "available": {
        "region": [
            {
                "code": "11",
                "name": "Rogaland",
                "path": "11",
                "count": 3,
                "label": "11",
                "has_children": true,
                "stats_summary": {
                }
            }
        ],
        "sector": [
            {
                "code": null,
                "name": "Innenlandske sektorer",
                "path": "innl",
                "count": 3,
                "label": "innl",
                "has_children": true,
                "stats_summary": {
                }
            }
        ],
        "country": [
            {
                "name": "Norway",
                "count": 3,
                "iso_2": "NO",
                "has_children": false,
                "stats_summary": {
                }
            }
        ],
        "legal_form": [
            {
                "code": "ENK",
                "name": "Enkeltpersonforetak",
                "count": 3,
                "has_children": false,
                "stats_summary": {
                }
            }
        ],
        "activity_category": [
            {
                "code": "",
                "name": "Transport og lagring",
                "path": "H",
                "count": 3,
                "label": "H",
                "has_children": true,
                "stats_summary": {
                }
            }
        ]
    },
    "unit_type": "enterprise",
    "breadcrumb": {
        "region": null,
        "sector": null,
        "country": null,
        "legal_form": null,
        "activity_category": null
    }
}
(1 row)
SELECT jsonb_pretty(
     public.remove_ephemeral_data_from_hierarchy(
     public.statistical_history_drilldown(
          'enterprise'::public.statistical_unit_type,
          'year'::public.statistical_history_type,
          2020,
          NULL::public.ltree,
          NULL::public.ltree,
          NULL::public.ltree,
          NULL::INTEGER,
          NULL::INTEGER
     ))) AS statistical_history_drilldown;
statistical_history_drilldown
{
    "stats": null,
    "filter": {
        "type": "year",
        "year": 2020,
        "unit_type": "enterprise",
        "region_path": null,
        "sector_path": null,
        "activity_category_path": null
    },
    "available": {
        "region": null,
        "sector": null,
        "country": null,
        "legal_form": null,
        "activity_category": null
    },
    "unit_type": "enterprise",
    "breadcrumb": {
        "region": null,
        "sector": null,
        "country": null,
        "legal_form": null,
        "activity_category": null
    }
}
(1 row)
\echo "Test statistical_unit_hierarchy"
"Test statistical_unit_hierarchy"
WITH selected_enterprise AS (
     SELECT unit_id FROM public.statistical_unit
     WHERE external_idents ->> 'tax_ident' = '921838309'
       AND unit_type = 'enterprise'
     LIMIT 1
)
SELECT jsonb_pretty(
          public.remove_ephemeral_data_from_hierarchy(
               public.statistical_unit_hierarchy('enterprise',(SELECT unit_id FROM selected_enterprise))
          )
     ) AS statistical_unit_hierarchy;
statistical_unit_hierarchy
{
}
(1 row)
WITH selected_legal_unit AS (
     SELECT unit_id FROM public.statistical_unit
     WHERE external_idents ->> 'tax_ident' = '921835809'
        AND unit_type = 'legal_unit'
    LIMIT 1
)
SELECT jsonb_pretty(
          public.remove_ephemeral_data_from_hierarchy(
               public.statistical_unit_hierarchy('legal_unit',(SELECT unit_id FROM selected_legal_unit))
          )
     ) AS statistical_unit_hierarchy;
statistical_unit_hierarchy
{
    "enterprise": {
        "notes": null,
        "active": true,
        "legal_unit": [
            {
                "name": "KRAN & SPESIALLØFT AS",
                "notes": null,
                "active": true,
                "sector": {
                    "code": "2100",
                    "name": "Private aksjeselskaper mv.",
                    "path": "innl.a_ikke_fin.2100",
                    "label": "innla_ikke_fin2100",
                    "active": true,
                    "custom": true,
                    "description": "### Notes:\nSektoren omfatter markedsproduserende ikke-finansielle selskaper med begrenset økonomisk ansvar hvor private nasjonale aktører eller utlendinger direkte eller indirekte eier mer enn 50 prosent av innbetalt eierkapital."
                },
                "activity": [
                    {
                        "type": "primary",
                        "valid_to": "infinity",
                        "valid_from": "2013-01-01",
                        "valid_after": "2012-12-31",
                        "activity_category": {
                            "code": "49.410",
                            "name": "Godstransport på vei",
                            "path": "H.49.4.1.0",
                            "label": "H49410",
                            "level": 5,
                            "active": true,
                            "custom": true,
                            "description": "### Shortname: Godstransport på vei\n\n### Notes:\nInkluderer også: Omfatter også utleie av lastebiler med sjåfør og godstransport med kjøretøyer som trekkes av dyr eller mennesker Ekskluderer: Transport av tømmer i skogen som ledd i skogsdrift grupperes under: 02.40 Tjenester tilknyttet skogbruk. Lastebiltransport med distribusjon av vann grupperes under: 36.00 Uttak fra kilde, rensing og distribusjon av vann. Avfallstransport som ledd i renovasjonsvirksomhet grupperes under hhv.: 38.11 Innsamling av ikke-farlig avfall og: 38.12 Innsamling av farlig avfall. Drift av godsterminaler grupperes under: 52.211 Drift av gods- og transportsentraler. Pakking for transport grupperes under: 52.291 Spedisjon. Post- og kurervirksomhet grupperes under hhv.: 53.10 Landsdekkende posttjenester og: 53.20 Andre post- og budtjenester",
                            "activity_category_standard": {
                                "code": "nace_v2.1",
                                "name": "NACE 2.1",
                                "obsolete": false,
                                "description": "NACE Version 2 Revision 1"
                            }
                        }
                    }
                ],
                "location": [
                    {
                        "type": "physical",
                        "region": {
                            "code": "1121",
                            "name": "Time",
                            "path": "11.21",
                            "label": "1121",
                            "level": 2
                        },
                        "country": {
                            "name": "Norway",
                            "iso_2": "NO",
                            "iso_3": "NOR",
                            "active": true,
                            "custom": false,
                            "iso_num": "578"
                        },
                        "latitude": null,
                        "valid_to": "infinity",
                        "longitude": null,
                        "valid_from": "2013-01-01",
                        "postal_code": "4347",
                        "valid_after": "2012-12-31",
                        "postal_place": "LYE",
                        "address_part1": "Vestlyvegen 219",
                        "address_part2": null,
                        "address_part3": null
                    }
                ],
                "valid_to": "infinity",
                "birth_date": "2013-01-01",
                "death_date": null,
                "legal_form": {
                    "code": "AS",
                    "name": "Aksjeselskap",
                    "active": true,
                    "custom": true
                },
                "reorg_date": null,
                "short_name": null,
                "valid_from": "2013-01-01",
                "valid_after": "2012-12-31",
                "web_address": null,
                "edit_comment": "Batch import",
                "telephone_no": null,
                "email_address": null,
                "establishment": [
                    {
                        "name": "KRAN & SPESIALLØFT AS",
                        "notes": null,
                        "active": true,
                        "activity": [
                            {
                                "type": "primary",
                                "valid_to": "infinity",
                                "valid_from": "2010-01-01",
                                "valid_after": "2009-12-31",
                                "activity_category": {
                                    "code": "49.410",
                                    "name": "Godstransport på vei",
                                    "path": "H.49.4.1.0",
                                    "label": "H49410",
                                    "level": 5,
                                    "active": true,
                                    "custom": true,
                                    "description": "### Shortname: Godstransport på vei\n\n### Notes:\nInkluderer også: Omfatter også utleie av lastebiler med sjåfør og godstransport med kjøretøyer som trekkes av dyr eller mennesker Ekskluderer: Transport av tømmer i skogen som ledd i skogsdrift grupperes under: 02.40 Tjenester tilknyttet skogbruk. Lastebiltransport med distribusjon av vann grupperes under: 36.00 Uttak fra kilde, rensing og distribusjon av vann. Avfallstransport som ledd i renovasjonsvirksomhet grupperes under hhv.: 38.11 Innsamling av ikke-farlig avfall og: 38.12 Innsamling av farlig avfall. Drift av godsterminaler grupperes under: 52.211 Drift av gods- og transportsentraler. Pakking for transport grupperes under: 52.291 Spedisjon. Post- og kurervirksomhet grupperes under hhv.: 53.10 Landsdekkende posttjenester og: 53.20 Andre post- og budtjenester",
                                    "activity_category_standard": {
                                        "code": "nace_v2.1",
                                        "name": "NACE 2.1",
                                        "obsolete": false,
                                        "description": "NACE Version 2 Revision 1"
                                    }
                                }
                            }
                        ],
                        "location": [
                            {
                                "type": "physical",
                                "region": {
                                    "code": "1121",
                                    "name": "Time",
                                    "path": "11.21",
                                    "label": "1121",
                                    "level": 2
                                },
                                "country": {
                                    "name": "Norway",
                                    "iso_2": "NO",
                                    "iso_3": "NOR",
                                    "active": true,
                                    "custom": false,
                                    "iso_num": "578"
                                },
                                "latitude": null,
                                "valid_to": "infinity",
                                "longitude": null,
                                "valid_from": "2010-01-01",
                                "postal_code": "4347",
                                "valid_after": "2009-12-31",
                                "postal_place": "LYE",
                                "address_part1": "Vestlyvegen 219",
                                "address_part2": null,
                                "address_part3": null
                            }
                        ],
                        "valid_to": "infinity",
                        "birth_date": "2010-01-01",
                        "death_date": null,
                        "reorg_date": null,
                        "short_name": null,
                        "valid_from": "2013-01-01",
                        "valid_after": "2012-12-31",
                        "web_address": null,
                        "edit_comment": "Batch import",
                        "telephone_no": null,
                        "email_address": null,
                        "invalid_codes": null,
                        "stat_for_unit": [
                            {
                                "valid_to": "infinity",
                                "employees": 45,
                                "valid_from": "2020-01-01",
                                "valid_after": "2019-12-31",
                                "stat_definition": {
                                    "code": "employees",
                                    "name": "Number of people employed",
                                    "type": "int",
                                    "archived": false,
                                    "priority": 2,
                                    "frequency": "yearly",
                                    "description": "The number of people receiving an official salary with government reporting."
                                }
                            },
                            {
                                "turnover": 70000000,
                                "valid_to": "infinity",
                                "valid_from": "2020-01-01",
                                "valid_after": "2019-12-31",
                                "stat_definition": {
                                    "code": "turnover",
                                    "name": "Turnover",
                                    "type": "int",
                                    "archived": false,
                                    "priority": 3,
                                    "frequency": "yearly",
                                    "description": "The amount (EUR)"
                                }
                            }
                        ],
                        "external_ident": {
                            "tax_ident": "895406732"
                        },
                        "free_econ_zone": null,
                        "parent_org_link": null,
                        "reorg_references": null,
                        "primary_for_legal_unit": true
                    }
                ],
                "invalid_codes": null,
                "external_ident": {
                    "tax_ident": "921835809"
                },
                "free_econ_zone": null,
                "parent_org_link": null,
                "reorg_references": null,
                "primary_for_enterprise": true
            }
        ],
        "short_name": null,
        "edit_comment": "Batch import"
    }
}
(1 row)
WITH selected_establishment AS (
     SELECT unit_id FROM public.statistical_unit
     WHERE external_idents ->> 'tax_ident' = '895406732'
     LIMIT 1
)
SELECT jsonb_pretty(
          public.remove_ephemeral_data_from_hierarchy(
               public.statistical_unit_hierarchy('establishment',(SELECT unit_id FROM selected_establishment))
          )
     ) AS statistical_unit_hierarchy;
statistical_unit_hierarchy
{
    "enterprise": {
        "notes": null,
        "active": true,
        "legal_unit": [
            {
                "name": "KRAN & SPESIALLØFT AS",
                "notes": null,
                "active": true,
                "sector": {
                    "code": "2100",
                    "name": "Private aksjeselskaper mv.",
                    "path": "innl.a_ikke_fin.2100",
                    "label": "innla_ikke_fin2100",
                    "active": true,
                    "custom": true,
                    "description": "### Notes:\nSektoren omfatter markedsproduserende ikke-finansielle selskaper med begrenset økonomisk ansvar hvor private nasjonale aktører eller utlendinger direkte eller indirekte eier mer enn 50 prosent av innbetalt eierkapital."
                },
                "activity": [
                    {
                        "type": "primary",
                        "valid_to": "infinity",
                        "valid_from": "2013-01-01",
                        "valid_after": "2012-12-31",
                        "activity_category": {
                            "code": "49.410",
                            "name": "Godstransport på vei",
                            "path": "H.49.4.1.0",
                            "label": "H49410",
                            "level": 5,
                            "active": true,
                            "custom": true,
                            "description": "### Shortname: Godstransport på vei\n\n### Notes:\nInkluderer også: Omfatter også utleie av lastebiler med sjåfør og godstransport med kjøretøyer som trekkes av dyr eller mennesker Ekskluderer: Transport av tømmer i skogen som ledd i skogsdrift grupperes under: 02.40 Tjenester tilknyttet skogbruk. Lastebiltransport med distribusjon av vann grupperes under: 36.00 Uttak fra kilde, rensing og distribusjon av vann. Avfallstransport som ledd i renovasjonsvirksomhet grupperes under hhv.: 38.11 Innsamling av ikke-farlig avfall og: 38.12 Innsamling av farlig avfall. Drift av godsterminaler grupperes under: 52.211 Drift av gods- og transportsentraler. Pakking for transport grupperes under: 52.291 Spedisjon. Post- og kurervirksomhet grupperes under hhv.: 53.10 Landsdekkende posttjenester og: 53.20 Andre post- og budtjenester",
                            "activity_category_standard": {
                                "code": "nace_v2.1",
                                "name": "NACE 2.1",
                                "obsolete": false,
                                "description": "NACE Version 2 Revision 1"
                            }
                        }
                    }
                ],
                "location": [
                    {
                        "type": "physical",
                        "region": {
                            "code": "1121",
                            "name": "Time",
                            "path": "11.21",
                            "label": "1121",
                            "level": 2
                        },
                        "country": {
                            "name": "Norway",
                            "iso_2": "NO",
                            "iso_3": "NOR",
                            "active": true,
                            "custom": false,
                            "iso_num": "578"
                        },
                        "latitude": null,
                        "valid_to": "infinity",
                        "longitude": null,
                        "valid_from": "2013-01-01",
                        "postal_code": "4347",
                        "valid_after": "2012-12-31",
                        "postal_place": "LYE",
                        "address_part1": "Vestlyvegen 219",
                        "address_part2": null,
                        "address_part3": null
                    }
                ],
                "valid_to": "infinity",
                "birth_date": "2013-01-01",
                "death_date": null,
                "legal_form": {
                    "code": "AS",
                    "name": "Aksjeselskap",
                    "active": true,
                    "custom": true
                },
                "reorg_date": null,
                "short_name": null,
                "valid_from": "2013-01-01",
                "valid_after": "2012-12-31",
                "web_address": null,
                "edit_comment": "Batch import",
                "telephone_no": null,
                "email_address": null,
                "establishment": [
                    {
                        "name": "KRAN & SPESIALLØFT AS",
                        "notes": null,
                        "active": true,
                        "activity": [
                            {
                                "type": "primary",
                                "valid_to": "infinity",
                                "valid_from": "2010-01-01",
                                "valid_after": "2009-12-31",
                                "activity_category": {
                                    "code": "49.410",
                                    "name": "Godstransport på vei",
                                    "path": "H.49.4.1.0",
                                    "label": "H49410",
                                    "level": 5,
                                    "active": true,
                                    "custom": true,
                                    "description": "### Shortname: Godstransport på vei\n\n### Notes:\nInkluderer også: Omfatter også utleie av lastebiler med sjåfør og godstransport med kjøretøyer som trekkes av dyr eller mennesker Ekskluderer: Transport av tømmer i skogen som ledd i skogsdrift grupperes under: 02.40 Tjenester tilknyttet skogbruk. Lastebiltransport med distribusjon av vann grupperes under: 36.00 Uttak fra kilde, rensing og distribusjon av vann. Avfallstransport som ledd i renovasjonsvirksomhet grupperes under hhv.: 38.11 Innsamling av ikke-farlig avfall og: 38.12 Innsamling av farlig avfall. Drift av godsterminaler grupperes under: 52.211 Drift av gods- og transportsentraler. Pakking for transport grupperes under: 52.291 Spedisjon. Post- og kurervirksomhet grupperes under hhv.: 53.10 Landsdekkende posttjenester og: 53.20 Andre post- og budtjenester",
                                    "activity_category_standard": {
                                        "code": "nace_v2.1",
                                        "name": "NACE 2.1",
                                        "obsolete": false,
                                        "description": "NACE Version 2 Revision 1"
                                    }
                                }
                            }
                        ],
                        "location": [
                            {
                                "type": "physical",
                                "region": {
                                    "code": "1121",
                                    "name": "Time",
                                    "path": "11.21",
                                    "label": "1121",
                                    "level": 2
                                },
                                "country": {
                                    "name": "Norway",
                                    "iso_2": "NO",
                                    "iso_3": "NOR",
                                    "active": true,
                                    "custom": false,
                                    "iso_num": "578"
                                },
                                "latitude": null,
                                "valid_to": "infinity",
                                "longitude": null,
                                "valid_from": "2010-01-01",
                                "postal_code": "4347",
                                "valid_after": "2009-12-31",
                                "postal_place": "LYE",
                                "address_part1": "Vestlyvegen 219",
                                "address_part2": null,
                                "address_part3": null
                            }
                        ],
                        "valid_to": "infinity",
                        "birth_date": "2010-01-01",
                        "death_date": null,
                        "reorg_date": null,
                        "short_name": null,
                        "valid_from": "2013-01-01",
                        "valid_after": "2012-12-31",
                        "web_address": null,
                        "edit_comment": "Batch import",
                        "telephone_no": null,
                        "email_address": null,
                        "invalid_codes": null,
                        "stat_for_unit": [
                            {
                                "valid_to": "infinity",
                                "employees": 45,
                                "valid_from": "2020-01-01",
                                "valid_after": "2019-12-31",
                                "stat_definition": {
                                    "code": "employees",
                                    "name": "Number of people employed",
                                    "type": "int",
                                    "archived": false,
                                    "priority": 2,
                                    "frequency": "yearly",
                                    "description": "The number of people receiving an official salary with government reporting."
                                }
                            },
                            {
                                "turnover": 70000000,
                                "valid_to": "infinity",
                                "valid_from": "2020-01-01",
                                "valid_after": "2019-12-31",
                                "stat_definition": {
                                    "code": "turnover",
                                    "name": "Turnover",
                                    "type": "int",
                                    "archived": false,
                                    "priority": 3,
                                    "frequency": "yearly",
                                    "description": "The amount (EUR)"
                                }
                            }
                        ],
                        "external_ident": {
                            "tax_ident": "895406732"
                        },
                        "free_econ_zone": null,
                        "parent_org_link": null,
                        "reorg_references": null,
                        "primary_for_legal_unit": true
                    }
                ],
                "invalid_codes": null,
                "external_ident": {
                    "tax_ident": "921835809"
                },
                "free_econ_zone": null,
                "parent_org_link": null,
                "reorg_references": null,
                "primary_for_enterprise": true
            }
        ],
        "short_name": null,
        "edit_comment": "Batch import"
    }
}
(1 row)
ROLLBACK;
