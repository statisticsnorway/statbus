                                                                                    QUERY PLAN                                                                                     
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hash Left Join  (cost=180.14..191.03 rows=3 width=7616)
   Hash Cond: ((NULL::integer) = eia3.unit_id)
   CTE external_idents_agg
     ->  GroupAggregate  (cost=41.09..41.18 rows=4 width=40)
           Group Key: ('establishment'::statistical_unit_type), ei.establishment_id
           ->  Sort  (cost=41.09..41.10 rows=4 width=400)
                 Sort Key: ('establishment'::statistical_unit_type), ei.establishment_id
                 ->  Append  (cost=0.14..41.05 rows=4 width=400)
                       ->  Nested Loop  (cost=0.14..10.26 rows=1 width=400)
                             ->  Seq Scan on external_ident ei  (cost=0.00..2.00 rows=1 width=126)
                                   Filter: (establishment_id IS NOT NULL)
                             ->  Index Scan using external_ident_type_pkey on external_ident_type eit  (cost=0.14..8.16 rows=1 width=278)
                                   Index Cond: (id = ei.type_id)
                       ->  Nested Loop  (cost=0.14..10.26 rows=1 width=400)
                             ->  Seq Scan on external_ident ei_1  (cost=0.00..2.00 rows=1 width=126)
                                   Filter: (legal_unit_id IS NOT NULL)
                             ->  Index Scan using external_ident_type_pkey on external_ident_type eit_1  (cost=0.14..8.16 rows=1 width=278)
                                   Index Cond: (id = ei_1.type_id)
                       ->  Nested Loop  (cost=0.14..10.26 rows=1 width=400)
                             ->  Seq Scan on external_ident ei_2  (cost=0.00..2.00 rows=1 width=126)
                                   Filter: (enterprise_id IS NOT NULL)
                             ->  Index Scan using external_ident_type_pkey on external_ident_type eit_2  (cost=0.14..8.16 rows=1 width=278)
                                   Index Cond: (id = ei_2.type_id)
                       ->  Nested Loop  (cost=0.14..10.26 rows=1 width=400)
                             ->  Seq Scan on external_ident ei_3  (cost=0.00..2.00 rows=1 width=126)
                                   Filter: (enterprise_group_id IS NOT NULL)
                             ->  Index Scan using external_ident_type_pkey on external_ident_type eit_3  (cost=0.14..8.16 rows=1 width=278)
                                   Index Cond: (id = ei_3.type_id)
   ->  Hash Left Join  (cost=138.86..149.71 rows=3 width=7640)
         Hash Cond: ((NULL::integer) = eia2.unit_id)
         ->  Merge Right Join  (cost=138.76..149.58 rows=3 width=7612)
               Merge Cond: ((eia1.unit_type = timeline_establishment.unit_type) AND (eia1.unit_id = timeline_establishment.unit_id))
               ->  CTE Scan on external_idents_agg eia1  (cost=0.00..0.08 rows=4 width=40)
               ->  Materialize  (cost=138.76..149.46 rows=3 width=7580)
                     ->  Merge Left Join  (cost=138.76..149.45 rows=3 width=7580)
                           Merge Cond: ((timeline_establishment.unit_type = ('establishment'::statistical_unit_type)) AND (timeline_establishment.unit_id = tfu.establishment_id))
                           ->  Sort  (cost=16.43..16.44 rows=3 width=7548)
                                 Sort Key: timeline_establishment.unit_type, timeline_establishment.unit_id
                                 ->  Append  (cost=0.00..16.41 rows=3 width=7548)
                                       ->  Seq Scan on timeline_establishment  (cost=0.00..3.25 rows=1 width=7548)
                                       ->  Index Scan using timeline_legal_unit_pkey on timeline_legal_unit  (cost=0.12..8.14 rows=1 width=7548)
                                       ->  Seq Scan on timeline_enterprise  (cost=0.00..5.00 rows=1 width=7548)
                           ->  GroupAggregate  (cost=122.33..129.99 rows=200 width=40)
                                 Group Key: ('establishment'::statistical_unit_type), tfu.establishment_id
                                 ->  Sort  (cost=122.33..123.62 rows=516 width=40)
                                       Sort Key: ('establishment'::statistical_unit_type), tfu.establishment_id, t.path
                                       ->  Append  (cost=12.47..99.08 rows=516 width=40)
                                             ->  Hash Join  (cost=12.47..24.12 rows=129 width=40)
                                                   Hash Cond: (tfu.tag_id = t.id)
                                                   ->  Seq Scan on tag_for_unit tfu  (cost=0.00..11.30 rows=129 width=8)
                                                         Filter: (establishment_id IS NOT NULL)
                                                   ->  Hash  (cost=11.10..11.10 rows=110 width=36)
                                                         ->  Seq Scan on tag t  (cost=0.00..11.10 rows=110 width=36)
                                             ->  Hash Join  (cost=12.47..24.12 rows=129 width=40)
                                                   Hash Cond: (tfu_1.tag_id = t_1.id)
                                                   ->  Seq Scan on tag_for_unit tfu_1  (cost=0.00..11.30 rows=129 width=8)
                                                         Filter: (legal_unit_id IS NOT NULL)
                                                   ->  Hash  (cost=11.10..11.10 rows=110 width=36)
                                                         ->  Seq Scan on tag t_1  (cost=0.00..11.10 rows=110 width=36)
                                             ->  Hash Join  (cost=12.47..24.12 rows=129 width=40)
                                                   Hash Cond: (tfu_2.tag_id = t_2.id)
                                                   ->  Seq Scan on tag_for_unit tfu_2  (cost=0.00..11.30 rows=129 width=8)
                                                         Filter: (enterprise_id IS NOT NULL)
                                                   ->  Hash  (cost=11.10..11.10 rows=110 width=36)
                                                         ->  Seq Scan on tag t_2  (cost=0.00..11.10 rows=110 width=36)
                                             ->  Hash Join  (cost=12.47..24.12 rows=129 width=40)
                                                   Hash Cond: (tfu_3.tag_id = t_3.id)
                                                   ->  Seq Scan on tag_for_unit tfu_3  (cost=0.00..11.30 rows=129 width=8)
                                                         Filter: (enterprise_group_id IS NOT NULL)
                                                   ->  Hash  (cost=11.10..11.10 rows=110 width=36)
                                                         ->  Seq Scan on tag t_3  (cost=0.00..11.10 rows=110 width=36)
         ->  Hash  (cost=0.09..0.09 rows=1 width=36)
               ->  CTE Scan on external_idents_agg eia2  (cost=0.00..0.09 rows=1 width=36)
                     Filter: (unit_type = 'establishment'::statistical_unit_type)
   ->  Hash  (cost=0.09..0.09 rows=1 width=36)
         ->  CTE Scan on external_idents_agg eia3  (cost=0.00..0.09 rows=1 width=36)
               Filter: (unit_type = 'legal_unit'::statistical_unit_type)
(77 rows)

