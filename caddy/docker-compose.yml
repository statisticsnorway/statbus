# Caddy web server configuration
services:
  caddy:
    container_name: ${COMPOSE_INSTANCE_NAME:?COMPOSE_INSTANCE_NAME must be set in the generated .env}-caddy
    image: caddy:2.7-alpine
    restart: unless-stopped
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - ./config:/config
      - caddy_logs:/var/log/caddy
    environment:
      APP_BIND_ADDRESS: ${APP_BIND_ADDRESS:-app:3000}
      POSTGREST_BIND_ADDRESS: ${POSTGREST_BIND_ADDRESS:-rest:3000}
      SITE_ADDRESS: ${SITE_ADDRESS:-localhost}
      DEPLOYMENT_SLOT_CODE: ${DEPLOYMENT_SLOT_CODE:?DEPLOYMENT_SLOT_CODE must be set in the generated .env}
      CADDY_DEPLOYMENT_MODE: ${CADDY_DEPLOYMENT_MODE:-development}
      MAINTENANCE_FILE_PATH: ${MAINTENANCE_FILE_PATH:-/maintenance}
      MAINTENANCE_ROOT_PATH: ${MAINTENANCE_ROOT_PATH:-/app/public}
      CADDY_LOG_PATH: ${CADDY_LOG_PATH:-/var/log/caddy/access.log}
    depends_on:
      rest:
        condition: service_started
    profiles:
      - "all"
      - "all_except_app"

volumes:
  caddy_data:
  caddy_logs:
