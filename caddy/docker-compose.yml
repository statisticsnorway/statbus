# Caddy web server configuration
services:
  caddy:
    container_name: ${COMPOSE_INSTANCE_NAME:-statbus}-caddy
    image: caddy:2.7-alpine
    restart: unless-stopped
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    environment:
      # These variables will be used in the Caddyfile
      APP_HOST: ${APP_HOST:-app}
      APP_PORT: ${APP_PORT:-3000}
      REST_HOST: rest
      REST_PORT: 3000
      SITE_ADDRESS: ${SITE_ADDRESS:-localhost}
      CADDY_ENVIRONMENT: ${CADDY_ENVIRONMENT:-development}
      CADDY_AUTO_HTTPS: ${CADDY_AUTO_HTTPS:-off}
      DEPLOYMENT_SLOT_CODE: ${DEPLOYMENT_SLOT_CODE:?DEPLOYMENT_SLOT_CODE must be set in the generated .env}
      MAINTENANCE_FILE_PATH: ${MAINTENANCE_FILE_PATH:-/maintenance}
      MAINTENANCE_ROOT_PATH: ${MAINTENANCE_ROOT_PATH:-/app/public}
      CADDY_LOG_PATH: ${CADDY_LOG_PATH:-/var/log/caddy/access.log}
    depends_on:
      rest:
        condition: service_started
    profiles:
      - "all"
      - "all_except_app"

volumes:
  caddy_data:
  caddy_config:
  caddy_logs:
